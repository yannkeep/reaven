<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1">
<meta name="theme-color" content="#06060b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>COGWAR</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Fira+Code:wght@300;400;500&family=Silkscreen&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root,[data-theme="dark"]{--b0:#06060b;--b1:#0a0a12;--b2:#10101c;--b3:#1a1a2e;--bc:#121220;--g1:#7fcea0;--g2:#5ab882;--g3:#a8e6c3;--gd:#1a3a28;--l1:#c4a8e6;--l2:#a87fd4;--l3:#d4b8f0;--ld:#2a1a40;--pk:#e6a8c4;--wm:#f0d4b8;--rd:#e64a4a;--am:#f0a830;--t1:#e8e6f0;--t2:#a8a6b4;--t3:#58566a;--bd:#222238;--gg:0 0 12px #7fcea030;--gl:0 0 12px #c4a8e630;--sc:repeating-linear-gradient(0deg,transparent,transparent 2px,#0001 2px,#0001 4px);--ff:'VT323',monospace;--fm:'Fira Code',monospace;--fp:'Silkscreen',monospace;--fs:'Share Tech Mono',monospace;--r:4px;--tr:.2s ease}
[data-theme="eighties"]{--b0:#12042a;--b1:#180838;--b2:#220e48;--b3:#301860;--bc:#1c0a40;--g1:#00ffaa;--g2:#00cc88;--g3:#66ffcc;--gd:#082a1e;--l1:#ff6ef9;--l2:#cc44cc;--l3:#ff99ff;--ld:#3a0840;--pk:#ff2d95;--wm:#ffaa00;--rd:#ff0055;--am:#ff6600;--t1:#f0e6ff;--t2:#b8a0d8;--t3:#7050a0;--bd:#3a1a60;--gg:0 0 16px #00ffaa40;--gl:0 0 16px #ff6ef940;--sc:repeating-linear-gradient(0deg,transparent,transparent 1px,#ff6ef904 1px,#ff6ef904 2px)}
[data-theme="disco"]{--b0:#08000a;--b1:#100014;--b2:#1c0020;--b3:#2a0034;--bc:#180020;--g1:#ffd700;--g2:#ccaa00;--g3:#ffe44d;--gd:#2a2400;--l1:#ff4da6;--l2:#e6007a;--l3:#ff80c0;--ld:#3a0020;--pk:#ff1493;--wm:#ff8c00;--rd:#ff0040;--am:#ff6633;--t1:#ffe6f4;--t2:#c890b0;--t3:#885070;--bd:#3a0830;--gg:0 0 16px #ffd70040;--gl:0 0 16px #ff4da640;--sc:none}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;scrollbar-width:thin;scrollbar-color:var(--gd) var(--b1);-webkit-tap-highlight-color:transparent}
body{font-family:var(--fm);font-size:13px;line-height:1.6;color:var(--t1);background:var(--b0);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body::after{content:'';position:fixed;inset:0;background:var(--sc);pointer-events:none;z-index:9999;opacity:.3}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--b0)}::-webkit-scrollbar-thumb{background:var(--gd);border-radius:2px}
::selection{background:var(--l2);color:var(--b0)}
input,textarea,select,button{font-family:inherit}
#boot{position:fixed;bottom:0;left:0;right:0;z-index:10000;background:var(--b0);border-top:1px solid var(--g2);padding:8px 12px;display:flex;align-items:center;gap:8px;font-family:var(--ff);font-size:16px;color:var(--g1);transition:transform .5s,opacity .5s}
#boot.done{transform:translateY(100%);opacity:0;pointer-events:none}
#boot-l{flex:1;white-space:nowrap;overflow:hidden}
.cur{display:inline-block;width:8px;height:14px;background:var(--g1);animation:bl .7s step-end infinite;vertical-align:text-bottom;margin-left:2px}
#boot-bar{width:60px;height:3px;background:var(--b3);border-radius:2px;flex-shrink:0}
#boot-f{height:100%;background:var(--g1);width:0%;transition:width .12s;border-radius:2px;box-shadow:var(--gg)}
@keyframes bl{50%{opacity:0}}
#app{display:none}#app.on{display:block}
.top{position:fixed;top:0;left:0;right:0;height:48px;background:var(--b1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 10px;z-index:100;gap:6px}
.tl{font-family:var(--fp);font-size:11px;color:var(--g1);letter-spacing:1px;text-shadow:var(--gg);white-space:nowrap}.tl b{color:var(--l1)}
.tr{margin-left:auto;display:flex;align-items:center;gap:5px}
.xpp{display:flex;align-items:center;gap:3px;font-family:var(--ff);font-size:14px;color:var(--wm)}
.xpt{width:40px;height:4px;background:var(--b3);border-radius:2px;overflow:hidden}
.xpfl{height:100%;background:var(--g1);border-radius:2px;transition:width .4s}
.lv{font-family:var(--fp);font-size:8px;color:var(--l1);border:1px solid var(--ld);padding:1px 5px;border-radius:var(--r)}
.dots{display:flex;gap:2px}.dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--bd);cursor:pointer;transition:var(--tr)}.dot.on{border-color:var(--g1);box-shadow:var(--gg)}
.dot[data-t="dark"]{background:linear-gradient(135deg,#7fcea0,#0a0a12)}.dot[data-t="eighties"]{background:linear-gradient(135deg,#ff6ef9,#00ffaa)}.dot[data-t="disco"]{background:linear-gradient(135deg,#ffd700,#ff1493)}
.bi{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:1px solid var(--bd);color:var(--t2);border-radius:var(--r);cursor:pointer;font-size:14px;transition:var(--tr);flex-shrink:0}.bi:active{border-color:var(--g1);color:var(--g1)}
.bn{position:fixed;bottom:0;left:0;right:0;height:58px;background:var(--b1);border-top:2px solid var(--bd);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom);backdrop-filter:blur(8px);background:var(--b1)ee}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;color:var(--t3);font-family:var(--fp);font-size:7px;letter-spacing:.3px;cursor:pointer;border:none;background:none;transition:color .15s;padding:0 2px;min-width:0}.nb .ic{font-size:18px;transition:all .15s}.nb.on{color:var(--g1)}.nb.on .ic{text-shadow:var(--gg);transform:scale(1.1)}.nb:active{color:var(--g1)}
.mn{padding:56px 12px 72px;max-width:620px;margin:0 auto}
.s{display:none;animation:fu .2s ease}.s.on{display:block}
@keyframes fu{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.sh{font-family:var(--ff);font-size:28px;color:var(--g1);text-shadow:var(--gg);margin-bottom:2px}
.ss2{font-family:var(--fs);font-size:10px;color:var(--t3);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bd);font-style:italic}
.wb{background:var(--bc);border:1px solid var(--bd);border-radius:6px;padding:14px;margin-bottom:10px;text-align:center;overflow:hidden;position:relative}
.wb::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,var(--gd) 0%,transparent 70%);pointer-events:none}
.wp{font-family:var(--ff);font-size:24px;color:var(--g1);text-shadow:var(--gg);position:relative}.wsb{font-family:var(--fs);font-size:10px;color:var(--t3);margin-top:3px;position:relative}
.sr{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.sc{background:var(--bc);border:1px solid var(--bd);border-radius:var(--r);padding:8px 4px;text-align:center}
.sv{font-family:var(--ff);font-size:22px;color:var(--g1)}.sv.l{color:var(--l1)}.sv.w{color:var(--wm)}.sv.r{color:var(--am)}
.sl{font-family:var(--fp);font-size:6px;color:var(--t3);letter-spacing:.5px;margin-top:1px}
.qt{background:var(--b2);border-left:3px solid var(--l1);padding:8px 10px;margin:8px 0;font-family:var(--fs);font-size:11px;color:var(--t2);font-style:italic}.qt cite{display:block;font-size:9px;color:var(--t3);margin-top:2px;font-style:normal}
.qf{background:var(--bc);border:1px solid var(--g2);border-radius:6px;margin-bottom:10px;cursor:pointer;overflow:hidden;position:relative}
.qf::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--g1),var(--l1));z-index:1}
.qfi{min-height:130px;display:flex;align-items:center;justify-content:center;text-align:center;padding:16px 14px;transition:transform .4s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d}
.qfi.fl{transform:rotateX(180deg)}
.qffr,.qfbk{backface-visibility:hidden;width:100%}
.qfbk{transform:rotateX(180deg);position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px 14px}
.qfl{font-family:var(--fp);font-size:7px;color:var(--l1);letter-spacing:1px;margin-bottom:5px}
.qfq{font-family:var(--ff);font-size:18px;color:var(--g1);line-height:1.3}
.qfa{font-size:12px;color:var(--l3);line-height:1.5}
.qfh{font-family:var(--fp);font-size:7px;color:var(--t3);margin-top:6px;letter-spacing:1px}
/* Play */
.dtabs{display:flex;gap:5px;margin-bottom:8px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:2px}.dtabs::-webkit-scrollbar{display:none}
.dt{flex-shrink:0;padding:6px 11px;background:var(--bc);border:1px solid var(--bd);border-radius:16px;font-size:10px;color:var(--t2);cursor:pointer;transition:var(--tr);white-space:nowrap;display:flex;align-items:center;gap:4px}
.dt.on{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.dd{display:inline-block;width:7px;height:7px;border-radius:50%}.d1{background:var(--g1)}.d2{background:var(--am)}.d3{background:var(--rd)}
.fp3{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-family:var(--ff);font-size:13px;color:var(--t2)}
.fpb{flex:1;height:3px;background:var(--b3);border-radius:2px;overflow:hidden}
.fpf{height:100%;background:linear-gradient(90deg,var(--g2),var(--l1));transition:width .4s;border-radius:2px}
.fc{background:var(--bc);border:1px solid var(--bd);border-radius:8px;min-height:170px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px 14px;cursor:pointer;user-select:none}
.fi{width:100%;transition:transform .4s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d}
.fi.fl{transform:rotateX(180deg)}
.ffr,.fbk{backface-visibility:hidden}
.fbk{transform:rotateX(180deg);position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:20px 14px}
.fqt{font-family:var(--ff);font-size:18px;color:var(--g1);line-height:1.3}
.fat{font-size:12px;color:var(--l3);line-height:1.5}
.ftp{font-family:var(--fp);font-size:7px;color:var(--t3);letter-spacing:1px;margin-top:6px}
.fbs{display:flex;gap:6px;margin-top:8px}
.fb{flex:1;padding:10px;border:1px solid var(--bd);border-radius:var(--r);background:var(--bc);color:var(--t2);font-size:12px;cursor:pointer;transition:var(--tr)}.fb:active{transform:scale(.96)}
.fb.ok{border-color:var(--g1);color:var(--g1)}.fb.ko{border-color:var(--rd);color:var(--rd)}.fb.sk{border-color:var(--t3)}
.fss{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
.fst{text-align:center;padding:6px;background:var(--bc);border:1px solid var(--bd);border-radius:var(--r)}
.fsv{font-family:var(--ff);font-size:18px}.fsv.g{color:var(--g1)}.fsv.r2{color:var(--rd)}.fsv.a{color:var(--am)}
.fsl{font-size:7px;color:var(--t3);font-family:var(--fp);letter-spacing:.5px}
.dk-play-info{font-size:11px;color:var(--t3);margin-bottom:10px;text-align:center}
/* Library */
.toolbar{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.tbtn{padding:6px 12px;background:var(--gd);border:1px solid var(--g2);color:var(--g1);font-family:var(--fp);font-size:8px;letter-spacing:.5px;border-radius:var(--r);cursor:pointer;transition:var(--tr);display:flex;align-items:center;gap:3px}
.tbtn:active{box-shadow:var(--gg)}.tbtn.sec{background:var(--ld);border-color:var(--l2);color:var(--l1)}.tbtn.danger{background:#1a0808;border-color:var(--rd);color:var(--rd)}
.dki{background:var(--bc);border:1px solid var(--bd);border-radius:6px;padding:10px;display:flex;flex-direction:column;gap:8px;margin-bottom:8px;transition:var(--tr)}
.dki-top{display:flex;align-items:center;gap:8px}
.dki-ico{font-size:24px;width:36px;text-align:center;flex-shrink:0}
.dki-t{font-family:var(--ff);font-size:15px;color:var(--g1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dki-m{font-size:9px;color:var(--t3);margin-top:1px}
.dki-acts{display:flex;gap:4px;flex-wrap:wrap}
.dki-acts button{flex:1;min-width:60px;padding:6px 0;display:flex;align-items:center;justify-content:center;gap:3px;background:var(--b3);border:1px solid var(--bd);color:var(--t2);border-radius:var(--r);cursor:pointer;font-size:10px;font-family:var(--fp);letter-spacing:.3px;transition:var(--tr)}
.dki-acts button:active{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.dki-acts .del{color:var(--rd)}.dki-acts .del:active{border-color:var(--rd);background:rgba(255,59,48,.1)}
/* old dki overrides removed */
/* Store */
.sti{background:var(--bc);border:1px solid var(--bd);border-radius:6px;padding:12px;margin-bottom:8px;display:flex;gap:10px;align-items:flex-start}
.sti-ico{font-size:26px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--b3);border-radius:var(--r);flex-shrink:0}
.sti-t{font-family:var(--ff);font-size:17px;color:var(--g1)}
.sti-d{font-size:10px;color:var(--t2);margin:2px 0 4px;line-height:1.4}
.sti-meta{font-size:8px;color:var(--t3);display:flex;gap:6px;align-items:center;margin-bottom:4px}
.sti-btn{padding:4px 10px;font-family:var(--fp);font-size:8px;letter-spacing:.5px;border-radius:var(--r);cursor:pointer;border:1px solid var(--g2);background:var(--gd);color:var(--g1)}.sti-btn:active{box-shadow:var(--gg)}
.sti-btn.done{border-color:var(--t3);color:var(--t3);background:var(--b2);cursor:default}
/* Modals */
.mo{position:fixed;inset:0;background:rgba(4,4,10,.97);z-index:200;display:none;overflow-y:auto;-webkit-overflow-scrolling:touch}
.mo.open{display:flex;flex-direction:column;animation:fu .15s ease}
.mo-in{background:var(--b1);flex:1;display:flex;flex-direction:column;max-width:600px;width:100%;margin:0 auto}
.mo-hd{padding:12px 14px;border-bottom:2px solid var(--g2);display:flex;align-items:center;gap:8px;position:sticky;top:0;background:var(--b1);z-index:10;min-height:48px}
.mo-t{font-family:var(--ff);font-size:18px;color:var(--g1);text-shadow:var(--gg)}
.mo-x{background:none;border:1px solid var(--bd);color:var(--t2);font-size:18px;cursor:pointer;width:36px;height:36px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;margin-left:auto;transition:var(--tr)}
.mo-x:active{border-color:var(--rd);color:var(--rd)}
.mo-bd{padding:14px;flex:1;overflow-y:auto}
.fg{margin-bottom:10px}
.fl{display:block;font-family:var(--fp);font-size:7px;letter-spacing:1px;color:var(--t3);margin-bottom:3px}
.fin{width:100%;padding:8px;background:var(--b2);border:1px solid var(--bd);border-radius:var(--r);color:var(--t1);font-family:var(--fm);font-size:12px;outline:none;transition:var(--tr)}.fin:focus{border-color:var(--g1)}
textarea.fin{min-height:50px;resize:vertical}
select.fin{-webkit-appearance:none;appearance:none}
.ce{background:var(--b2);border:1px solid var(--bd);border-radius:var(--r);padding:10px;margin-bottom:6px;display:flex;flex-direction:column;gap:6px}
.ce-bd{flex:1;min-width:0}.ce-q{font-family:var(--ff);font-size:13px;color:var(--g1);word-break:break-word;line-height:1.3}.ce-a{font-size:11px;color:var(--t2);margin-top:3px;word-break:break-word;padding:4px 6px;background:var(--b3);border-radius:3px;border-left:2px solid var(--g2)}
.ce-ac{display:flex;gap:4px}
.ce-ac button{flex:1;padding:5px 0;display:flex;align-items:center;justify-content:center;gap:2px;background:var(--b3);border:1px solid var(--bd);color:var(--t2);border-radius:var(--r);cursor:pointer;font-size:10px;font-family:var(--fp);letter-spacing:.3px;transition:var(--tr)}
.ce-ac button:active{border-color:var(--g1);color:var(--g1)}
/* Ency */
.esw{position:relative}.esw::before{content:'⌕';position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--t3);font-size:12px}
.esr{width:100%;padding:8px 8px 8px 26px;background:var(--bc);border:1px solid var(--bd);border-radius:var(--r);color:var(--t1);font-family:var(--fm);font-size:12px;outline:none;margin-bottom:6px}.esr:focus{border-color:var(--g1)}
.etg{display:flex;gap:4px;overflow-x:auto;margin-bottom:8px;scrollbar-width:none}.etg::-webkit-scrollbar{display:none}
.et{flex-shrink:0;padding:3px 8px;font-size:9px;background:var(--b2);border:1px solid var(--bd);border-radius:12px;color:var(--t2);cursor:pointer;white-space:nowrap}.et.on{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.eg{display:flex;flex-direction:column;gap:6px}
.ec{background:var(--bc);border:1px solid var(--bd);border-radius:6px;padding:10px;cursor:pointer;position:relative}.ec:active{transform:scale(.98);border-color:var(--g1)}
.ecc{font-family:var(--fp);font-size:7px;letter-spacing:.5px;color:var(--l1)}.ect{font-family:var(--ff);font-size:17px;color:var(--g1)}.ecd{font-size:10px;color:var(--t2);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.ecx{position:absolute;top:8px;right:8px;font-family:var(--fp);font-size:7px;color:var(--wm);background:var(--b0);padding:1px 4px;border-radius:var(--r);border:1px solid var(--wm)}.ecx.done{color:var(--g1);border-color:var(--g1)}
.emo h3{font-family:var(--ff);font-size:17px;color:var(--l1);margin:14px 0 4px}.emo h3:first-child{margin-top:0}
.emo strong{color:var(--g1)}.emo ul{padding-left:14px;margin:4px 0}.emo li{margin-bottom:3px;list-style-type:'▸ '}.emo li::marker{color:var(--gd)}
.formula{background:var(--b0);border:1px solid var(--bd);padding:6px;border-radius:var(--r);font-family:var(--fs);font-size:12px;color:var(--g1);text-align:center;margin:6px 0}
.emo table{width:100%;border-collapse:collapse;margin:6px 0;font-size:10px}
.emo th{background:var(--b3);padding:3px 5px;text-align:left;color:var(--l1);font-family:var(--fp);font-size:7px;letter-spacing:.5px;border-bottom:1px solid var(--bd)}.emo td{padding:3px 5px;border-bottom:1px solid var(--b3)}
.emo-ft{padding:8px 12px;border-top:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;background:var(--b1)}
/* Achievements */
.ag{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.ac{background:var(--bc);border:1px solid var(--bd);border-radius:var(--r);padding:8px;text-align:center}.ac.lk{opacity:.25;filter:grayscale(1)}.ac.gt{border-color:var(--wm)}
.aci{font-size:20px;margin-bottom:2px}.acn{font-family:var(--ff);font-size:12px;color:var(--g1)}.acd{font-size:7px;color:var(--t3)}
/* Toast */
.tc{position:fixed;top:52px;left:50%;transform:translateX(-50%);z-index:300;display:flex;flex-direction:column;align-items:center;gap:3px;pointer-events:none;width:88%;max-width:300px}
.toast{background:var(--bc);border:1px solid var(--g1);border-radius:var(--r);padding:5px 10px;font-family:var(--ff);font-size:13px;color:var(--g1);box-shadow:var(--gg);animation:ti .15s ease,to .15s ease 1.6s forwards;text-align:center;width:100%}
.toast.xp{border-color:var(--wm);color:var(--wm)}.toast.ach{border-color:var(--l1);color:var(--l1)}.toast.lv{border-color:var(--pk);color:var(--pk)}.toast.err{border-color:var(--rd);color:var(--rd)}
@keyframes ti{from{opacity:0;transform:translateY(-10px)}}@keyframes to{to{opacity:0;transform:translateY(-10px)}}
.empty{text-align:center;padding:24px;color:var(--t3);font-size:11px}.empty-i{font-size:28px;margin-bottom:6px;opacity:.4}
.ft{text-align:center;padding:14px 10px;border-top:1px solid var(--bd);margin-top:16px;font-size:9px;color:var(--t3);font-family:var(--fs)}
@media(min-width:640px){.mn{max-width:640px}.eg{display:grid;grid-template-columns:repeat(2,1fr);gap:7px}.ag{grid-template-columns:repeat(4,1fr)}}
@media(min-width:900px){
  .mn{max-width:860px;padding-top:56px;padding-bottom:20px}
  .bn{position:fixed;top:0;bottom:auto;left:0;right:0;height:48px;border-top:none;border-bottom:2px solid var(--bd);justify-content:center;gap:0;padding-left:140px;padding-right:160px;padding-bottom:0;background:var(--b1);z-index:99}
  .nb{flex:0 0 auto;padding:0 14px;flex-direction:row;gap:5px;font-size:9px;height:100%}
  .nb .ic{font-size:13px}
  .top{z-index:101;background:transparent;border:none;pointer-events:none;padding:0 12px}
  .top>*{pointer-events:auto}
  .top .tl{position:fixed;top:0;left:12px;height:48px;display:flex;align-items:center;z-index:101}
  .top .tr{position:fixed;top:0;right:12px;height:48px;display:flex;align-items:center;z-index:101}
  .top .top-home{display:none}
}
[data-theme="disco"] .tl{animation:dp 2s ease infinite alternate}@keyframes dp{0%{text-shadow:0 0 8px #ffd700,0 0 18px #ff1493}100%{text-shadow:0 0 10px #ff1493,0 0 20px #ffd700}}

/* ═══ PROFILE & CHARACTER SHEET ═══ */
.avatar-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;background:var(--b3);border:2px solid var(--bd);border-radius:50%;cursor:pointer;font-size:16px;flex-shrink:0;transition:all .2s;position:relative;overflow:hidden}
.avatar-btn img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.avatar-btn:hover,.avatar-btn:active{border-color:var(--g1);box-shadow:0 0 12px var(--g1)44}
.avatar-btn .notif{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:var(--rd);border-radius:50%;border:1px solid var(--b1);animation:notifPulse 2s ease infinite}
@keyframes notifPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}

/* Character Card */
.char-card{background:var(--bc);border:1px solid var(--bd);border-radius:8px;overflow:hidden;position:relative;margin-bottom:14px}
.char-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--g1),var(--l1),var(--am),var(--g1));background-size:300% 100%;animation:cardShine 4s linear infinite}
@keyframes cardShine{0%{background-position:0%}100%{background-position:300%}}
.char-top{display:flex;gap:12px;padding:14px;align-items:flex-start}
.char-photo-wrap{width:90px;height:90px;border-radius:6px;border:2px solid var(--g1);overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;background:var(--b3);display:flex;align-items:center;justify-content:center;box-shadow:var(--gg);transition:var(--tr)}
.char-photo-wrap:active{transform:scale(.96);box-shadow:0 0 20px var(--g1)}
.char-photo-wrap img{width:100%;height:100%;object-fit:cover}
.char-photo-wrap .ph-placeholder{font-size:36px;color:var(--t3);transition:var(--tr)}
.char-photo-wrap:hover .ph-placeholder{color:var(--g1)}
.char-photo-wrap .ph-edit{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,#000c);padding:2px 0;font-family:var(--fp);font-size:6px;color:var(--g1);text-align:center;letter-spacing:1px;opacity:0;transition:var(--tr)}
.char-photo-wrap:hover .ph-edit{opacity:1}
.char-id{flex:1;min-width:0}
.char-class{font-family:var(--fp);font-size:7px;letter-spacing:1.5px;color:var(--am);padding:2px 8px;background:var(--b2);border:1px solid var(--am);border-radius:10px;display:inline-block;margin-bottom:4px}
.char-name{font-family:var(--ff);font-size:26px;color:var(--g1);text-shadow:var(--gg);line-height:1.1;margin-bottom:2px;position:relative}
.char-name .glitch{position:absolute;top:0;left:0;color:var(--l1);clip-path:inset(0 0 65% 0);transform:translateX(2px);opacity:0;animation:glitch1 4s ease infinite}
@keyframes glitch1{0%,92%,100%{opacity:0}93%{opacity:.8;transform:translateX(2px)}94%{opacity:0}95%{opacity:.6;transform:translateX(-1px)}96%{opacity:0}}
.char-title{font-family:var(--fs);font-size:10px;color:var(--l1);font-style:italic}
.char-serial{font-family:var(--fm);font-size:8px;color:var(--t3);margin-top:3px;letter-spacing:1px}
.char-lv-badge{display:flex;align-items:center;gap:6px;margin-top:5px}
.char-lv-ring{width:32px;height:32px;border-radius:50%;border:2px solid var(--g1);display:flex;align-items:center;justify-content:center;font-family:var(--ff);font-size:16px;color:var(--g1);text-shadow:var(--gg);background:var(--b0);position:relative}
.char-lv-ring::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:1px solid transparent;border-top-color:var(--am);animation:lvSpin 3s linear infinite}
@keyframes lvSpin{to{transform:rotate(360deg)}}
.char-xp-mini{flex:1}
.char-xp-label{font-family:var(--fp);font-size:6px;color:var(--t3);letter-spacing:.5px}
.char-xp-bar{height:4px;background:var(--b3);border-radius:2px;overflow:hidden;margin-top:2px}
.char-xp-fill{height:100%;background:linear-gradient(90deg,var(--g2),var(--g1));border-radius:2px;transition:width .5s}
.char-xp-txt{font-family:var(--fm);font-size:8px;color:var(--t3);margin-top:1px}

/* Stats Hexagon Row */
.char-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bd);border-top:1px solid var(--bd)}
.cs{background:var(--bc);padding:10px 6px;text-align:center;position:relative;overflow:hidden}
.cs::after{content:'';position:absolute;bottom:0;left:0;height:2px;background:var(--g1);transition:width .8s ease}
.cs-v{font-family:var(--ff);font-size:22px;color:var(--g1);text-shadow:var(--gg);position:relative}
.cs-v.am{color:var(--am)}.cs-v.l{color:var(--l1)}.cs-v.rd{color:var(--rd)}.cs-v.wm{color:var(--wm)}
.cs-l{font-family:var(--fp);font-size:6px;color:var(--t3);letter-spacing:.5px;margin-top:1px}
.cs-bar{height:2px;background:var(--b3);border-radius:1px;margin-top:3px;overflow:hidden}
.cs-bar-f{height:100%;border-radius:1px;transition:width .8s ease}

/* Augmentations */
.char-augs{padding:10px 14px;border-top:1px solid var(--bd)}
.aug-label{font-family:var(--fp);font-size:7px;color:var(--t3);letter-spacing:1px;margin-bottom:6px}
.aug-grid{display:flex;flex-wrap:wrap;gap:4px}
.aug{padding:3px 8px;background:var(--b2);border:1px solid var(--bd);border-radius:12px;font-size:9px;color:var(--t2);display:flex;align-items:center;gap:3px;transition:var(--tr)}
.aug.active{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.aug.legendary{border-color:var(--am);color:var(--am);background:rgba(240,168,48,.08);animation:augGlow 2s ease infinite alternate}
@keyframes augGlow{from{box-shadow:none}to{box-shadow:0 0 8px #f0a83022}}

/* Photo Upload Overlay */
.photo-modal-bd{display:flex;flex-direction:column;align-items:center;gap:12px;padding:20px}
.photo-preview{width:160px;height:160px;border-radius:8px;border:2px solid var(--bd);overflow:hidden;background:var(--b3);display:flex;align-items:center;justify-content:center}
.photo-preview img{width:100%;height:100%;object-fit:cover}
.photo-preview canvas{width:100%;height:100%;object-fit:contain}
.photo-filters{display:flex;gap:4px;flex-wrap:wrap;justify-content:center}
.pf-btn{padding:4px 10px;font-size:9px;background:var(--b2);border:1px solid var(--bd);border-radius:10px;color:var(--t2);cursor:pointer;transition:var(--tr)}
.pf-btn.on{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.photo-upload-btn{padding:8px 20px;background:var(--gd);border:1px solid var(--g2);border-radius:var(--r);color:var(--g1);font-family:var(--fp);font-size:8px;letter-spacing:1px;cursor:pointer}

/* Settings */
.setting-group{margin-bottom:14px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--b2)}
.setting-label{font-size:11px;color:var(--t2)}.setting-sub{font-size:8px;color:var(--t3)}
.toggle{width:36px;height:20px;background:var(--b3);border-radius:10px;cursor:pointer;position:relative;transition:var(--tr);border:1px solid var(--bd);flex-shrink:0}
.toggle.on{background:var(--gd);border-color:var(--g2)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--t2);border-radius:50%;transition:var(--tr)}
.toggle.on::after{left:18px;background:var(--g1)}
.range-wrap{display:flex;align-items:center;gap:6px}
.range-wrap input[type="range"]{-webkit-appearance:none;width:70px;height:3px;background:var(--b3);border-radius:2px;outline:none}
.range-wrap input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--g1);border-radius:50%;cursor:pointer}
.range-val{font-family:var(--ff);font-size:13px;color:var(--g1);width:24px;text-align:right}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:160px;overflow-y:auto;padding:6px;background:var(--b2);border:1px solid var(--bd);border-radius:var(--r);margin-top:4px}
.emoji-opt{font-size:18px;text-align:center;cursor:pointer;padding:3px;border-radius:var(--r);transition:var(--tr)}.emoji-opt:hover{background:var(--gd)}

/* ═══ TOXIC GAMIFICATION ═══ */

/* ═══ WORKSPACE ═══ */
.ws-panel{background:var(--b2);border:1px solid var(--bd);border-radius:10px;padding:16px;margin-bottom:12px}
.ws-head{font-family:var(--fp);font-size:13px;letter-spacing:1px;color:var(--g1);margin-bottom:4px;text-transform:uppercase}
.ws-desc{font-size:10px;color:var(--t3);margin-bottom:12px;line-height:1.4}
.ws-formats{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:8px}
.ws-fmt{background:var(--b3);border:1px solid var(--bd);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer;transition:all .2s}
.ws-fmt:hover,.ws-fmt:active{border-color:var(--g2);transform:translateY(-1px);box-shadow:0 4px 12px #00000044}
.ws-fmt:active{transform:scale(.95)}
.ws-fmt.exp{border-color:var(--l1)33}.ws-fmt.exp:hover{border-color:var(--l1)}
.ws-fmt.geo{border-color:var(--am)33}.ws-fmt.geo:hover{border-color:var(--am)}
.ws-fmt-ico{font-size:24px;margin-bottom:4px}
.ws-fmt-t{font-family:var(--fp);font-size:10px;letter-spacing:.5px;color:var(--t1);font-weight:bold}
.ws-fmt-d{font-size:8px;color:var(--t3);margin-top:2px}
.ws-row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.ws-label{font-family:var(--fp);font-size:10px;color:var(--t3);letter-spacing:.5px}
.ws-select{flex:1;min-width:120px;background:var(--b3);color:var(--t1);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;font-family:var(--fp);font-size:11px}
.ws-btn-all{background:var(--b3);border:1px solid var(--g2);color:var(--g1);border-radius:6px;padding:6px 12px;font-family:var(--fp);font-size:10px;cursor:pointer;white-space:nowrap}
.ws-btn-all:hover{background:var(--g2);color:var(--b0)}
.ws-tip{font-size:9px;color:var(--t3);padding:8px;background:var(--b3);border-radius:6px;border-left:3px solid var(--g2);line-height:1.4}
.ws-preview-bar{display:flex;gap:6px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.ws-preview-bar span{flex:1;font-size:10px;color:var(--t3);font-family:var(--fp)}
.ws-btn-dl,.ws-btn-cp{background:var(--b3);border:1px solid var(--bd);color:var(--t1);border-radius:4px;padding:4px 10px;font-size:9px;font-family:var(--fp);cursor:pointer}
.ws-btn-dl:hover{border-color:var(--g2);color:var(--g1)}.ws-btn-cp:hover{border-color:var(--l1);color:var(--l1)}
.ws-preview{background:var(--b0);border:1px solid var(--bd);border-radius:6px;padding:12px;font-family:var(--fm);font-size:10px;color:var(--t2);line-height:1.5;max-height:400px;overflow:auto;white-space:pre-wrap;word-break:break-word;margin:0}
.ws-preview::-webkit-scrollbar{width:3px}.ws-preview::-webkit-scrollbar-thumb{background:var(--g2);border-radius:2px}
/* ═══ MENU HUB ═══ */
.menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:18px}
.menu-item{background:var(--b2);border:1px solid var(--bd);border-radius:10px;padding:18px 14px 14px;cursor:pointer;transition:all .2s ease;text-align:center;position:relative;overflow:hidden}
.menu-item::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--g2);opacity:0;transition:opacity .2s}
.menu-item:hover,.menu-item:active{border-color:var(--g2);background:var(--b3);transform:translateY(-2px);box-shadow:0 6px 20px #00000055}
.menu-item:hover::before,.menu-item:active::before{opacity:1}
.menu-item:active{transform:scale(.96)}
.mi-ico{font-size:36px;margin-bottom:8px;filter:drop-shadow(0 0 6px var(--g1))}
.mi-label{font-family:var(--fp);font-size:12px;letter-spacing:.8px;color:var(--t1);font-weight:bold;text-transform:uppercase}
.mi-desc{font-size:10px;color:var(--t3);margin-top:4px;line-height:1.3}
.menu-section-title{font-family:var(--fp);font-size:10px;letter-spacing:1.5px;color:var(--g2);margin-bottom:8px;padding-left:2px;text-transform:uppercase}
.menu-toggles{display:flex;flex-direction:column;gap:8px;background:var(--b2);border:1px solid var(--bd);border-radius:10px;padding:12px 16px}
.mt-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--t2);font-family:var(--fp)}
.mt-sel{background:var(--b3);color:var(--t1);border:1px solid var(--bd);border-radius:4px;padding:4px 8px;font-size:11px;font-family:var(--fp)}
.menu-item:nth-child(1){border-color:var(--l1)44}.menu-item:nth-child(2){border-color:var(--g2)44}
.menu-item:nth-child(3){border-color:var(--am)44}.menu-item:nth-child(4){border-color:var(--l1)44}
@media(min-width:500px){.menu-grid{grid-template-columns:repeat(4,1fr);gap:12px}}
.quick-nav{display:flex;gap:8px;margin:12px 0 8px;flex-wrap:wrap}
.qn-btn{flex:1;min-width:80px;padding:10px 6px;background:var(--b2);border:1px solid var(--bd);border-radius:8px;color:var(--t2);font-family:var(--fp);font-size:10px;letter-spacing:.3px;cursor:pointer;transition:all .2s;white-space:nowrap;text-align:center}
.qn-btn:hover,.qn-btn:active{border-color:var(--g2);color:var(--g1);background:var(--b3);box-shadow:0 2px 8px #00000033}
/* ═══ SEARCH ENGINE ═══ */
.search-fab{position:fixed;bottom:66px;right:12px;width:44px;height:44px;background:var(--b2);border:1px solid var(--g2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:80;box-shadow:0 2px 12px #00000066;transition:var(--tr)}
.search-fab:active{transform:scale(.9);box-shadow:var(--gg)}
.search-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;display:none;flex-direction:column;animation:fu .2s ease}
.search-overlay.show{display:flex}
.search-top{padding:10px 12px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--bd);background:var(--b1)}
.search-input{flex:1;background:var(--b2);border:1px solid var(--bd);border-radius:var(--r);padding:10px 12px;color:var(--t1);font-family:var(--fm);font-size:14px;outline:none}
.search-input:focus{border-color:var(--g1);box-shadow:0 0 8px #a3d9a540}
.search-input::placeholder{color:var(--t3)}
.search-close{background:none;border:none;color:var(--t2);font-size:20px;cursor:pointer;padding:4px 8px}
.search-filters{display:flex;gap:4px;padding:6px 12px;background:var(--b0)}
.sf-btn{padding:3px 10px;font-size:9px;font-family:var(--fp);letter-spacing:.5px;background:var(--b2);border:1px solid var(--bd);border-radius:10px;color:var(--t3);cursor:pointer}
.sf-btn.on{border-color:var(--g1);color:var(--g1);background:var(--gd)}
.search-results{flex:1;overflow-y:auto;padding:8px 12px}
.search-results::-webkit-scrollbar{width:4px}.search-results::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
.sr-item{padding:10px;background:var(--bc);border:1px solid var(--bd);border-radius:var(--r);margin-bottom:6px;cursor:pointer;transition:var(--tr)}
.sr-item:active{border-color:var(--g1)}
.sr-type{font-family:var(--fp);font-size:7px;letter-spacing:1px;color:var(--l1);margin-bottom:2px}
.sr-title{font-family:var(--ff);font-size:14px;color:var(--g1);margin-bottom:2px}
.sr-excerpt{font-size:10px;color:var(--t2);line-height:1.4}
.sr-excerpt mark{background:transparent;color:var(--am);font-weight:700}
.sr-empty{text-align:center;padding:40px 20px;color:var(--t3);font-size:12px}
.sr-empty .sr-e-ico{font-size:32px;margin-bottom:8px;opacity:.5}
.sr-count{font-size:9px;color:var(--t3);padding:4px 0;font-family:var(--fp);letter-spacing:.5px}

/* ═══ CONSOLE TERMINAL ═══ */
.console-wrap{background:var(--b0);border:1px solid var(--g2);border-radius:8px;overflow:hidden;margin-bottom:12px;display:flex;flex-direction:column}
.console-bar{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--b2);border-bottom:1px solid var(--bd);flex-shrink:0}
.console-dots{display:flex;gap:4px}
.console-dot{width:8px;height:8px;border-radius:50%}
.console-dot.r{background:#ff5f57}.console-dot.y{background:#ffbd2e}.console-dot.g{background:#28c840}
.console-title{font-family:var(--fm);font-size:9px;color:var(--t3);flex:1;text-align:center}
.console-body{min-height:200px;height:calc(100vh - 280px);max-height:500px;overflow-y:auto;overflow-x:hidden;padding:8px 10px;font-family:var(--fm);font-size:11px;line-height:1.6;color:var(--g1)}
.console-body::-webkit-scrollbar{width:3px}.console-body::-webkit-scrollbar-thumb{background:var(--g2);border-radius:2px}
.console-body .c-line{margin-bottom:2px;word-break:break-word}
.c-line .prompt{color:var(--l1)}.c-line .cmd{color:var(--g1)}.c-line .out{color:var(--t2)}.c-line .err{color:var(--rd)}.c-line .hl{color:var(--am)}.c-line .ok{color:#28c840}.c-line .info{color:var(--l1)}
.c-line .ascii{color:var(--g2);font-size:min(9px,2vw);line-height:1.1;white-space:pre;overflow-x:auto;display:block;max-width:100%}
.console-input-row{display:flex;align-items:center;padding:8px 12px;background:var(--b1);border-top:2px solid var(--g2);flex-shrink:0}
.console-prompt{color:var(--l1);font-family:var(--fm);font-size:12px;margin-right:6px;flex-shrink:0;font-weight:bold}
.console-in{flex:1;background:transparent;border:none;color:var(--g1);font-family:var(--fm);font-size:12px;outline:none;caret-color:var(--g1)}
.streak-bar{background:var(--bc);border:1px solid var(--bd);border-radius:6px;padding:10px 12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden}
.streak-bar::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--am),var(--rd),var(--am));background-size:200% 100%;animation:streakShimmer 2s linear infinite}
@keyframes streakShimmer{0%{background-position:0%}100%{background-position:200%}}
.streak-fire{font-size:24px;animation:firePulse 1s ease infinite alternate}
@keyframes firePulse{from{transform:scale(1)}to{transform:scale(1.15)}}
.streak-num{font-family:var(--ff);font-size:28px;color:var(--am);text-shadow:0 0 10px #f0a83044}
.streak-txt{font-size:10px;color:var(--t2);flex:1}
.streak-warn{font-size:9px;color:var(--rd);font-family:var(--fp);letter-spacing:.5px}
.streak-bar .disc-btn{margin-left:auto}

.combo-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);font-family:var(--ff);font-size:60px;color:var(--am);text-shadow:0 0 30px #f0a83088,0 0 60px #f0a83044;z-index:250;pointer-events:none;transition:transform .15s cubic-bezier(.4,0,.2,1),opacity .3s}
.combo-overlay.show{transform:translate(-50%,-50%) scale(1);animation:comboPop .5s ease forwards}
@keyframes comboPop{0%{transform:translate(-50%,-50%) scale(.3);opacity:1}50%{transform:translate(-50%,-50%) scale(1.2)}70%{transform:translate(-50%,-50%) scale(1)}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}

.daily-challenge{background:linear-gradient(135deg,var(--bc),var(--b2));border:1px solid var(--am);border-radius:6px;padding:12px;margin-bottom:10px;position:relative;overflow:hidden}
.daily-challenge::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,#f0a83008 50%,transparent 60%);background-size:200% 200%;animation:dailyShine 3s ease infinite}
@keyframes dailyShine{0%{background-position:0% 0%}100%{background-position:200% 200%}}
.dc-head{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.dc-label{font-family:var(--fp);font-size:8px;letter-spacing:1px;color:var(--am)}
.dc-timer{margin-left:auto;font-family:var(--ff);font-size:14px;color:var(--rd);animation:timerPulse 1s ease infinite alternate}
@keyframes timerPulse{from{opacity:1}to{opacity:.6}}
.dc-q{font-family:var(--ff);font-size:16px;color:var(--g1);line-height:1.3}
.dc-reward{font-size:10px;color:var(--am);margin-top:4px}

.lootbox{background:var(--bc);border:1px solid var(--l1);border-radius:6px;padding:14px;text-align:center;cursor:pointer;transition:var(--tr);animation:lootGlow 2s ease infinite alternate;margin-bottom:10px}
@keyframes lootGlow{0%{box-shadow:0 0 8px #c4a8e620}100%{box-shadow:0 0 20px #c4a8e644}}
.lootbox:active{transform:scale(.96)}
.lootbox.opened{animation:none;border-color:var(--bd);cursor:default}
.loot-ico{font-size:32px;margin-bottom:4px}
.loot-label{font-family:var(--fp);font-size:8px;color:var(--l1);letter-spacing:1px}
.loot-result{font-family:var(--ff);font-size:20px;color:var(--am);margin-top:6px}

.social-proof{font-size:10px;color:var(--t3);text-align:center;padding:6px;display:flex;align-items:center;justify-content:center;gap:4px;margin-bottom:10px}
.sp-num{color:var(--g1);font-family:var(--ff);font-size:14px}
.sp-dot{width:6px;height:6px;background:var(--g1);border-radius:50%;animation:spBlink 2s ease infinite}
@keyframes spBlink{0%,100%{opacity:1}50%{opacity:.3}}

/* ═══ DISCLAIMERS ═══ */
.disc-btn{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;background:var(--rd);border:none;color:#fff;border-radius:50%;cursor:pointer;font-size:9px;font-weight:700;flex-shrink:0;transition:var(--tr);vertical-align:middle;font-family:var(--fm)}
.disc-btn:active{transform:scale(1.2)}
.disc-pop{display:none;background:var(--b0);border:1px solid var(--rd);border-radius:6px;padding:10px 12px;margin-top:6px;position:relative;animation:fu .2s ease}
.disc-pop.show{display:block}
.disc-pop::before{content:'⚠️ ATTENTION ECONOMY';display:block;font-family:var(--fp);font-size:7px;letter-spacing:1px;color:var(--rd);margin-bottom:4px}
.disc-title{font-family:var(--ff);font-size:15px;color:var(--rd);margin-bottom:3px}
.disc-text{font-size:10px;color:var(--t2);line-height:1.5}
.disc-ref{font-size:9px;color:var(--t3);margin-top:4px;font-style:italic}
.disc-toggle-row{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;font-size:10px;color:var(--t3)}

/* ═══ STATS DASHBOARD ═══ */
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px}
.stat-card{background:var(--b2);border:1px solid var(--bd);border-radius:8px;padding:14px 10px;text-align:center}
.stat-v{font-family:var(--fp);font-size:24px;color:var(--g1);letter-spacing:1px}
.stat-l{font-family:var(--fp);font-size:8px;color:var(--t3);letter-spacing:1px;margin-top:2px}
.stat-section{background:var(--b2);border:1px solid var(--bd);border-radius:8px;padding:14px;margin-bottom:10px}
.stat-title{font-family:var(--fp);font-size:11px;letter-spacing:1px;color:var(--g2);margin-bottom:10px}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--bd);font-size:12px;color:var(--t2)}
.stat-row:last-child{border:none}
.stat-bar-wrap{height:6px;background:var(--b3);border-radius:3px;flex:1;margin:0 10px;overflow:hidden}
.stat-bar{height:100%;border-radius:3px;transition:width .5s ease}
.stat-bar.g{background:var(--g1)}.stat-bar.r{background:var(--rd)}.stat-bar.a{background:var(--am)}
.heatmap{display:flex;gap:4px;flex-wrap:wrap}
.heat-day{display:flex;flex-direction:column;align-items:center;gap:2px}
.heat-box{width:28px;height:28px;border-radius:4px;border:1px solid var(--bd);transition:all .2s}
.heat-box.h0{background:var(--b3)}.heat-box.h1{background:#1a3a1a}.heat-box.h2{background:#2a6a2a}.heat-box.h3{background:#3a9a3a}.heat-box.h4{background:var(--g1);box-shadow:0 0 6px var(--g1)44}
.heat-label{font-size:7px;color:var(--t3);font-family:var(--fp)}
.hard-card{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--bd);font-size:11px;gap:8px}
.hard-card:last-child{border:none}
.hard-q{flex:1;color:var(--t2);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hard-score{font-family:var(--fp);font-size:10px;padding:2px 6px;border-radius:3px;white-space:nowrap}
.hard-score.bad{background:var(--rd)22;color:var(--rd)}.hard-score.med{background:var(--am)22;color:var(--am)}.hard-score.ok{background:var(--g1)22;color:var(--g1)}
.sr-badge{display:inline-block;background:var(--am)22;color:var(--am);font-family:var(--fp);font-size:8px;padding:2px 6px;border-radius:3px;letter-spacing:.5px;margin-left:6px}
/* ═══ SWIPE ═══ */
.fc{touch-action:pan-y;user-select:none}
.fc.swiping{transition:none!important}
.fc.swipe-right{transform:translateX(60px) rotate(5deg);opacity:.7}
.fc.swipe-left{transform:translateX(-60px) rotate(-5deg);opacity:.7}
.fc.swipe-ok{box-shadow:0 0 20px #28c84066;border-color:#28c840}
.fc.swipe-ko{box-shadow:0 0 20px #ff3b3066;border-color:#ff3b30}
.swipe-hint{position:absolute;top:50%;font-size:28px;opacity:0;transition:opacity .15s;pointer-events:none;z-index:5}
.swipe-hint.left{left:12px}.swipe-hint.right{right:12px}
.fc.swipe-right .swipe-hint.right{opacity:1}.fc.swipe-left .swipe-hint.left{opacity:1}

/* ═══ DRAG & DROP ═══ */
.drop-zone{border:2px dashed var(--bd);border-radius:10px;padding:24px 16px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px;position:relative}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--g1);background:var(--g1)0a;box-shadow:0 0 16px var(--g1)22}
.drop-zone.dragover::after{content:'LÂCHEZ LE FICHIER';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:var(--g1)15;color:var(--g1);font-family:var(--fp);font-size:14px;letter-spacing:2px;border-radius:8px}
.dz-ico{font-size:32px;margin-bottom:6px;opacity:.6}
.dz-txt{font-family:var(--fp);font-size:10px;color:var(--t3);letter-spacing:.5px}
.dz-formats{font-size:9px;color:var(--t3);margin-top:4px;opacity:.6}

/* ═══ ONBOARDING ═══ */
.onboard-overlay{position:fixed;inset:0;background:#0a0a14f5;z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.onboard-card{background:var(--b2);border:1px solid var(--g2);border-radius:12px;max-width:400px;width:90%;padding:28px 24px;text-align:center;animation:obIn .4s ease}
@keyframes obIn{from{opacity:0;transform:scale(.9) translateY(20px)}to{opacity:1;transform:none}}
.ob-ico{font-size:48px;margin-bottom:12px}
.ob-title{font-family:var(--fp);font-size:18px;color:var(--g1);margin-bottom:8px;letter-spacing:1px}
.ob-text{font-size:13px;color:var(--t2);line-height:1.6;margin-bottom:20px}
.ob-dots{display:flex;gap:8px;justify-content:center;margin-bottom:20px}
.ob-dot{width:8px;height:8px;border-radius:50%;background:var(--bd);transition:all .2s}
.ob-dot.on{background:var(--g1);box-shadow:var(--gg)}
.ob-btns{display:flex;gap:10px;justify-content:center}
.ob-btn{padding:10px 24px;border-radius:8px;font-family:var(--fp);font-size:12px;letter-spacing:.5px;cursor:pointer;border:none;transition:all .2s}
.ob-btn.primary{background:var(--g1);color:var(--b0)}.ob-btn.primary:hover{box-shadow:var(--gg)}
.ob-btn.secondary{background:var(--b3);color:var(--t2);border:1px solid var(--bd)}.ob-btn.secondary:hover{border-color:var(--g2)}
.ob-keys{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:8px}
.ob-key{background:var(--b3);border:1px solid var(--bd);border-radius:4px;padding:3px 8px;font-family:var(--fm);font-size:10px;color:var(--t3)}

/* ═══ ACCESSIBILITY ═══ */
*:focus-visible{outline:2px solid var(--g1);outline-offset:2px;border-radius:2px}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;scroll-behavior:auto!important}.fc.swipe-right,.fc.swipe-left{transition:none}}
@media(prefers-contrast:more){:root{--bd:#555;--t3:#aaa;--b2:#0f0f1f}.ws-fmt,.menu-item,.dki{border-width:2px}}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
[role="button"]{cursor:pointer}

/* ═══ OFFLINE INDICATOR ═══ */
.offline-bar{position:fixed;top:0;left:0;right:0;background:#ff3b30;color:#fff;text-align:center;font-family:var(--fp);font-size:10px;letter-spacing:1px;padding:4px;z-index:9998;transform:translateY(-100%);transition:transform .3s}
.offline-bar.show{transform:translateY(0)}

/* ═══ PRINT ═══ */
@media print{.bn,.search-fab,.topbar,.lootbox,.social-proof,.disc-pop,.disc-btn,.streak-bar,.combo-popup,.offline-bar{display:none!important}body,.mn{background:#fff!important;color:#000!important;padding:0!important;max-width:100%!important}.s{display:block!important;break-inside:avoid}.sh{color:#000!important;border-color:#000!important}.fc{box-shadow:none!important;border:1px solid #ccc!important}.fi{transform:none!important}.ffr,.fbk{display:block!important;backface-visibility:visible!important}.fqt,.fat{color:#000!important}}
</style>
<meta name="description" content="COGWAR ULTIMATE — Application d'entraînement cognitif pour comprendre et résister à la guerre cognitive. 235 flashcards, 30 entrées encyclopédiques, console hacker.">
<meta name="keywords" content="guerre cognitive, cognitive warfare, flashcards, éducation, OTAN, désinformation, biais cognitifs, OODA, manipulation">
<meta property="og:type" content="website"><meta property="og:title" content="COGWAR ULTIMATE — Cognitive Warfare Training"><meta property="og:description" content="235 flashcards + 30 entrées encyclopédiques sur la guerre cognitive."><meta property="og:locale" content="fr_FR">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="COGWAR ULTIMATE">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"COGWAR ULTIMATE","applicationCategory":"EducationalApplication","operatingSystem":"Web","description":"Entraînement cognitif — guerre cognitive, biais, désinformation","inLanguage":"fr","author":{"@type":"Organization","name":"COGWAR"},"offers":{"@type":"Offer","price":"0","priceCurrency":"EUR"},"learningResourceType":"Flashcard"}</script>
</head>
<body>
<div class="offline-bar" id="offline-bar" role="alert" aria-live="assertive">⚡ HORS-LIGNE — Store indisponible</div>
<div class="onboard-overlay" id="onboard" style="display:none" role="dialog" aria-modal="true" aria-label="Bienvenue"><div class="onboard-card" id="ob-card"></div></div>
<div id="boot"><span id="boot-l">WOPR ONLINE...</span><span class="cur"></span><div id="boot-bar"><div id="boot-f"></div></div></div>
<div id="app">
<header class="top">
  <button class="bi top-home" onclick="go('home')">⬡</button>
  <div class="tl">COGWAR <b>//</b> WOPR</div>
  <div class="tr">
    <div class="dots"><div class="dot on" data-t="dark" onclick="setT('dark')"></div><div class="dot" data-t="eighties" onclick="setT('eighties')"></div><div class="dot" data-t="disco" onclick="setT('disco')"></div></div>
    <div class="xpp"><div class="xpt"><div class="xpfl" id="xpf"></div></div><span id="xpd">0</span></div>
    <div class="lv" id="lvd">LV1</div>
    <div class="avatar-btn" id="av-btn" onclick="go('profile')" aria-label="Profil"><span id="av-ico">🤖</span><div class="notif" id="notif-dot" style="display:none"></div></div>
  </div>
</header>
<main class="mn">

<section class="s on" id="s-home">
  <div class="wb"><div class="wp">SHALL WE PLAY A GAME?</div><div class="wsb">WOPR // War Operation Plan Response</div></div>

  <!-- Streak -->
  <div class="streak-bar" id="streak-bar" style="display:none">
    <div class="streak-fire">🔥</div>
    <div class="streak-num" id="streak-num">0</div>
    <div style="flex:1">
      <div class="streak-txt" id="streak-txt">Jouez pour démarrer votre série!</div>
      <div class="streak-warn" id="streak-warn" style="display:none">⚠ VOUS ALLEZ PERDRE VOTRE STREAK!</div>
    </div>
    <button class="disc-btn" onclick="toggleDisc('disc-streak')">!</button>
  </div>
  <div class="disc-pop" id="disc-streak">
    <div class="disc-title">Aversion à la Perte</div>
    <div class="disc-text">Ce compteur de streak exploite votre <strong style="color:var(--rd)">aversion à la perte</strong> : vous valorisez davantage ce que vous risquez de perdre que ce que vous pourriez gagner. La peur de « casser la série » vous pousse à revenir chaque jour — même sans envie réelle d'apprendre.</div>
    <div class="disc-ref">→ Kahneman & Tversky, Prospect Theory, 1979. Technique utilisée par : Duolingo, Snapchat, Wordle.</div>
  </div>

  <!-- Daily Challenge -->
  <div class="daily-challenge" id="daily-ch">
    <div class="dc-head">
      <div class="dc-label">⏱ DÉFI QUOTIDIEN</div>
      <div class="dc-timer" id="dc-timer">23:59:59</div>
      <button class="disc-btn" onclick="toggleDisc('disc-daily')">!</button>
    </div>
    <div class="dc-q" id="dc-q">Chargement...</div>
    <div class="dc-reward">🏆 +50 XP bonus · Disparaît à minuit</div>
  </div>
  <div class="disc-pop" id="disc-daily">
    <div class="disc-title">Rareté Artificielle (FOMO)</div>
    <div class="disc-text">Ce compte à rebours crée un sentiment d'<strong style="color:var(--rd)">urgence artificielle</strong>. L'information que le défi « disparaît » active votre Fear Of Missing Out, court-circuitant la réflexion rationnelle au profit de l'action impulsive.</div>
    <div class="disc-ref">→ Cialdini, Influence, 1984 (Principe de rareté). Technique utilisée par : Amazon, Booking, TikTok.</div>
  </div>

  <!-- Social Proof -->
  <div class="social-proof" id="social-proof">
    <div class="sp-dot"></div>
    <span class="sp-num" id="sp-num">0</span> utilisateurs ont étudié aujourd'hui
    <button class="disc-btn" onclick="toggleDisc('disc-social')" style="margin-left:4px">!</button>
  </div>
  <div class="disc-pop" id="disc-social">
    <div class="disc-title">Preuve Sociale</div>
    <div class="disc-text">Ce compteur est <strong style="color:var(--rd)">entièrement fabriqué</strong>. Il n'y a aucun serveur qui compte les utilisateurs. Mais sa simple présence vous pousse à agir par conformisme : « Si d'autres le font, je devrais aussi. » L'homophilie de réseau amplifie cet effet.</div>
    <div class="disc-ref">→ Asch, Conformity Experiments, 1951. Technique utilisée par : Booking ("17 personnes regardent"), Amazon, Trustpilot.</div>
  </div>
  <div class="qf" id="qf" onclick="qfTap()"><div class="qfi" id="qfi"><div class="qffr"><div class="qfl">⚡ FLASHCARD — TAP</div><div class="qfq" id="qfq">Chargement...</div><div class="qfh">[ TAP POUR RETOURNER ]</div></div><div class="qfbk"><div class="qfa" id="qfa"></div><div class="qfh">[ TAP → NOUVELLE CARTE ]</div></div></div></div>
  <div class="sr"><div class="sc"><div class="sv" id="dh-d">0</div><div class="sl">DECKS</div></div><div class="sc"><div class="sv l" id="dh-c">0</div><div class="sl">CARTES</div></div><div class="sc"><div class="sv w" id="dh-x">0</div><div class="sl">XP</div></div><div class="sc"><div class="sv r" id="dh-s">0</div><div class="sl">SESSIONS</div></div></div>
  <div class="quick-nav">
    <button class="qn-btn" onclick="go('play')">⚡ Jouer</button>
    <button class="qn-btn" onclick="go('ency')">◈ Encyclopédie</button>
    <button class="qn-btn" onclick="go('profile')">🤖 Profil</button>
    <button class="qn-btn" onclick="go('console')">⌨ Console</button>
    <button class="qn-btn" onclick="go('stats')">📊 Stats</button>
  </div>

  <!-- Loot Box -->
  <div class="lootbox" id="lootbox" style="display:none" onclick="openLoot()">
    <div class="loot-ico" id="loot-ico">🎁</div>
    <div class="loot-label">RÉCOMPENSE MYSTÈRE DÉBLOQUÉE</div>
    <div class="loot-result" id="loot-result"></div>
  </div>
  <div class="disc-pop" id="disc-loot">
    <div class="disc-title">Renforcement à Ratio Variable</div>
    <div class="disc-text">La « mystery box » utilise le <strong style="color:var(--rd)">renforcement intermittent</strong> : des récompenses imprévisibles sont plus addictives que des récompenses fixes. C'est le même mécanisme que les machines à sous. Votre cerveau libère plus de dopamine pour l'anticipation du résultat que pour le résultat lui-même.</div>
    <div class="disc-ref">→ B.F. Skinner, Schedules of Reinforcement, 1957. Technique utilisée par : Loot boxes (Fortnite), Gacha games, slot machines.</div>
  </div>

  <div class="disc-toggle-row"><span>Les boutons</span> <button class="disc-btn" style="width:14px;height:14px;font-size:7px">!</button> <span>révèlent les techniques de manipulation utilisées sur vous en ce moment.</span></div>
  <div class="qt">« A strange game. The only winning move is not to play. »<cite>— Joshua/WOPR, WarGames (1983)</cite></div>
</section>

<section class="s" id="s-play">
  <div class="sh">PLAY</div><div class="ss2">"Shall we play a game?" — Joshua, WarGames 1983</div>
  <div class="dtabs" id="ptabs"></div>
  <button class="ws-btn-all" style="margin-bottom:10px;width:100%;padding:10px;font-size:11px" onclick="startSR()" id="sr-btn">🧠 RÉVISION INTELLIGENTE (SM-2) — <span id="sr-due-count">0</span> carte(s) à réviser</button>
  <div id="play-empty" class="empty" style="display:none"><div class="empty-i">🃏</div>Aucun deck disponible.<br>Allez dans le <b>Store</b> pour en installer.</div>
  <div id="play-zone">
    <div class="dk-play-info" id="pinfo"></div>
    <div class="fp3"><span id="pctr">—</span><div class="fpb"><div class="fpf" id="ppf"></div></div><span id="psc"></span></div>
    <div class="fc" id="pc" onclick="pflip()" role="button" tabindex="0" aria-label="Flashcard"><span class="swipe-hint left">✗</span><span class="swipe-hint right">✓</span><div class="fi" id="pi"><div class="ffr"><div><div class="fqt" id="pq">← Choisissez un deck</div><div class="ftp">[ TAP / SWIPE ]</div></div></div><div class="fbk"><div class="fat" id="pa"></div></div></div></div>
    <div class="fbs" id="pbs" style="display:none"><button class="fb ko" onclick="pans(0)" aria-label="Raté">✗ Raté</button><button class="fb sk" onclick="psk()" aria-label="Passer">→</button><button class="fb ok" onclick="pans(1)" aria-label="Acquis">✓ Acquis</button></div>
    <div class="fss"><div class="fst"><div class="fsv g" id="ps-ok">0</div><div class="fsl">OK</div></div><div class="fst"><div class="fsv r2" id="ps-ko">0</div><div class="fsl">ERR</div></div><div class="fst"><div class="fsv a" id="ps-st">0</div><div class="fsl">SÉRIE</div></div></div>
    <div class="disc-pop" id="disc-combo" style="margin-top:8px">
      <div class="disc-title">Boucle Dopaminergique</div>
      <div class="disc-text">Le multiplicateur de combo (×2, ×3...) libère de la <strong style="color:var(--rd)">dopamine à chaque palier</strong>, créant un état de « flow » addictif. La peur de briser le combo inhibe votre cortex préfrontal exactement comme décrit dans l'entrée « Signal d'Erreur ». Vous continuez non par désir d'apprendre, mais par dépendance au feedback positif.</div>
      <div class="disc-ref">→ Csikszentmihalyi, Flow, 1990. Technique utilisée par : Guitar Hero, Candy Crush, tous les jeux compétitifs.</div>
    </div>
  </div>
</section>

<section class="s" id="s-stats">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('more')">◀</button><div class="sh" style="margin:0">Statistiques</div></div>
  <div class="ss2">"Without data, you're just another person with an opinion." — W.E. Deming</div>

  <div class="stat-grid">
    <div class="stat-card"><div class="stat-v" id="st-total-cards">0</div><div class="stat-l">CARTES ÉTUDIÉES</div></div>
    <div class="stat-card"><div class="stat-v" id="st-accuracy">0%</div><div class="stat-l">PRÉCISION</div></div>
    <div class="stat-card"><div class="stat-v" id="st-streak">0</div><div class="stat-l">MEILLEURE SÉRIE</div></div>
    <div class="stat-card"><div class="stat-v" id="st-sessions">0</div><div class="stat-l">SESSIONS</div></div>
  </div>

  <div class="stat-section">
    <div class="stat-title">🧠 RÉVISION ESPACÉE (SM-2)</div>
    <div class="stat-row"><span>Cartes à réviser maintenant</span><strong id="st-due" style="color:var(--am)">0</strong></div>
    <div class="stat-row"><span>Cartes maîtrisées (intervalle > 7j)</span><strong id="st-mastered" style="color:var(--g1)">0</strong></div>
    <div class="stat-row"><span>Cartes en apprentissage</span><strong id="st-learning">0</strong></div>
    <div class="stat-row"><span>Cartes jamais vues</span><strong id="st-unseen" style="color:var(--t3)">0</strong></div>
    <button class="ws-btn-all" style="margin-top:8px;width:100%" onclick="go('play');setTimeout(()=>startSR(),300)">🧠 Lancer la révision intelligente</button>
  </div>

  <div class="stat-section">
    <div class="stat-title">📊 PERFORMANCE PAR DECK</div>
    <div id="st-decks"></div>
  </div>

  <div class="stat-section">
    <div class="stat-title">📅 ACTIVITÉ (7 DERNIERS JOURS)</div>
    <div class="heatmap" id="st-heat"></div>
  </div>

  <div class="stat-section">
    <div class="stat-title">🔥 CARTES LES PLUS DIFFICILES</div>
    <div id="st-hard"></div>
  </div>
</section>

<section class="s" id="s-lib">
  <div class="sh">Mes Decks</div><div class="ss2">"Knowledge is power." — Petyr Baelish</div>
  <div class="toolbar">
    <button class="tbtn" onclick="deckForm()" style="font-size:10px;padding:8px 16px">+ Nouveau Deck</button>
    <button class="tbtn sec" onclick="$('imp-f').click()" style="font-size:10px;padding:8px 16px">⬆ Import JSON</button>
    <input type="file" id="imp-f" accept=".json" style="display:none" onchange="doImport(event)">
  </div>
  <div class="qt" style="margin-bottom:8px;font-size:9px">Chaque deck a 4 actions : 🃏 voir/éditer les cartes · ✏️ éditer le deck · ⬇ exporter · ✕ supprimer</div>
  <div id="lib-list"></div>
  <div id="lib-empty" class="empty"><div class="empty-i">📦</div>Bibliothèque vide.<br>Créez un deck avec le bouton ci-dessus ou visitez le Store.</div>
</section>

<section class="s" id="s-store">
  <div class="sh">Store</div><div class="ss2">"I'd like to play Global Thermonuclear War." — David Lightman</div>
  <div style="display:flex;gap:4px;margin-bottom:10px">
    <div class="et on" id="st-tab-dk" onclick="storeTab('dk')">📦 Decks</div>
    <div class="et" id="st-tab-en" onclick="storeTab('en')">◈ Encyclopédie</div>
  </div>
  <div class="qt" style="margin-bottom:8px;font-size:9px">Pour ajouter du contenu : déposez vos JSON dans <code>decks/</code> ou <code>ency/</code> sur GitHub, mettez à jour le <code>index.json</code>, et push.</div>
  <div id="store-list"></div>
  <div id="store-load" class="empty" style="display:none"><div class="empty-i">📡</div>Chargement...</div>
</section>

<section class="s" id="s-workspace">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('more')">◀</button><div class="sh" style="margin:0">Workspace</div></div>
  <div class="ss2">"Any sufficiently advanced technology is indistinguishable from magic." — Arthur C. Clarke</div>

  <!-- IMPORT -->
  <div class="ws-panel">
    <div class="ws-head">📥 IMPORT</div>
    <div class="ws-desc">Importez des flashcards depuis n'importe quel format</div>
    <div class="drop-zone" id="drop-zone" role="button" tabindex="0" aria-label="Zone de dépôt de fichiers">
      <div class="dz-ico">📂</div>
      <div class="dz-txt">Glissez un fichier ici</div>
      <div class="dz-formats">CSV · Markdown · HTML · JSON · JSON-LD</div>
    </div>
    <div class="ws-formats">
      <div class="ws-fmt" onclick="$('imp-csv').click()"><div class="ws-fmt-ico">📊</div><div class="ws-fmt-t">CSV</div><div class="ws-fmt-d">Q;A ou Q,A</div></div>
      <div class="ws-fmt" onclick="$('imp-md').click()"><div class="ws-fmt-ico">📝</div><div class="ws-fmt-t">Markdown</div><div class="ws-fmt-d">## / **Q** → R</div></div>
      <div class="ws-fmt" onclick="$('imp-html').click()"><div class="ws-fmt-ico">🌐</div><div class="ws-fmt-t">HTML</div><div class="ws-fmt-d">&lt;table&gt; / &lt;dl&gt;</div></div>
      <div class="ws-fmt" onclick="$('imp-json2').click()"><div class="ws-fmt-ico">{ }</div><div class="ws-fmt-t">JSON</div><div class="ws-fmt-d">COGWAR / Anki</div></div>
      <div class="ws-fmt" onclick="$('imp-jsonld').click()"><div class="ws-fmt-ico">🔗</div><div class="ws-fmt-t">JSON-LD</div><div class="ws-fmt-d">Schema.org FAQ</div></div>
    </div>
    <input type="file" id="imp-csv" accept=".csv,.tsv,.txt" style="display:none" onchange="wsImportCSV(event)">
    <input type="file" id="imp-md" accept=".md,.markdown,.txt" style="display:none" onchange="wsImportMD(event)">
    <input type="file" id="imp-html" accept=".html,.htm" style="display:none" onchange="wsImportHTML(event)">
    <input type="file" id="imp-json2" accept=".json" style="display:none" onchange="wsImportJSON(event)">
    <input type="file" id="imp-jsonld" accept=".json,.jsonld" style="display:none" onchange="wsImportJSONLD(event)">
    <div class="ws-tip">💡 CSV : séparateur auto-détecté (virgule, point-virgule, tab). Première ligne = en-tête ou première carte.</div>
  </div>

  <!-- EXPORT -->
  <div class="ws-panel">
    <div class="ws-head">📤 EXPORT</div>
    <div class="ws-desc">Exportez vos decks vers tous les formats</div>
    <div class="ws-row">
      <label class="ws-label">Deck</label>
      <select id="ws-exp-dk" class="ws-select"></select>
      <button class="ws-btn-all" onclick="wsExpAll()">📦 Tout</button>
    </div>
    <div class="ws-formats">
      <div class="ws-fmt exp" onclick="wsExport('csv')"><div class="ws-fmt-ico">📊</div><div class="ws-fmt-t">CSV</div><div class="ws-fmt-d">Tableur</div></div>
      <div class="ws-fmt exp" onclick="wsExport('md')"><div class="ws-fmt-ico">📝</div><div class="ws-fmt-t">Markdown</div><div class="ws-fmt-d">Obsidian/Notion</div></div>
      <div class="ws-fmt exp" onclick="wsExport('html')"><div class="ws-fmt-ico">🌐</div><div class="ws-fmt-t">HTML</div><div class="ws-fmt-d">Page autonome</div></div>
      <div class="ws-fmt exp" onclick="wsExport('json')"><div class="ws-fmt-ico">{ }</div><div class="ws-fmt-t">JSON</div><div class="ws-fmt-d">COGWAR natif</div></div>
      <div class="ws-fmt exp" onclick="wsExport('anki')"><div class="ws-fmt-ico">🗂</div><div class="ws-fmt-t">Anki</div><div class="ws-fmt-d">Tab-separated</div></div>
    </div>
  </div>

  <!-- SEMANTIC WEB -->
  <div class="ws-panel">
    <div class="ws-head">🔗 WEB SÉMANTIQUE & GEO</div>
    <div class="ws-desc">Générez des exports optimisés moteurs de recherche & IA</div>
    <div class="ws-formats">
      <div class="ws-fmt geo" onclick="wsExport('jsonld')"><div class="ws-fmt-ico">🏗</div><div class="ws-fmt-t">JSON-LD</div><div class="ws-fmt-d">Schema.org FAQPage</div></div>
      <div class="ws-fmt geo" onclick="wsExport('geo-html')"><div class="ws-fmt-ico">🤖</div><div class="ws-fmt-t">GEO Page</div><div class="ws-fmt-d">HTML + meta + structured</div></div>
      <div class="ws-fmt geo" onclick="wsExport('rdf')"><div class="ws-fmt-ico">🌍</div><div class="ws-fmt-t">RDF/Turtle</div><div class="ws-fmt-d">Web sémantique natif</div></div>
      <div class="ws-fmt geo" onclick="wsExport('sitemap')"><div class="ws-fmt-ico">🗺</div><div class="ws-fmt-t">Sitemap</div><div class="ws-fmt-d">XML sitemap decks</div></div>
      <div class="ws-fmt geo" onclick="wsExport('opengraph')"><div class="ws-fmt-ico">📱</div><div class="ws-fmt-t">OpenGraph</div><div class="ws-fmt-d">Partage social</div></div>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="ws-panel" id="ws-preview-panel" style="display:none">
    <div class="ws-head">👁 PRÉVISUALISATION</div>
    <div class="ws-preview-bar">
      <span id="ws-prev-info"></span>
      <button class="ws-btn-dl" id="ws-prev-dl" onclick="wsDownloadPreview()">⬇ Télécharger</button>
      <button class="ws-btn-cp" onclick="wsClipPreview()">📋 Copier</button>
    </div>
    <pre class="ws-preview" id="ws-preview"></pre>
  </div>

  <div class="qt" style="margin-top:12px">« L'interopérabilité est la souveraineté numérique. »<cite>— Tim Berners-Lee (paraphrasé)</cite></div>
</section>

<section class="s" id="s-profile">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('home')">◀</button><div class="sh" style="margin:0">Dossier Agent</div></div><div class="ss2">"Who are you?" — The Caterpillar // "I am the One." — Neo</div>

  <!-- Character Card -->
  <div class="char-card" id="char-card">
    <div class="char-top">
      <div class="char-photo-wrap" id="photo-wrap" onclick="$('photo-in').click()">
        <span class="ph-placeholder" id="ph-ph">📷</span>
        <img id="ph-img" style="display:none">
        <div class="ph-edit">UPLOAD</div>
      </div>
      <input type="file" id="photo-in" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      <div class="char-id">
        <div class="char-class" id="ch-class">RECRUE</div>
        <div class="char-name"><span id="ch-name">OPÉRATEUR</span><span class="glitch" id="ch-glitch">OPÉRATEUR</span></div>
        <div class="char-title" id="ch-title">Résistant cognitif en formation</div>
        <div class="char-serial" id="ch-serial">WOPR-0000 · COGWAR DIVISION</div>
        <div class="char-lv-badge">
          <div class="char-lv-ring" id="ch-lv">1</div>
          <div class="char-xp-mini">
            <div class="char-xp-label">XP VERS NIVEAU <span id="ch-nxlv">2</span></div>
            <div class="char-xp-bar"><div class="char-xp-fill" id="ch-xpf"></div></div>
            <div class="char-xp-txt"><span id="ch-xp">0</span> / <span id="ch-xpmax">100</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Core Stats -->
    <div class="char-stats">
      <div class="cs"><div class="cs-v" id="cs-cog">0</div><div class="cs-l">COGNITION</div><div class="cs-bar"><div class="cs-bar-f" id="csb-cog" style="width:0%;background:var(--g1)"></div></div></div>
      <div class="cs"><div class="cs-v am" id="cs-res">0</div><div class="cs-l">RÉSILIENCE</div><div class="cs-bar"><div class="cs-bar-f" id="csb-res" style="width:0%;background:var(--am)"></div></div></div>
      <div class="cs"><div class="cs-v l" id="cs-cri">0</div><div class="cs-l">ESPRIT CRITIQUE</div><div class="cs-bar"><div class="cs-bar-f" id="csb-cri" style="width:0%;background:var(--l1)"></div></div></div>
      <div class="cs"><div class="cs-v wm" id="cs-pre">0%</div><div class="cs-l">PRÉCISION</div><div class="cs-bar"><div class="cs-bar-f" id="csb-pre" style="width:0%;background:var(--wm)"></div></div></div>
      <div class="cs"><div class="cs-v rd" id="cs-str">0</div><div class="cs-l">STREAK MAX</div><div class="cs-bar"><div class="cs-bar-f" id="csb-str" style="width:0%;background:var(--rd)"></div></div></div>
      <div class="cs"><div class="cs-v" id="cs-ses">0</div><div class="cs-l">SESSIONS</div><div class="cs-bar"><div class="cs-bar-f" id="csb-ses" style="width:0%;background:var(--g1)"></div></div></div>
    </div>

    <!-- Augmentations -->
    <div class="char-augs">
      <div class="aug-label">AUGMENTATIONS COGNITIVES</div>
      <div class="aug-grid" id="aug-grid"></div>
    </div>
  </div>

  <!-- Identity -->
  <div class="setting-group">
    <div class="fl" style="margin-bottom:6px">IDENTITÉ</div>
    <div class="fg"><label class="fl">INDICATIF</label><input class="fin" id="set-name" placeholder="Votre indicatif" maxlength="24" oninput="saveProfile()"></div>
    <div class="fg"><label class="fl">TITRE / BIO</label><input class="fin" id="set-bio" placeholder="Votre titre..." maxlength="48" oninput="saveProfile()"></div>
    <div class="fg"><label class="fl">AVATAR EMOJI (sans photo)</label>
    <div class="emoji-grid" id="emoji-grid"></div></div>
  </div>

  <!-- Photo Filters -->
  <div class="setting-group" id="photo-settings" style="display:none">
    <div class="fl" style="margin-bottom:6px">FILTRE PHOTO</div>
    <div class="photo-filters" id="pf-btns"></div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <button class="tbtn danger" onclick="clearPhoto()">✕ Supprimer photo</button>
    </div>
  </div>

  <!-- Interface -->
  <div class="setting-group">
    <div class="fl" style="margin-bottom:6px">INTERFACE</div>
    <div class="setting-row"><div><div class="setting-label">Taille texte</div></div><div class="range-wrap"><input type="range" min="11" max="18" value="13" id="set-fs" oninput="applyFS()"><div class="range-val" id="set-fs-val">13</div></div></div>
    <div class="setting-row"><div><div class="setting-label">Vitesse flip</div></div><div class="range-wrap"><input type="range" min="1" max="8" value="4" id="set-flip" oninput="applyFlip()"><div class="range-val" id="set-flip-val">4</div></div></div>
    <div class="setting-row"><div><div class="setting-label">Mode compact</div></div><div class="toggle" id="set-compact" onclick="toggleSet('compact')"></div></div>
    <div class="setting-row"><div><div class="setting-label">Scanlines CRT</div></div><div class="toggle on" id="set-scan" onclick="toggleSet('scan')"></div></div>
  </div>

  <!-- Attention Economy -->
  <div class="setting-group">
    <div class="fl" style="margin-bottom:6px">⚠️ ÉCONOMIE DE L'ATTENTION — KILLSWITCH</div>
    <div class="setting-row"><div><div class="setting-label">Disclaimers (boutons !)</div><div class="setting-sub">Révèle les techniques toxiques</div></div><div class="toggle on" id="set-disc" onclick="toggleSet('disc')"></div></div>
    <div class="setting-row"><div><div class="setting-label">Notification dot</div><div class="setting-sub">Interruption attentionnelle</div></div><div class="toggle on" id="set-notif" onclick="toggleSet('notif')"></div></div>
    <div class="setting-row"><div><div class="setting-label">Preuve sociale</div><div class="setting-sub">Compteur fabriqué</div></div><div class="toggle on" id="set-sp" onclick="toggleSet('sp')"></div></div>
    <div class="setting-row"><div><div class="setting-label">Combo × dopamine</div><div class="setting-sub">Boucle de renforcement</div></div><div class="toggle on" id="set-combo" onclick="toggleSet('combo')"></div></div>
    <div class="setting-row"><div><div class="setting-label">Loot boxes</div><div class="setting-sub">Ratio variable (Skinner)</div></div><div class="toggle on" id="set-loot" onclick="toggleSet('loot')"></div></div>
  </div>
  <div class="qt">Chaque mécanique est documentée dans l'encyclopédie. Vous pouvez toutes les couper — <strong style="color:var(--rd)">ce que les apps classiques ne vous permettent jamais.</strong><cite>— COGWAR // La transparence est un acte de résistance</cite></div>
</section>

<section class="s" id="s-more">
  <div class="sh">Menu</div><div class="ss2">"Do you want to play a game?" — Joshua / WOPR</div>
  <div class="menu-grid">
    <div class="menu-item" onclick="go('profile')"><div class="mi-ico">🤖</div><div class="mi-label">Dossier Agent</div><div class="mi-desc">Fiche · Photo · Augmentations</div></div>
    <div class="menu-item" onclick="go('ency')"><div class="mi-ico">◈</div><div class="mi-label">Encyclopédie</div><div class="mi-desc">30 entrées sourcées</div></div>
    <div class="menu-item" onclick="go('ach')"><div class="mi-ico">★</div><div class="mi-label">Achievements</div><div class="mi-desc" id="ach-count">0 débloqués</div></div>
    <div class="menu-item" onclick="go('console')"><div class="mi-ico">⌨</div><div class="mi-label">Console WOPR</div><div class="mi-desc">Terminal hacker</div></div>
    <div class="menu-item" onclick="openSearch()"><div class="mi-ico">🔍</div><div class="mi-label">Recherche</div><div class="mi-desc">Ctrl+K / Global</div></div>
    <div class="menu-item" onclick="go('lib')"><div class="mi-ico">◧</div><div class="mi-label">Bibliothèque</div><div class="mi-desc">Créer · Éditer · Exporter</div></div>
    <div class="menu-item" onclick="go('store')"><div class="mi-ico">⬢</div><div class="mi-label">Store</div><div class="mi-desc">Decks & Encyclopédie</div></div>
    <div class="menu-item" onclick="go('play')"><div class="mi-ico">⚡</div><div class="mi-label">Jouer</div><div class="mi-desc">Session flashcards</div></div>
    <div class="menu-item" onclick="go('workspace')"><div class="mi-ico">🔄</div><div class="mi-label">Workspace</div><div class="mi-desc">Import · Export · Sémantique</div></div>
    <div class="menu-item" onclick="go('stats')"><div class="mi-ico">📊</div><div class="mi-label">Stats</div><div class="mi-desc">Dashboard · SM-2 · Heatmap</div></div>
  </div>
  <div class="menu-section-title">⚙ Réglages rapides</div>
  <div class="menu-toggles">
    <label class="mt-row"><span>Thème</span><select class="mt-sel" onchange="setT(this.value)"><option value="dark">Dark</option><option value="80s">80s Neon</option><option value="disco">Disco</option></select></label>
    <label class="mt-row"><span>Scanlines CRT</span><input type="checkbox" id="mt-scan" onchange="PROF.settings.scan=this.checked;applySettings();svProf()"></label>
    <label class="mt-row"><span>Mode compact</span><input type="checkbox" id="mt-compact" onchange="PROF.settings.compact=this.checked;applySettings();svProf()"></label>
  </div>
  <div class="qt" style="margin-top:14px">« Comprendre est le premier acte de résistance. »<cite>— Manifeste du Prolotariat</cite></div>
  <div style="font-size:9px;color:var(--t3);margin-top:10px">Fork · Hack · Spread · CC BY-NC 4.0<br><em style="color:var(--ld)">« I Amar Prestar Aen »</em></div>
</section>

<section class="s" id="s-ency">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('more')">◀</button><div class="sh" style="margin:0">Encyclopédie</div></div>
  <div class="esw"><input type="text" class="esr" id="esr" placeholder="Rechercher..." oninput="fltE()"></div>
  <div class="etg" id="etg"></div><div class="eg" id="eg"></div>
</section>

<section class="s" id="s-console">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('more')">◀</button><div class="sh" style="margin:0">Console WOPR</div></div><div class="ss2">"A STRANGE GAME. THE ONLY WINNING MOVE IS NOT TO PLAY." — Joshua</div>
  <div class="console-wrap">
    <div class="console-bar">
      <div class="console-dots"><div class="console-dot r"></div><div class="console-dot y"></div><div class="console-dot g"></div></div>
      <div class="console-title">wopr@cogwar:~</div>
    </div>
    <div class="console-body" id="con-out"></div>
    <div class="console-input-row">
      <span class="console-prompt">wopr&gt;</span>
      <input class="console-in" id="con-in" placeholder="help" onkeydown="if(event.key==='Enter')conExec()" autocomplete="off" spellcheck="false">
    </div>
  </div>
</section>

<section class="s" id="s-ach">
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><button class="bi" onclick="go('more')">◀</button><div class="sh" style="margin:0">Achievements</div></div>
  <div class="ag" id="ag"></div>
</section>

<footer class="ft">COGWAR // WOPR ULTIMATE // 235 cartes · 30 entrées · Store · Console</footer>
</main>

<!-- Search FAB -->
<div class="search-fab" onclick="openSearch()">🔍</div>

<!-- Search Overlay -->
<div class="search-overlay" id="search-ov">
  <div class="search-top">
    <input class="search-input" id="search-in" placeholder="Rechercher cartes, encyclopédie, decks..." oninput="doSearch()" autocomplete="off" autofocus>
    <button class="search-close" onclick="closeSearch()">✕</button>
  </div>
  <div class="search-filters">
    <div class="sf-btn on" data-sf="all" onclick="setSF('all',this)">Tout</div>
    <div class="sf-btn" data-sf="cards" onclick="setSF('cards',this)">Flashcards</div>
    <div class="sf-btn" data-sf="ency" onclick="setSF('ency',this)">Encyclopédie</div>
    <div class="sf-btn" data-sf="decks" onclick="setSF('decks',this)">Decks</div>
  </div>
  <div class="sr-count" id="sr-count"></div>
  <div class="search-results" id="sr-list">
    <div class="sr-empty"><div class="sr-e-ico">🔍</div>Tapez pour rechercher dans tout COGWAR</div>
  </div>
</div>
<nav class="bn" role="navigation" aria-label="Navigation principale"><button class="nb on" data-s="home" onclick="go('home',this)" aria-label="Accueil"><span class="ic">⬡</span>HOME</button><button class="nb" data-s="play" onclick="go('play',this)" aria-label="Jouer"><span class="ic">⚡</span>PLAY</button><button class="nb" data-s="lib" onclick="go('lib',this)" aria-label="Bibliothèque"><span class="ic">◧</span>DECKS</button><button class="nb" data-s="store" onclick="go('store',this)" aria-label="Store"><span class="ic">⬢</span>STORE</button><button class="nb" data-s="more" onclick="go('more',this)" aria-label="Menu"><span class="ic">☰</span>MENU</button><button class="nb" data-s="profile" onclick="go('profile',this)" aria-label="Profil"><span class="ic">👤</span>PROFIL</button></nav>
</div>

<!-- Modals -->
<div class="mo" id="mo-dk"><div class="mo-in"><div class="mo-hd"><div class="mo-t" id="mdk-t">✏️ Nouveau Deck</div><button class="mo-x" onclick="cmo('mo-dk')">✕</button></div><div class="mo-bd">
  <div class="fg"><label class="fl">NOM DU DECK</label><input class="fin" id="dk-n" placeholder="Ex: Biais Cognitifs"></div>
  <div class="fg"><label class="fl">ICÔNE (emoji)</label><input class="fin" id="dk-i" placeholder="🧠" maxlength="4" style="width:60px"></div>
  <div class="fg"><label class="fl">DIFFICULTÉ</label><select class="fin" id="dk-d"><option value="1">🟢 Initiation</option><option value="2">🟠 Intermédiaire</option><option value="3">🔴 Expert</option></select></div>
  <div class="fg"><label class="fl">DESCRIPTION</label><textarea class="fin" id="dk-desc" rows="2" placeholder="Décrivez le contenu..."></textarea></div>
  <div class="fg"><label class="fl">TAGS (séparés par des virgules)</label><input class="fin" id="dk-tg" placeholder="guerre-cognitive, niveau-1"></div>
  <div style="display:flex;gap:8px;margin-top:16px"><button class="tbtn" onclick="saveDk()" style="font-size:11px;padding:10px 24px">💾 Sauvegarder</button><button class="tbtn sec" onclick="cmo('mo-dk')" style="font-size:11px;padding:10px 24px">Annuler</button></div>
</div></div></div>

<div class="mo" id="mo-cd"><div class="mo-in"><div class="mo-hd"><div class="mo-t" id="mcd-t">🃏 Cartes</div><button class="mo-x" onclick="cmo('mo-cd')">✕</button></div><div class="mo-bd">
  <div class="toolbar"><button class="tbtn" onclick="cardForm()" style="font-size:10px;padding:8px 16px">+ Nouvelle Carte</button><button class="tbtn sec" onclick="expDk()" style="font-size:10px;padding:8px 16px">⬇ Exporter Deck</button></div>
  <div id="cd-list"></div>
  <div id="cd-empty" class="empty" style="display:none"><div class="empty-i">🃏</div>Aucune carte dans ce deck.<br>Ajoutez-en avec le bouton ci-dessus.</div>
</div></div></div>

<div class="mo" id="mo-cf"><div class="mo-in"><div class="mo-hd"><div class="mo-t" id="mcf-t">✏️ Nouvelle Carte</div><button class="mo-x" onclick="cmo('mo-cf')">✕</button></div><div class="mo-bd">
  <div class="fg"><label class="fl">QUESTION</label><textarea class="fin" id="cf-q" rows="4" placeholder="Tapez votre question ici..."></textarea></div>
  <div class="fg"><label class="fl">RÉPONSE</label><textarea class="fin" id="cf-a" rows="4" placeholder="Tapez la réponse ici..."></textarea></div>
  <div style="display:flex;gap:8px;margin-top:16px"><button class="tbtn" onclick="saveCd()" style="font-size:11px;padding:10px 24px">💾 Sauvegarder</button><button class="tbtn sec" onclick="cmo('mo-cf')" style="font-size:11px;padding:10px 24px">Annuler</button></div>
</div></div></div>

<div class="mo" id="mo-en"><div class="mo-in"><div class="mo-hd"><div class="mo-t" id="me-t"></div><button class="mo-x" onclick="cmo('mo-en')">✕</button></div><div class="mo-bd emo" id="me-bd"></div><div class="emo-ft"><div style="display:flex;gap:4px"><button class="bi" onclick="meP()">◀</button><button class="bi" onclick="meN()">▶</button></div><button class="tbtn" id="me-cl" onclick="meC()">+25 XP</button></div></div></div>

<div class="combo-overlay" id="combo-ov"></div>

<div class="tc" id="tc"></div>
<script>
const BUILTIN_DECKS = [{"id": "gc-fondamentaux", "name": "Guerre Cognitive — Fondamentaux", "author": "COGWAR", "difficulty": 1, "icon": "🧠", "description": "Concepts fondamentaux de la guerre cognitive : définitions, acteurs, mécanismes de base.", "tags": ["guerre-cognitive", "niveau-1"], "version": 1, "cards": [{"q": "Quel est le concept désignant l'esprit humain comme le nouveau champ de bataille du XXIe siècle ?", "a": "Le sixième domaine de la guerre (ou domaine cognitif)."}, {"q": "Quelle est la cible principale de la guerre de l'information par rapport à la guerre cognitive ?", "a": "L'information cible le flux de données, tandis que la cognitive cible le traitement de ces données."}, {"q": "Quel objectif l'OTAN a-t-elle défini dans son 'Innovation Hub' pour protéger les processus démocratiques ?", "a": "La supériorité cognitive (Cognitive Superiority)."}, {"q": "L'approche russe de la guerre cognitive privilégie la _____ pour paralyser la volonté politique adverse.", "a": "désinformation systématique"}, {"q": "Quelle puissance géopolitique s'oriente vers une 'guerre cognitive algorithmique' utilisant l'IA ?", "a": "La Chine."}, {"q": "Quel est l'effet de la 'stimulation répétée' sur le cerveau lors du traitement d'une information fausse ?", "a": "Elle réduit le coût psychologique du traitement, facilitant son acceptation subconsciente."}, {"q": "Comment appelle-t-on le signal envoyé par le cerveau lorsqu'une information contredit des croyances profondes ?", "a": "Le signal d'erreur."}, {"q": "Quel organe cérébral est privilégié par les narratifs émotionnels au détriment du cortex préfrontal ?", "a": "L'amygdale."}, {"q": "Quel est l'objectif d'un 'stratège du chaos' concernant les dirigeants politiques adverses ?", "a": "Les convaincre qu'aucune solution stable ou état final n'est possible."}, {"q": "Le phénomène où les individus rejettent toute information contredisant leur narratif de groupe est la _____.", "a": "fermeture épistémique"}, {"q": "Dans le modèle chinois en six étapes, que signifie le 'Portrait de l'utilisateur' ?", "a": "L'identification des cibles et l'analyse de leur état psychologique par le Big Data."}, {"q": "Quelle est la quatrième étape du modèle de manipulation chinois ?", "a": "L'induction de réaction (enfermement dans des chambres d'écho)."}, {"q": "Quel est le moteur principal de polarisation dans les plateformes numériques selon le texte ?", "a": "Les algorithmes de recommandation."}, {"q": "Selon l'analogie de la théorie du chaos, qu'est-ce que l'effet papillon appliqué à l'information ?", "a": "Une simple rumeur injectée au bon moment peut déclencher une crise nationale."}, {"q": "Dans l'attracteur de Lorenz appliqué à la cognition, que représente le paramètre $\\rho$ ?", "a": "Le niveau de méfiance publique."}, {"q": "Dans l'attracteur de Lorenz appliqué à la cognition, que représente le paramètre $\\sigma$ ?", "a": "La vélocité de l'information."}, {"q": "Quel est le cadre de référence pour la prise de décision militaire visé par la guerre cognitive ?", "a": "La boucle OODA (Observation, Orientation, Décision, Action)."}, {"q": "Selon Dave Snowden, dans quel état d'environnement la boucle OODA s'effondre-t-elle ?", "a": "L'état chaotique (pas de relation cause-effet visible)."}, {"q": "Dans le modèle SIR appliqué aux rumeurs, que représente la catégorie 'P' ?", "a": "Les Propagateurs."}, {"q": "Dans le modèle SIR appliqué aux rumeurs, que représente la catégorie 'E' ?", "a": "Les Étouffeurs (individus ayant cessé de diffuser l'information)."}, {"q": "Quelle est la formule du nombre de reproduction de base $R_0$ pour une rumeur ?", "a": "$R_0 = \\frac{\\beta N}{\\alpha + \\gamma + \\mu}$"}, {"q": "Que représente le paramètre $\\beta$ dans le modèle de propagation d'une rumeur ?", "a": "Le taux de transmission (virilité de l'information)."}, {"q": "Que représente le paramètre $\\gamma$ dans le modèle de propagation d'une rumeur ?", "a": "Le taux de récupération suite à une vérification des faits (fact-checking)."}, {"q": "Quel paramètre induit une instabilité chaotique dans la propagation s'il représente le temps de réflexion ?", "a": "Le délai temporel (noté $\\tau$)."}, {"q": "Comment appelle-t-on la capacité d'un système à maintenir l'initiative et à s'adapter pendant une perturbation ?", "a": "La résilience dynamique (ou opérationnelle)."}, {"q": "Concept : Graceful Extensibility", "a": "Définition : Capacité d'un système à étendre ses réponses au-delà de ses limites normales sous pression."}, {"q": "Quelle stratégie consiste à engager les adversaires dans leurs propres réseaux avant qu'ils n'attaquent ?", "a": "La défense avancée (Defend Forward)."}, {"q": "Quel est le pilier de défense cognitive à long terme basé sur la sensibilisation aux biais ?", "a": "L'immunisation mentale (ou éducation)."}, {"q": "Dans la théorie de Miller, quels sont les deux types de dommages spécifiques à la guerre cognitive ?", "a": "Les dommages psychologiques aux humains et les dommages aux institutions."}, {"q": "Quelle théorie russe vise à amener l'adversaire à prendre une décision prédéterminée en croyant agir librement ?", "a": "La théorie du contrôle réflexif (Reflexive Control)."}, {"q": "Les 'Trois Warfares' de la doctrine chinoise incluent la guerre psychologique, la guerre de l'opinion et la _____.", "a": "guerre juridique"}, {"q": "Dans le modèle Cynefin, quel mécanisme correspond à un environnement 'Complexe' ?", "a": "Sonder - Percevoir - Répondre."}, {"q": "Quel est le danger du 'dilemme du prisonnier' appliqué à la censure d'État ?", "a": "Perdre la confiance de la population et la pousser vers des sources radicales."}, {"q": "Qu'est-ce que le 'MRT-C' dans le cadre de la sécurité nationale ?", "a": "Mission-Relevant Terrain in Cyberspace (infrastructures virtuelles critiques)."}, {"q": "Quel syndrome de 2016 illustre l'usage possible de technologies invasives contre le système nerveux ?", "a": "Le syndrome de La Havane."}, {"q": "Quel est l'objectif des 'Opérations basées sur les effets' (EBO) ?", "a": "Paralyser le leadership de l'intérieur en attaquant ses structures de commandement."}, {"q": "Comment l'IA transforme-t-elle la manipulation de l'information selon le texte ?", "a": "Elle transforme la manipulation artisanale en une industrie de précision personnalisée."}, {"q": "Quelle est l'équation fondamentale du risque de protection ?", "a": "$Risque = \\frac{Menace \\times Vulnérabilité}{Capacité}$"}, {"q": "Dans l'analyse de protection, quel facteur représente les ressources d'une communauté pour prévenir une menace ?", "a": "La Capacité."}, {"q": "Quelles étaient les motivations principales de la LRA en Ouganda pour le recrutement d'enfants ?", "a": "Croyances politiques et religieuses du chef (Kony)."}, {"q": "Exemple de 'Vulnérabilité' dans le cas du recrutement forcé d'enfants en Ouganda :", "a": "Le manque d'endroits où se cacher, particulièrement la nuit."}, {"q": "Quelle action de la part des familles ougandaises a augmenté leur 'Capacité' face aux enlèvements ?", "a": "L'envoi des enfants dans des villes éloignées (comme Kampala)."}, {"q": "Quel est l'impact de la guerre cognitive sur la 'personnalité cognitive' à long terme ?", "a": "Elle modifie durablement la manière dont un individu traite l'information."}, {"q": "Pourquoi les électeurs émotionnellement instables sont-ils plus vulnérables aux algorithmes ?", "a": "Ils sont plus réceptifs aux contenus surprenants et négatifs qui les poussent vers les extrêmes."}, {"q": "Le terme 'Neuro-guerre' est souvent associé à quelle génération de conflits ?", "a": "La sixième génération."}, {"q": "Quel organe de l'OTAN est spécifiquement chargé du concept de 'Warfighting Capstone Concept' ?", "a": "Le NATO Allied Command Transformation (ACT)."}, {"q": "Quelle est l'étape finale du modèle de manipulation chinois ?", "a": "La supervision de la gratification (renforcement de l'enfermement cognitif)."}, {"q": "Définition : Guerre Cognitive (selon le groupe Gecko)", "a": "Domaine cherchant à corrompre ou annihiler les mécanismes de pensée et de décision par une approche scientifique."}, {"q": "Dans la dynamique des réseaux, qu'est-ce que l'homophilie ?", "a": "La tendance des individus à se connecter à ceux qui partagent leurs croyances."}, {"q": "Quel outil mathématique permet de prédire si une rumeur va saturer une population ?", "a": "Le nombre de reproduction de base $R_0$."}, {"q": "Pourquoi le micro-ciblage psychographique est-il considéré comme le 'carburant' de la guerre algorithmique ?", "a": "Il permet de générer des messages exploitant les biais et peurs spécifiques d'un individu."}, {"q": "Quelle est la conséquence stratégique de la 'Weaponization of Identity' ?", "a": "L'érosion de l'unité nationale et l'exploitation des clivages identitaires."}, {"q": "Que signifie l'attribut 'Technology' dans la définition de la guerre cognitive ?", "a": "L'usage de moyens technologiques (IA, Big Data) pour amplifier les effets des attaques cognitives."}, {"q": "Quel type de résilience est défini comme 'l'adaptabilité soutenue' ?", "a": "La capacité à ajuster continuellement ses défenses à travers plusieurs cycles de stress."}, {"q": "Dans le cas de la LRA, quel mécanisme international a été mis en place pour surveiller les violations ?", "a": "Le mécanisme de surveillance et de communication de l'information (MRM) de l'ONU."}, {"q": "Quel est le risque systémique associé à une attaque réussie sur la 'confiance' publique ?", "a": "Une crise de liquidité ou un effondrement des services essentiels par effet domino."}, {"q": "Dans le modèle SIR, que représente le paramètre $\\mu$ ?", "a": "Le taux de sortie naturelle (ou perte d'intérêt) de la population."}, {"q": "Pourquoi est-il difficile de définir juridiquement un 'acte de guerre' cognitive ?", "a": "Parce qu'il s'agit de manipulations psychologiques se situant sous le seuil cinétique (zone grise)."}, {"q": "Quelle est l'implication stratégique de la 'souveraineté' dans le domaine neuro-cognitif ?", "a": "La défense de l'État ne se fait plus aux frontières physiques mais dans l'esprit des citoyens."}, {"q": "Le but de la 'Weaponization of Narratives' est d'altérer la perception de la _____ historique.", "a": "mémoire"}, {"q": "Quel est le rôle des 'Usines à trolls' dans la doctrine russe ?", "a": "Diffuser massivement des narratifs subversifs pour créer une paralysie politique chez l'adversaire."}, {"q": "En environnement 'Ordonné', quel est le mécanisme décisionnel approprié ?", "a": "Percevoir - Catégoriser - Répondre."}, {"q": "Comment la guerre cognitive impacte-t-elle l'étape d'Orientation de la boucle OODA ?", "a": "En biaisant la compréhension de la situation par des perceptions déformées."}, {"q": "Qu'est-ce qu'un 'cocon sémantique' ?", "a": "Un environnement informationnel fermé où l'individu n'est exposé qu'à des idées confirmant ses préjugés."}, {"q": "Quelle caractéristique de la société ouverte est considérée comme son 'talon d'Achille' par le stratège du chaos ?", "a": "La transparence et la liberté d'expression."}, {"q": "Dans le modèle de risque systémique, quelle étape suit le 'Choc' initial ?", "a": "L'Amplification (propagation rapide et perte de confiance)."}, {"q": "Quel est le but de la 'Supervision de la gratification' dans la manipulation IA ?", "a": "Utiliser les signaux sociaux (likes, partages) pour valider et renforcer le nouveau cadre de pensée."}, {"q": "Quel est le principal défi de la régulation des plateformes numériques face à la désinformation ?", "a": "Éviter de dériver vers une censure qui reproduirait les tactiques autoritaires."}, {"q": "L'incertitude induite par le stress cognitif pousse l'individu vers des réactions _____ plutôt que rationnelles.", "a": "émotionnelles"}, {"q": "Dans le modèle SIR, que se passe-t-il si $R_0 < 1$ ?", "a": "La propagation de la rumeur s'éteint naturellement."}, {"q": "Concept : Reflexive Control", "a": "Stratégie russe visant à influencer les perceptions de l'adversaire pour qu'il agisse volontairement contre ses propres intérêts."}, {"q": "Quel est le lien entre populisme et guerre cognitive selon le texte de l'OTAN ?", "a": "Le populisme peut être à la fois un symptôme de mécontentement et un résultat de succès d'attaques cognitives ennemies."}, {"q": "Pourquoi la 'littératie informationnelle' est-elle un facteur de protection ?", "a": "Elle permet aux citoyens d'identifier les manipulations et l'inauthenticité des sources."}, {"q": "Dans la gestion de crise de la LRA, quelle action a été menée par les chefs religieux ?", "a": "La négociation pour la libération des enfants de moins de 16 ans."}, {"q": "Quel est l'objectif des 'simulations cognitives' pour les décideurs ?", "a": "Les former à reconnaître les opérations d'influence et à réguler leurs émotions sous stress."}, {"q": "Comment l'IA générative est-elle utilisée dans l'étape 'Attraction de l'attention' ?", "a": "Pour créer des deepfakes ou articles qui déstabilisent le cadre cognitif existant de la cible."}, {"q": "Quel paramètre de l'équation de Lorenz représente la variation de la stabilité vers le chaos ?", "a": "Une variation infinitésimale de $\\sigma$, $\\rho$ ou $\\beta$."}, {"q": "La 'Mission-Relevant Terrain in Cyberspace' inclut des infrastructures qui peuvent être _____.", "a": "hors de contrôle gouvernemental (privées)"}, {"q": "Quel type de préjudice Miller associe-t-il spécifiquement aux institutions ?", "a": "L'érosion de la légitimité et de la confiance institutionnelle."}, {"q": "Terme : Cognitive Superiority", "a": "Impératif de l'OTAN visant à out-think l'adversaire en maîtrisant mieux l'environnement décisionnel."}], "source": "builtin"}, {"id": "gc-doctrines", "name": "Guerre Cognitive — Doctrines & Stratégies", "author": "COGWAR", "difficulty": 2, "icon": "🌍", "description": "Doctrines géopolitiques, modélisation mathématique et mécanismes avancés.", "tags": ["guerre-cognitive", "niveau-2"], "version": 1, "cards": [{"q": "Quel est le concept désignant l'esprit humain comme nouvel espace de conflictualité ?", "a": "Le \"sixième domaine de la guerre\"."}, {"q": "Quelle est la différence fondamentale entre la guerre de l'information et la guerre cognitive ?", "a": "L'information cible le flux de données, tandis que le cognitif cible la manière dont le cerveau traite ces données."}, {"q": "Selon l'OTAN, quel est l'objectif principal du \"Warfighting Capstone Concept\" de 2021 ?", "a": "Atteindre la \"supériorité cognitive\"."}, {"q": "Dans la doctrine russe, quel terme désigne la manipulation du processus de décision de l'adversaire ?", "a": "Le \"Reflexive Control\" (Contrôle réflexif)."}, {"q": "Quel pays privilégie la \"guerre cognitive algorithmique\" basée sur l'IA et le Big Data ?", "a": "La Chine."}, {"q": "Expliquez l'effet de la \"stimulation répétée\" sur le traitement cérébral d'une information fausse.", "a": "Elle réduit le coût psychologique du traitement, facilitant l'acceptation subconsciente de l'erreur."}, {"q": "Quel mécanisme neurobiologique la guerre cognitive sature-t-elle pour créer une incertitude permanente ?", "a": "Le \"signal d'erreur\"."}, {"q": "Dans le cadre de l'influence émotionnelle, quelle structure cérébrale est favorisée au détriment du cortex préfrontal ?", "a": "L'amygdale."}, {"q": "Quel est l'objectif ultime du \"stratège du chaos\" dans une guerre asymétrique ?", "a": "Convaincre les dirigeants adverses qu'aucun état final stable n'est possible."}, {"q": "Définissez le concept de \"fermeture épistémique\" dans les réseaux sociaux.", "a": "Le rejet systématique de toute information contredisant le narratif dominant du groupe."}, {"q": "Quelle est la première étape du modèle chinois en six étapes pour façonner la cognition ?", "a": "Le portrait de l'utilisateur via l'analyse psychologique par le Big Data."}, {"q": "Dans le modèle chinois, quel est le but de la \"supervision de la gratification\" ?", "a": "Renforcer l'enfermement dans un nouveau cadre cognitif via la mesure de la gratification sociale."}, {"q": "Quel est l'impact principal des algorithmes de recommandation sur la diversité d'opinion ?", "a": "Ils créent des \"chambres d'écho\" en limitant l'exposition aux points de vue divergents."}, {"q": "Selon la théorie du chaos, qu'est-ce que la \"sensibilité aux conditions initiales\" ?", "a": "Le fait que de petites perturbations (ex: rumeur) puissent entraîner des conséquences nationales disproportionnées."}, {"q": "Donnez l'équation de l'évolution de la variable $x$ dans l'attracteur de Lorenz.", "a": "$\\frac{dx}{dt} = \\sigma(y - x)$."}, {"q": "Quel paramètre de l'attracteur de Lorenz symbolise le niveau de méfiance publique en guerre cognitive ?", "a": "Le paramètre $\\rho$."}, {"q": "Quelles sont les quatre étapes de la boucle OODA ?", "a": "Observation, Orientation, Décision, Action."}, {"q": "Dans quel domaine du cadre de Snowden la boucle OODA s'effondre-t-elle ?", "a": "Dans les domaines \"complexe\" ou \"chaotique\"."}, {"q": "Dans le modèle épidémiologique SIR appliqué aux rumeurs, que signifie la catégorie 'E' ?", "a": "Les \"Étouffeurs\" (individus ayant cessé de diffuser l'information)."}, {"q": "Quelle est la formule du nombre de reproduction de base $R_0$ pour une rumeur ?", "a": "$R_0 = \\frac{\\beta N}{\\alpha + \\gamma + \\mu}$."}, {"q": "Que représente le paramètre $\\beta$ dans le modèle de propagation des rumeurs ?", "a": "Le taux de transmission ou la viralité de l'information."}, {"q": "Quel est l'effet de l'introduction d'un délai temporel $\\tau$ dans les modèles de propagation ?", "a": "Il peut induire des oscillations chaotiques et des résurgences brutales de rumeurs."}, {"q": "Définissez la \"résilience dynamique\" (ou opérationnelle).", "a": "La capacité de combattre à travers la perturbation et de maintenir l'initiative sous stress."}, {"q": "Qu'est-ce que l'\"extensibilité gracieuse\" (Graceful Extensibility) ?", "a": "La capacité d'un système à étendre ses capacités de réponse au-delà de ses limites normales."}, {"q": "Quel terme désigne les infrastructures virtuelles critiques hors contrôle gouvernemental ?", "a": "La \"Mission-Relevant Terrain in Cyberspace\" (MRT-C)."}, {"q": "En quoi consiste la stratégie de \"défense avancée\" (Defend Forward) ?", "a": "Engager l'adversaire dans ses propres réseaux pour perturber ses capacités avant l'attaque."}, {"q": "Quel est le dilemme du prisonnier appliqué à la censure d'État ?", "a": "Une restriction excessive peut entraîner la perte de confiance et pousser la population vers la propagande radicale."}, {"q": "Comment Bernard Claverie définit-il les sciences cognitives \"dures\" ?", "a": "Des disciplines non interprétatives qui étudient la pensée comme un objet matériel (neurosciences, IA, etc.)."}, {"q": "Qu'est-ce que le \"syndrome de La Havane\" ?", "a": "Des symptômes incapacitants suspects chez des diplomates, attribués à des rayonnements ciblant le système nerveux."}, {"q": "Quel est l'objectif du projet Gecko ?", "a": "Développer des dispositifs d'exploration de la guerre cognitive via des crises fictives."}, {"q": "Dans l'équation du risque de protection, quels sont les trois facteurs déterminants ?", "a": "Les Menaces, les Vulnérabilités et les Capacités."}, {"q": "Équation : Risque de protection", "a": "$Risque = \\frac{Menaces \\times Vuln\\acute{e}rabilit\\acute{e}s}{Capacit\\acute{e}}$."}, {"q": "Quelle est la différence entre un vecteur traditionnel et un vecteur technologique existant ?", "a": "Le traditionnel utilise les médias de masse (presse, TV), l'existant utilise les réseaux sociaux et le Big Data."}, {"q": "Citez deux exemples de vecteurs technologiques \"émergents\" en guerre cognitive.", "a": "Les Deepfakes (médias synthétiques) et les neuro-armes."}, {"q": "Quels sont les trois déclencheurs (triggers) de vulnérabilité individuelle à la manipulation ?", "a": "L'inflexibilité cognitive, le besoin d'appartenance sociale et l'excitation émotionnelle."}, {"q": "Comment l'adversaire \"militarise-t-il\" l'identité (Weaponize Identity) ?", "a": "En exploitant les affiliations culturelles ou nationales pour cibler des groupes spécifiques."}, {"q": "Quel rôle joue la \"mémoire historique\" dans la guerre cognitive ?", "a": "Elle sert de base à la création de narratifs manipulés pour modifier la perception de soi des nations."}, {"q": "Quelle est la définition de la \"menace\" dans l'analyse de protection ?", "a": "Une force externe (autorité, groupe armé) motivée par des facteurs politiques ou économiques."}, {"q": "Donnez un exemple de \"mécanisme d'adaptation\" communautaire face à une menace.", "a": "L'envoi d'enfants vers des villes sûres ou la négociation par des chefs religieux."}, {"q": "Quel est le but des \"pare-feu cognitifs\" ?", "a": "Identifier et bloquer les manipulations algorithmiques en temps réel au niveau étatique."}, {"q": "Dans le cadre de l'analyse de l'OTAN, qu'est-ce que la \"6-Outs\" ?", "a": "Un ensemble de fonctions (out-think, out-fight, etc.) pour maintenir l'avantage militaire."}, {"q": "Définition : Guerre hybride (selon Hung & Hung)", "a": "Un cadre global où la guerre cognitive est une composante subordonnée axée sur les effets mentaux."}, {"q": "Quelle est la caractéristique majeure de la \"zone grise\" de conflictualité ?", "a": "Elle se situe sous le seuil de l'agression militaire directe et de la légalité internationale."}, {"q": "Pourquoi la \"fermeture épistémique\" rend-elle une société ingouvernable ?", "a": "Parce qu'elle empêche tout consensus basé sur des faits rationnels partagés."}, {"q": "Quel est le rôle de l'IA générative dans l'étape d'attraction de l'attention ?", "a": "Créer des contenus qui désarçonnent le cadre cognitif existant de la cible."}, {"q": "Selon Dave Snowden, quelle action doit-on privilégier dans un environnement \"chaotique\" ?", "a": "Agir - Percevoir - Répondre."}, {"q": "Dans le cadre SIR, que se passe-t-il si $R_0 > 1$ ?", "a": "La rumeur se propage de manière exponentielle au sein de la population."}, {"q": "Définissez l'\"homophilie de réseau\".", "a": "La tendance des individus à se connecter uniquement à ceux qui partagent leurs croyances."}, {"q": "Quel est le risque lié aux \"systèmes hérités\" (legacy systems) en période de crise systémique ?", "a": "Ils sont souvent mal protégés et exacerbent la vulnérabilité globale de l'État."}, {"q": "Pourquoi l'éducation est-elle considérée comme une \"immunisation mentale\" ?", "a": "Elle sensibilise aux biais cognitifs et aux techniques de manipulation, renforçant la résilience à long terme."}, {"q": "L'analyse intégrée suggère que la victoire appartiendra à celui qui saura le mieux _____", "a": "Naviguer et orchestrer le chaos."}, {"q": "Citez une différence entre la conception de la CW par Miller et celle de l'OTAN.", "a": "Miller la voit sous le seuil de la guerre conventionnelle, tandis que l'OTAN y inclut des activités cinétiques."}, {"q": "Qu'est-ce que la \"domination cognitive\" dans la doctrine chinoise ?", "a": "Le contrôle des croyances et la reconfiguration des matrices de sens de l'adversaire."}, {"q": "Quel est l'effet des \"contagions cognitives\" sur les réseaux sociaux ?", "a": "Elles propagent des idéologies chargées d'émotions de manière virale pour polariser la société."}, {"q": "Dans le cadre de Snowden, quel mécanisme est adapté à un environnement \"ordonné/simple\" ?", "a": "Percevoir - Catégoriser - Répondre."}, {"q": "Pourquoi le micro-ciblage psychographique est-il plus efficace que le marketing traditionnel ?", "a": "Il exploite les peurs et biais spécifiques de chaque individu grâce aux données massives."}, {"q": "L'\"effet papillon\" appliqué à l'information signifie qu'une rumeur peut déclencher _____", "a": "Une réaction en chaîne aboutissant à une crise nationale."}, {"q": "Quel est le danger de la \"saturation par le volume de données\" sur la décision ?", "a": "Elle paralyse le décideur en rendant l'analyse impossible (environnement compliqué)."}, {"q": "Comment l'agresseur utilise-t-il le \"cocon sémantique\" ?", "a": "En enfermant l'individu dans un flux d'informations qui confirme uniquement ses préjugés."}, {"q": "Qu'est-ce qu'une opération cognitive \"à bas bruit\" ?", "a": "Une opération sur le temps long modifiant les habitudes de pensée de manière quasi-irréversible."}, {"q": "Quel est le rôle des \"usines à trolls\" dans la stratégie russe ?", "a": "Diffuser massivement de la désinformation pour attiser les divisions internes."}, {"q": "Pourquoi la transparence des sociétés démocratiques est-elle un \"talon d'Achille\" ?", "a": "Elle offre une surface d'attaque maximale pour l'injection de désordre et de paralysie."}, {"q": "Le modèle épidémiologique de rumeur divise la population en : I (Ignorants), P (Propagateurs) et _____", "a": "E (Étouffeurs)."}, {"q": "Qu'implique la \"perte de la souveraineté cognitive\" d'un État ?", "a": "L'incapacité à protéger l'esprit de ses citoyens contre des influences étrangères hostiles."}, {"q": "Quel est le lien entre instabilité émotionnelle et réceptivité algorithmique ?", "a": "L'instabilité augmente la réceptivité aux contenus négatifs, poussant vers les extrêmes politiques."}, {"q": "Dans la théorie des systèmes, que provoque la neutralisation d'un nœud critique ?", "a": "Un effondrement de la rétroaction et une chute de la structure entière par effet domino."}, {"q": "Quelle est la fonction du paramètre $\\sigma$ dans l'attracteur de Lorenz appliqué à l'information ?", "a": "La vélocité de l'information."}, {"q": "Comment définit-on un \"risque systémique global\" lié au cyber ?", "a": "Un incident dont l'amplification par les réseaux menace la stabilité de l'État ou des finances."}, {"q": "Quel est l'objectif des simulations cognitives pour les décideurs ?", "a": "Apprendre à maintenir leur régulation émotionnelle sous stress et reconnaître les manipulations."}, {"q": "La guerre cognitive vise à altérer non seulement ce que les gens pensent, mais aussi _____", "a": "La façon dont ils pensent."}, {"q": "Quels types de narratifs la Russie utilise-t-elle en Afrique ?", "a": "Des narratifs historiques et conspirationnistes."}, {"q": "Dans le modèle SIR, que représente le paramètre $\\gamma$ ?", "a": "Le taux de récupération suite à une vérification des faits (fact-checking)."}, {"q": "Qu'est-ce qu'une bifurcation dans un système dynamique chaotique ?", "a": "Un basculement d'un état stable vers un comportement oscillatoire ou désordonné."}, {"q": "Quel est l'impératif de défense face à la menace MRT-C ?", "a": "Protéger les infrastructures virtuelles même si elles appartiennent au secteur privé."}, {"q": "Comment la manipulation des émotions court-circuite-t-elle la raison ?", "a": "En favorisant des comportements impulsifs et prévisibles via l'activation de l'amygdale."}, {"q": "Selon le document, la guerre cognitive est une transition vers la _____", "a": "Sixième génération de guerre ou neuro-guerre."}, {"q": "Pourquoi l'incertitude dégrade-t-elle la capacité de décision ?", "a": "Elle sature les capacités cognitives et pousse vers des réactions émotionnelles irrationnelles."}, {"q": "Définissez le concept de \"Reflexive Control\" ?", "a": "Transmettre des informations à l'adversaire pour qu'il prenne volontairement une décision prédéterminée par l'agresseur."}, {"q": "Quel est le danger des \"deepfakes\" dans la phase d'attraction ?", "a": "Ils créent une confusion immédiate en imitant parfaitement la réalité pour tromper les sens."}, {"q": "Quel est le rôle de la \"gratification sociale\" dans l'enfermement cognitif ?", "a": "Elle récompense l'adhésion au groupe, rendant la sortie du cadre cognitif psychologiquement coûteuse."}], "source": "builtin"}, {"id": "gc-expert", "name": "Guerre Cognitive — Expert", "author": "COGWAR", "difficulty": 3, "icon": "📐", "description": "Concepts expert : neurobiologie, modélisation du chaos, défense opérationnelle.", "tags": ["guerre-cognitive", "niveau-3"], "version": 1, "cards": [{"q": "Quel est le \"sixième domaine de la guerre\" apparu au XXIe siècle ?", "a": "Le cerveau ou l'esprit humain."}, {"q": "Quelle est la différence fondamentale entre la guerre de l'information et la guerre cognitive ?", "a": "L'information cible le flux de données, tandis que la cognition cible le traitement de ces données pour construire la réalité."}, {"q": "Quel concept l'OTAN a-t-elle désigné comme impératif de développement à long terme dans son concept de 2021 ?", "a": "La supériorité cognitive (Cognitive Superiority)."}, {"q": "Quelle est la cible principale de la doctrine russe en matière de guerre cognitive ?", "a": "La désinformation systématique pour diviser et paralyser la volonté politique adverse."}, {"q": "Sur quel outil technologique repose la guerre cognitive chinoise pour façonner les perceptions ?", "a": "L'intelligence artificielle et les algorithmes (guerre cognitive algorithmique)."}, {"q": "Dans la doctrine chinoise, quels sont les trois piliers de la \"Three Warfares\" ?", "a": "La guerre psychologique, la guerre de l'opinion publique et la guerre juridique."}, {"q": "Pourquoi le principe de \"stimulation répétée\" facilite-t-il l'acceptation d'une fausse information ?", "a": "Elle réduit le coût psychologique du traitement, facilitant l'acceptation subconsciente par le cerveau."}, {"q": "Quel mécanisme neurobiologique est activé lorsqu'une information contredit les croyances profondes d'un individu ?", "a": "Le signal d'erreur."}, {"q": "En guerre cognitive, quel organe limbique est privilégié par les narratifs émotionnels au détriment du cortex préfrontal ?", "a": "L'amygdale."}, {"q": "Quel est l'objectif d'un \"stratège du chaos\" envers les dirigeants politiques adverses ?", "a": "Les convaincre qu'aucune solution claire ou état final stable n'est possible."}, {"q": "Comment appelle-t-on les constructions idéologiques émotionnelles se propageant de manière virale sur les réseaux sociaux ?", "a": "Les contagions cognitives."}, {"q": "Quel terme désigne l'état où des individus rejettent toute information contredisant leur narratif dominant au sein d'une communauté ?", "a": "La fermeture épistémique."}, {"q": "Dans le modèle chinois en six étapes, quelle est la première phase de la manipulation cognitive ?", "a": "Le portrait de l'utilisateur via le Big Data."}, {"q": "Quel est l'impact principal des algorithmes de recommandation sur la diversité des points de vue ?", "a": "Ils créent des chambres d'écho en limitant l'exposition aux opinions divergentes."}, {"q": "Selon les études, quel trait psychologique rend les électeurs plus réceptifs aux contenus algorithmiques extrêmes ?", "a": "L'instabilité émotionnelle."}, {"q": "En théorie du chaos, comment appelle-t-on le phénomène où une rumeur minime peut déclencher une crise nationale ?", "a": "L'effet papillon."}, {"q": "Dans les équations de Lorenz, quel paramètre $\\rho$ peut être manipulé pour simuler le niveau de méfiance publique ?", "a": "Le paramètre $\\rho$ (rhô)."}, {"q": "Que signifie l'acronyme de la boucle décisionnelle corrompue par la guerre cognitive ?", "a": "OODA (Observation, Orientation, Décision, Action)."}, {"q": "Selon Dave Snowden, que se passe-t-il pour la boucle OODA dans un environnement \"chaotique\" ?", "a": "Elle s'effondre, entraînant une paralysie ou des erreurs fatales."}, {"q": "Dans le modèle SIR appliqué aux rumeurs, que représente la catégorie 'E' ?", "a": "Les Étouffeurs (individus ayant cessé de diffuser l'information)."}, {"q": "Quelle est la formule du nombre de reproduction de base $R_0$ dans la propagation d'une rumeur ?", "a": "$R_0 = \\frac{\\beta N}{\\alpha + \\gamma + \\mu}$"}, {"q": "Quel effet l'introduction de délais temporels ($\\tau$) a-t-elle sur un système de propagation d'information ?", "a": "Elle peut induire une instabilité ou des oscillations chaotiques."}, {"q": "Qu'est-ce que l'homophilie de réseau dans le contexte de la désinformation ?", "a": "La tendance des individus à se connecter à ceux qui partagent leurs croyances, accélérant la circulation des rumeurs."}, {"q": "Quelle est la définition de la \"résilience dynamique\" ?", "a": "La capacité de combattre à travers la perturbation et de s'adapter au contact de l'ennemi."}, {"q": "Concept : Extensibilité gracieuse (Graceful Extensibility)", "a": "Définition : Capacité d'un système à étendre ses réponses au-delà de ses limites normales face à une pression extrême."}, {"q": "Qu'est-ce que la MRT-C dans le domaine de la cyber-résilience ?", "a": "Le terrain critique pour la mission dans le cyberespace (Mission-Relevant Terrain in Cyberspace)."}, {"q": "Quelle stratégie consiste à engager l'adversaire dans ses propres réseaux avant qu'il ne lance d'attaques massives ?", "a": "La défense avancée (Defend Forward)."}, {"q": "Comment appelle-t-on la protection mentale des populations via la sensibilisation aux biais cognitifs ?", "a": "L'immunisation cognitive."}, {"q": "Quel dilemme guette les États démocratiques lorsqu'ils tentent de réguler l'information ?", "a": "Le dilemme du prisonnier appliqué à la censure (risque de perdre la confiance du public)."}, {"q": "Selon Bernard Claverie, que ciblent précisément les sciences cognitives \"dures\" ?", "a": "La pensée comme un objet matériel via les neurosciences et les sciences du numérique."}, {"q": "Quel nom porte l'ensemble de symptômes incapacitants suspectés d'être causés par une arme neurobiologique à Cuba ?", "a": "Le syndrome de La Havane."}, {"q": "Quel projet français vise à développer des simulations de crises fictives pour la guerre cognitive ?", "a": "Le projet Gecko."}, {"q": "Dans l'analyse des risques de protection, quels sont les trois facteurs de l'équation du risque ?", "a": "Menace, Vulnérabilité et Capacité."}, {"q": "Citez un exemple de déclencheur de vulnérabilité au niveau micro (individuel) en guerre cognitive.", "a": "Le besoin d'appartenance sociale (ou l'inflexibilité cognitive)."}, {"q": "Quelle technique russe vise à fournir à l'adversaire des informations l'amenant à prendre volontairement une décision prédéterminée ?", "a": "Le contrôle réflexif (Reflexive Control)."}, {"q": "Dans le modèle SIR, que représente le paramètre $\\beta$ ?", "a": "Le taux de transmission (virilité de l'information)."}, {"q": "Quel organe du cerveau est responsable de la régulation rationnelle et de la planification, souvent court-circuité par la peur ?", "a": "Le cortex préfrontal."}, {"q": "Pourquoi la zone grise est-elle privilégiée pour les attaques cognitives ?", "a": "Parce qu'il est difficile de définir un acte de guerre pour des manipulations restant sous le seuil cinétique."}, {"q": "Que cherche à provoquer l'injection de désordre dans le système adverse par un agresseur ?", "a": "Une paralysie institutionnelle."}, {"q": "Dans le modèle de Snowden, quel type d'environnement nécessite de \"sonder\" avant de percevoir ?", "a": "L'environnement complexe."}, {"q": "Vrai ou Faux : Les rumeurs peuvent ressurgir brutalement à cause des non-linéarités du système social.", "a": "Vrai."}, {"q": "Quelle est la quatrième étape du modèle d'analyse du risque systémique global ?", "a": "L'événement systémique (crise majeure affectant la stabilité de l'État)."}, {"q": "Quel outil permet de créer des contenus audiovisuels ultra-réalistes mais faux (Deepfakes) ?", "a": "L'IA générative."}, {"q": "Dans le cadre de l'OTAN, quel est le but de la \"Cognitive Superiority\" pour les décideurs ?", "a": "Mieux comprendre l'environnement opérationnel et l'adversaire pour décider plus vite et mieux."}, {"q": "Comment appelle-t-on l'utilisation de l'IA pour enfermer les individus dans des \"cocons\" de sens identiques ?", "a": "Les cocons sémantiques."}, {"q": "Quel paramètre du SIR représente le taux de passage à l'état d'étouffeur par perte d'intérêt ?", "a": "$\\alpha$ (alpha)."}, {"q": "L'équation $\\frac{dx}{dt} = \\sigma(y - x)$ fait partie de quel modèle mathématique ?", "a": "L'attracteur de Lorenz (théorie du chaos)."}, {"q": "Quel est l'objectif des \"Pools de données\" dans la cybersécurité moderne ?", "a": "Partager anonymement des menaces en temps réel pour anticiper les vagues de désinformation."}, {"q": "Quel risque pose la dépendance totale aux technologies de l'information selon le texte ?", "a": "Une vulnérabilité systémique et interconnectée."}, {"q": "En guerre cognitive, comment appelle-t-on le fait d'attaquer le leadership de \"l'intérieur vers l'extérieur\" ?", "a": "Le principe des opérations basées sur les effets (EBO)."}, {"q": "Pourquoi la vérité devient-elle une variable secondaire dans une chambre d'écho ?", "a": "Parce que l'appartenance au groupe et le renforcement des préjugés priment sur les faits rationnels."}, {"q": "Dans le modèle de l'OTAN, quel type d'harm Miller identifie-t-il spécifiquement pour la guerre cognitive ?", "a": "Le dommage psychologique aux humains et le dommage aux institutions."}, {"q": "Quel terme désigne la manipulation de la viralité pour faire paraître un sujet naturellement populaire ?", "a": "La suggestion de références (dans le modèle chinois)."}, {"q": "Quelle discipline étudie la sensibilité d'un système aux conditions initiales ?", "a": "La théorie du chaos."}, {"q": "Quelle est la fonction du paramètre $\\gamma$ dans le modèle SIR des rumeurs ?", "a": "Le taux de récupération suite à une vérification des faits (fact-checking)."}, {"q": "Quelle est la conséquence d'un signal d'erreur saturé en permanence ?", "a": "Un stress cognitif permanent qui pousse vers des réactions émotionnelles impulsives."}, {"q": "Dans la gestion des risques de protection, que signifie la 'Capacité' ?", "a": "Les ressources et tactiques qu'utilisent les communautés pour prévenir ou arrêter une menace."}, {"q": "Quel vecteur de menace utilise des narratifs historiques pour provoquer un \"chaos environnemental\" en Afrique ?", "a": "La Russie."}, {"q": "Quelle dimension de la cognition concerne l'apport initial d'information ?", "a": "L'input."}, {"q": "Pourquoi les démocraties sont-elles structurellement plus vulnérables à la guerre cognitive ?", "a": "À cause de leur transparence, de la liberté d'expression et du rejet des méthodes de contrôle autoritaires."}, {"q": "Quel terme de la boucle OODA est spécifiquement biaisé par les perceptions déformées en guerre cognitive ?", "a": "L'Orientation."}, {"q": "Dans le modèle SIR, que représente $N$ ?", "a": "La population totale."}, {"q": "Quel est l'effet d'une bifurcation dans un système de propagation d'information ?", "a": "Un changement brusque de comportement, comme la résurgence soudaine d'une rumeur oubliée."}, {"q": "Qu'est-ce que le micro-ciblage psychographique ?", "a": "L'utilisation de données personnelles (likes, intentions) pour créer des messages taillés sur mesure pour exploiter les peurs individuelles."}, {"q": "Quelle est la différence entre un système \"compliqué\" et \"complexe\" selon Snowden ?", "a": "Le compliqué nécessite une expertise pour l'analyse, le complexe a une causalité émergente visible seulement a posteriori."}, {"q": "Citez un risque macro-sociétal favorisant la guerre cognitive selon l'OTAN.", "a": "Le populisme anti-établissement (ou le manque de littératie médiatique)."}, {"q": "Quel est le but ultime de la \"neuro-guerre\" ?", "a": "Contrôler la souveraineté d'un État au cœur même de l'esprit de ses citoyens."}, {"q": "Dans l'analyse de cas de l'Ouganda (LRA), quel était l'objectif du recrutement d'enfants ?", "a": "Faire renaître une nouvelle génération d'Acholis suivant Kony."}, {"q": "Quel mécanisme permet à l'IA de superviser la gratification sociale ?", "a": "La mesure des interactions sociales pour renforcer l'enfermement dans un cadre cognitif."}, {"q": "Pourquoi la \"défense en profondeur\" en guerre cognitive nécessite-t-elle des partenariats public-privé ?", "a": "Parce que les infrastructures et les données nécessaires à la défense appartiennent majoritairement au secteur privé."}, {"q": "Quel impact a la perte de confiance dans les institutions démocratiques selon le texte ?", "a": "Elle rend la société ingouvernable et vulnérable aux influences étrangères."}, {"q": "Quel facteur peut neutraliser la force technologique brute dans une guerre asymétrique ?", "a": "L'exploitation des dépendances informationnelles et de la complexité sociale."}, {"q": "Que désigne le terme \"zone grise\" ?", "a": "L'espace de conflictualité situé entre la paix et la guerre conventionnelle."}, {"q": "Dans le cadre de l'analyse de protection, quel type de menace est le mariage forcé ?", "a": "Une menace de coercition."}, {"q": "Quel paramètre $\\beta$ dans les équations de Lorenz influe sur le comportement chaotique ?", "a": "$\\beta$ (bêta)."}], "source": "builtin"}];

/* ═══ COGWAR ENGINE — ULTIMATE ═══ */
const $=id=>document.getElementById(id);
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};

/* ─── Storage Layer (IndexedDB → fallback mémoire) ─── */
const DB='cogwar7';let db=null;let USE_MEM=false;
const MEM={decks:new Map(),meta:new Map()};

async function idb(){
  try{
    return await new Promise((ok,no)=>{
      if(typeof indexedDB==='undefined'){no('no indexedDB');return}
      const r=indexedDB.open(DB,1);
      r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('decks'))d.createObjectStore('decks',{keyPath:'id'});if(!d.objectStoreNames.contains('meta'))d.createObjectStore('meta',{keyPath:'k'})};
      r.onsuccess=e=>{db=e.target.result;ok(db)};
      r.onerror=e=>no(e);
      r.onblocked=e=>no('blocked');
      setTimeout(()=>no('timeout'),3000);
    });
  }catch(e){
    console.warn('IndexedDB unavailable, using memory fallback:',e);
    USE_MEM=true;db=null;
  }
}

async function put(s,d){
  if(USE_MEM||!db){const key=s==='decks'?d.id:d.k;MEM[s].set(key,JSON.parse(JSON.stringify(d)));return}
  try{return await new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).put(d);t.oncomplete=ok;t.onerror=no})}
  catch(e){const key=s==='decks'?d.id:d.k;MEM[s].set(key,JSON.parse(JSON.stringify(d)))}
}

async function get(s,k){
  if(USE_MEM||!db)return MEM[s].get(k)||null;
  try{return await new Promise((ok,no)=>{const t=db.transaction(s);const r=t.objectStore(s).get(k);r.onsuccess=()=>ok(r.result);r.onerror=no})}
  catch(e){return MEM[s].get(k)||null}
}

async function getAll(s){
  if(USE_MEM||!db)return Array.from(MEM[s].values());
  try{return await new Promise((ok,no)=>{const t=db.transaction(s);const r=t.objectStore(s).getAll();r.onsuccess=()=>ok(r.result);r.onerror=no})}
  catch(e){return Array.from(MEM[s].values())}
}

async function del(s,k){
  if(USE_MEM||!db){MEM[s].delete(k);return}
  try{return await new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).delete(k);t.oncomplete=ok;t.onerror=no})}
  catch(e){MEM[s].delete(k)}
}

/* ─── State ─── */
let ST={xp:0,lv:1,rd:[],fO:0,fK:0,bS:0,ach:[],sessions:0,dayStreak:0,lastPlay:null};
async function ldST(){
  try{const m=await get('meta','st');if(m)ST=m.v}catch(e){console.error('ldST:',e)}
}
async function svST(){await put('meta',{k:'st',v:ST})}

/* ─── XP / Toast / Ach ─── */
function addXP(n,l){ST.xp+=n;const nl=Math.floor(ST.xp/100)+1;if(nl>ST.lv){ST.lv=nl;toast(`⬆ LVL ${ST.lv}`,'lv');if(ST.lv>=5)achk('l5');if(ST.lv>=10)achk('l10')}upXP();toast(`+${n} XP — ${l}`,'xp');svST()}
function upXP(){$('xpf').style.width=(ST.xp%100)+'%';$('xpd').textContent=ST.xp;$('lvd').textContent='LV'+ST.lv;$('dh-x').textContent=ST.xp;$('dh-s').textContent=ST.sessions}
function toast(m,c){const t=document.createElement('div');t.className='toast '+(c||'');t.textContent=m;$('tc').appendChild(t);setTimeout(()=>t.remove(),1800)}
const ACHS=[{id:'1st',i:'📖',n:'Néophyte',d:'1 entrée lue'},{id:'5rd',i:'🧠',n:'Éveillé',d:'5 entrées'},{id:'all',i:'👁',n:'Omniscient',d:'Toutes lues'},{id:'f5',i:'⚡',n:'Initié',d:'5 flashcards'},{id:'f10',i:'🔥',n:'En feu',d:'Série de 10'},{id:'fdk',i:'🏆',n:'WOPR',d:'Finir 1 deck'},{id:'l5',i:'⭐',n:'Sentinelle',d:'Niveau 5'},{id:'l10',i:'🛡',n:'Pare-feu',d:'Niveau 10'},{id:'cr',i:'✏️',n:'Créateur',d:'Créer un deck'},{id:'s100',i:'💯',n:'Centurion',d:'100 cartes OK'}];
function achk(id){if(ST.ach.includes(id))return;ST.ach.push(id);const a=ACHS.find(x=>x.id===id);if(a)toast(`🏆 ${a.n}!`,'ach');rAch();svST()}
function rAch(){$('ag').innerHTML=ACHS.map(a=>`<div class="ac ${ST.ach.includes(a.id)?'gt':'lk'}"><div class="aci">${a.i}</div><div class="acn">${a.n}</div><div class="acd">${a.d}</div></div>`).join('');$('ach-count').textContent=ST.ach.length+' débloqués'}

/* ─── Theme ─── */
function setT(t){document.documentElement.setAttribute('data-theme',t);document.querySelectorAll('.dot').forEach(d=>d.classList.toggle('on',d.dataset.t===t));try{localStorage.setItem('cw-t',t)}catch(e){}}

/* ─── Navigation ─── */
const SECS=['home','play','lib','store','more','ency','ach','profile','console','workspace','stats'];
function go(id,btn){
  SECS.forEach(s=>{const el=$('s-'+s);if(el)el.classList.toggle('on',s===id)});
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  else{const map={ency:'more',ach:'more',console:'more',workspace:'more',stats:'more'};document.querySelector(`.nb[data-s="${map[id]||id}"]`)?.classList.add('on')}
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='play')rPlay();if(id==='lib')rLib();if(id==='store')rStore();if(id==='profile')applyProf();if(id==='console'&&!$('con-out').children.length)conBoot();if(id==='workspace')rWorkspace();if(id==='stats')rStats();
}

/* ─── Modals ─── */
function omo(id){$(id).classList.add('open');document.body.style.overflow='hidden'}
function cmo(id){$(id).classList.remove('open');document.body.style.overflow=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.mo.open').forEach(m=>{m.classList.remove('open');document.body.style.overflow=''})});

/* ═══ BUILTIN INSTALL ═══ */
async function installBuiltins(){
  try{
  const ver=await get('meta','builtin_ver');
  const currentVer=2; // bump this to force re-install
  if(ver&&ver.v>=currentVer)return;
  for(const dk of BUILTIN_DECKS){
    const existing=await get('decks',dk.id);
    if(!existing||dk.version>(existing.version||0)){
      await put('decks',{...dk,source:'builtin',installed:Date.now()});
    }
  }
  await put('meta',{k:'builtin_ver',v:currentVer});
  console.log('Builtin decks installed/updated');
}catch(e){console.error('installBuiltins:',e)}
}

/* ═══ HOME ═══ */
let qfF=false;
async function rHome(){
  try{
  const dks=await getAll('decks');
  const tc=dks.reduce((s,d)=>s+(d.cards?.length||0),0);
  $('dh-d').textContent=dks.length;$('dh-c').textContent=tc;
  // random flashcard
  const all=dks.flatMap(d=>d.cards||[]);
  if(all.length){const c=all[Math.floor(Math.random()*all.length)];$('qfq').textContent=c.q;$('qfa').textContent=c.a}
  else{$('qfq').textContent='Installez des decks dans le Store!'}
  qfF=false;$('qfi').classList.remove('fl');
}catch(e){console.error('rHome:',e)}
}
function qfTap(){if(!qfF){qfF=true;$('qfi').classList.add('fl')}else{rHome()}}

/* ═══ PLAY ENGINE ═══ */
let curDk=null,shuf=[],pfi=0,pfl=0,pStr=0,pOk=0,pKo=0;

async function rPlay(){
  try{
  const dks=(await getAll('decks')).filter(d=>d.cards&&d.cards.length>0).sort((a,b)=>a.difficulty-b.difficulty||a.name.localeCompare(b.name));
  $('play-empty').style.display=dks.length?'none':'block';
  $('play-zone').style.display=dks.length?'':'none';
  $('ptabs').innerHTML=dks.map(d=>`<div class="dt${curDk===d.id?' on':''}" onclick="selDk('${d.id}')"><span class="dd d${d.difficulty}"></span>${esc(d.name)} <span style="font-size:9px;opacity:.5">(${d.cards.length})</span></div>`).join('');
  // Update SR due count
  const now=Date.now();let dueCount=0;
  for(const dk of dks){(dk.cards||[]).forEach((c,i)=>{const sm=SM2[cardKey(dk.id,i)];if(!sm||sm.next<=now)dueCount++})}
  $('sr-due-count').textContent=dueCount;
}catch(e){console.error('rPlay:',e)}
}

async function selDk(id){
  curDk=id;rPlay();
  const d=await get('decks',id);if(!d)return;
  shuf=[...d.cards].sort(()=>Math.random()-.5);
  pfi=0;pfl=0;pStr=0;pOk=0;pKo=0;
  $('pinfo').textContent=`${d.icon} ${d.name} — ${d.cards.length} cartes`;
  $('ps-ok').textContent='0';$('ps-ko').textContent='0';$('ps-st').textContent='0';
  ST.sessions++;svST();upXP();
  pShow();
}

function pShow(){
  if(pfi>=shuf.length){$('pq').textContent='✓ DECK TERMINÉ!';$('pq').style.fontSize='22px';$('pi').classList.remove('fl');$('pbs').style.display='none';achk('fdk');return}
  pfl=0;$('pi').classList.remove('fl');$('pbs').style.display='none';
  $('pq').textContent=shuf[pfi].q;$('pq').style.fontSize='';$('pa').textContent=shuf[pfi].a;
  $('pctr').textContent=`${pfi+1}/${shuf.length}`;$('ppf').style.width=(pfi/shuf.length*100)+'%';$('psc').textContent=pOk+'✓';
}
function pflip(){if(pfl)return;pfl=1;$('pi').classList.add('fl');$('pbs').style.display='flex'}
function pans(ok){
  if(ok){pOk++;ST.fO++;pStr++;if(pStr>ST.bS)ST.bS=pStr;addXP(10,'Flashcard');if(ST.fO>=5)achk('f5');if(pStr>=10)achk('f10');if(ST.fO>=100)achk('s100')}
  else{pKo++;ST.fK++;pStr=0}
  $('ps-ok').textContent=pOk;$('ps-ko').textContent=pKo;$('ps-st').textContent=pStr;
  pfi++;svST();pShow();
}
function psk(){pfi++;pShow()}

/* ═══ SM-2 SPACED REPETITION ═══ */
let SM2={};// cardKey → {ef,interval,reps,next,reviews,correct,wrong}
let srMode=false,srQueue=[];

async function ldSM2(){
  try{const m=await get('meta','sm2');if(m&&m.v)SM2=m.v}catch(e){SM2={}}
}
async function svSM2(){await put('meta',{k:'sm2',v:SM2})}

function cardKey(deckId,cardIdx){return deckId+'::'+cardIdx}

function sm2Grade(key,quality){
  // quality: 0=total blackout, 1=wrong, 2=hard, 3=ok, 4=good, 5=easy
  if(!SM2[key])SM2[key]={ef:2.5,interval:0,reps:0,next:0,reviews:0,correct:0,wrong:0};
  const c=SM2[key];
  c.reviews++;
  if(quality>=3)c.correct++;else c.wrong++;
  
  if(quality<3){
    c.reps=0;c.interval=1;// reset
  }else{
    if(c.reps===0)c.interval=1;
    else if(c.reps===1)c.interval=6;
    else c.interval=Math.round(c.interval*c.ef);
    c.reps++;
  }
  c.ef=Math.max(1.3,c.ef+0.1-(5-quality)*(0.08+(5-quality)*0.02));
  c.next=Date.now()+c.interval*24*60*60*1000;
  c.lastReview=Date.now();
}

function getDueCards(){
  const now=Date.now();
  return Object.entries(SM2).filter(([k,v])=>v.next<=now).map(([k,v])=>({key:k,data:v}));
}

async function startSR(){
  await ldSM2();
  const dks=await getAll('decks');
  srQueue=[];
  const now=Date.now();
  
  // Collect due cards + unseen cards (limit 20)
  for(const dk of dks){
    (dk.cards||[]).forEach((card,i)=>{
      const key=cardKey(dk.id,i);
      const sm=SM2[key];
      if(!sm){srQueue.push({card,key,dk:dk.name,prio:0})}// unseen
      else if(sm.next<=now){srQueue.push({card,key,dk:dk.name,prio:1,sm})}// due
    });
  }
  // Sort: due first (by overdue amount), then unseen
  srQueue.sort((a,b)=>{
    if(a.prio!==b.prio)return b.prio-a.prio;
    if(a.sm&&b.sm)return a.sm.next-b.sm.next;
    return 0;
  });
  srQueue=srQueue.slice(0,30);// cap at 30 per session
  
  if(!srQueue.length){toast('Aucune carte à réviser!','ach');return}
  
  srMode=true;pfi=0;pOk=0;pKo=0;pStr=0;
  shuf=srQueue.map(s=>s.card);
  $('pinfo').innerHTML=`🧠 RÉVISION INTELLIGENTE — ${srQueue.length} cartes <span class="sr-badge">SM-2</span>`;
  $('ps-ok').textContent='0';$('ps-ko').textContent='0';$('ps-st').textContent='0';
  pShow();
}

// Override pans to hook SM-2 grading
const _origPansBase=pans;
pans=function(ok){
  if(srMode&&srQueue[pfi]){
    sm2Grade(srQueue[pfi].key, ok?4:1);
    svSM2();
  }
  _origPansBase(ok);
  // When SR session ends
  if(srMode&&pfi>=srQueue.length){
    srMode=false;
    toast('Révision terminée!','ach');
  }
};

/* ═══ STATS DASHBOARD ═══ */
async function rStats(){
  await ldSM2();
  const dks=await getAll('decks');
  const totalCards=dks.reduce((s,d)=>s+(d.cards?.length||0),0);
  const accuracy=ST.fO+ST.fK>0?Math.round(ST.fO/(ST.fO+ST.fK)*100):0;
  
  $('st-total-cards').textContent=ST.fO+ST.fK;
  $('st-accuracy').textContent=accuracy+'%';
  $('st-streak').textContent=ST.bS;
  $('st-sessions').textContent=ST.sessions;
  
  // SM-2 stats
  const now=Date.now();let due=0,mastered=0,learning=0,unseen=0;
  for(const dk of dks){
    (dk.cards||[]).forEach((card,i)=>{
      const key=cardKey(dk.id,i);
      const sm=SM2[key];
      if(!sm){unseen++}
      else if(sm.interval>=7){mastered++}
      else if(sm.next<=now){due++}
      else{learning++}
    });
  }
  $('st-due').textContent=due;
  $('st-mastered').textContent=mastered;
  $('st-learning').textContent=learning;
  $('st-unseen').textContent=unseen;
  
  // Per-deck performance
  let deckHtml='';
  for(const dk of dks){
    const cards=dk.cards||[];
    let dkOk=0,dkWrong=0,dkReviewed=0;
    cards.forEach((c,i)=>{
      const sm=SM2[cardKey(dk.id,i)];
      if(sm){dkOk+=sm.correct;dkWrong+=sm.wrong;dkReviewed++}
    });
    const pct=dkOk+dkWrong>0?Math.round(dkOk/(dkOk+dkWrong)*100):0;
    const coverage=cards.length>0?Math.round(dkReviewed/cards.length*100):0;
    deckHtml+=`<div class="stat-row"><span>${dk.icon||'📦'} ${esc(dk.name)}</span><div class="stat-bar-wrap"><div class="stat-bar g" style="width:${pct}%"></div></div><span style="font-family:var(--fp);font-size:10px;min-width:40px;text-align:right">${pct}% · ${coverage}%</span></div>`;
  }
  $('st-decks').innerHTML=deckHtml||'<div style="color:var(--t3);font-size:11px;padding:8px">Aucune donnée. Jouez pour générer des stats.</div>';
  
  // Heatmap (7 days)
  const days=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  let heatHtml='';
  for(let d=6;d>=0;d--){
    const date=new Date(now-d*24*60*60*1000);
    const dayStr=date.toISOString().slice(0,10);
    // Count reviews that day
    let count=0;
    for(const[k,v] of Object.entries(SM2)){
      if(v.lastReview&&new Date(v.lastReview).toISOString().slice(0,10)===dayStr)count++;
    }
    const level=count===0?0:count<5?1:count<15?2:count<30?3:4;
    heatHtml+=`<div class="heat-day"><div class="heat-box h${level}" title="${dayStr}: ${count} révisions"></div><div class="heat-label">${days[date.getDay()]}</div></div>`;
  }
  $('st-heat').innerHTML=heatHtml;
  
  // Hardest cards (top 5 by error rate)
  let hardCards=[];
  for(const dk of dks){
    (dk.cards||[]).forEach((card,i)=>{
      const sm=SM2[cardKey(dk.id,i)];
      if(sm&&sm.reviews>=2){
        const errRate=sm.wrong/(sm.correct+sm.wrong);
        hardCards.push({q:card.q,errRate,reviews:sm.reviews,dk:dk.name});
      }
    });
  }
  hardCards.sort((a,b)=>b.errRate-a.errRate);
  $('st-hard').innerHTML=hardCards.slice(0,5).map(h=>{
    const pct=Math.round(h.errRate*100);
    const cls=pct>60?'bad':pct>30?'med':'ok';
    return `<div class="hard-card"><span class="hard-q">${esc(h.q)}</span><span class="hard-score ${cls}">${pct}% err · ${h.reviews} rev</span></div>`;
  }).join('')||'<div style="color:var(--t3);font-size:11px;padding:8px">Pas assez de données. Révisez au moins 2× par carte.</div>';
}

/* ═══ LIBRARY CRUD ═══ */
let edDk=null;

async function rLib(){
  try{
  const dks=(await getAll('decks')).sort((a,b)=>a.difficulty-b.difficulty||a.name.localeCompare(b.name));
  $('lib-empty').style.display=dks.length?'none':'block';
  $('lib-list').innerHTML=dks.map(d=>`<div class="dki">
    <div class="dki-top"><div class="dki-ico">${d.icon||'🧠'}</div><div style="flex:1;min-width:0"><div class="dki-t">${esc(d.name)}</div><div class="dki-m"><span class="dd d${d.difficulty}"></span>${d.cards?.length||0} cartes · ${esc(d.author||'')} · ${d.source||'local'}</div></div></div>
    <div class="dki-acts"><button onclick="openCards('${d.id}')">🃏 Cartes</button><button onclick="deckForm('${d.id}')">✏️ Éditer</button><button onclick="expOne('${d.id}')">⬇ Export</button><button class="del" onclick="delDk('${d.id}')">✕ Suppr.</button></div>
  </div>`).join('');
}catch(e){console.error('rLib:',e);$('lib-list').innerHTML='<div style="padding:20px;color:#ff3b30;text-align:center">Erreur: '+String(e)+'</div>'}
}

function deckForm(id){
  edDk=id||null;$('mdk-t').textContent=id?'Modifier Deck':'Nouveau Deck';
  if(id){get('decks',id).then(d=>{if(d){$('dk-n').value=d.name;$('dk-i').value=d.icon||'🧠';$('dk-d').value=d.difficulty||1;$('dk-desc').value=d.description||'';$('dk-tg').value=(d.tags||[]).join(', ')}})}
  else{$('dk-n').value='';$('dk-i').value='🧠';$('dk-d').value='1';$('dk-desc').value='';$('dk-tg').value=''}
  omo('mo-dk');
}

async function saveDk(){
  try{
  const nm=$('dk-n').value.trim();if(!nm){toast('Nom requis','err');return}
  const id=edDk||'u-'+Date.now()+'-'+Math.random().toString(36).slice(2,5);
  const ex=edDk?await get('decks',id):null;
  await put('decks',{id,name:nm,icon:$('dk-i').value||'🧠',difficulty:+$('dk-d').value||1,description:$('dk-desc').value,tags:$('dk-tg').value.split(',').map(t=>t.trim()).filter(Boolean),cards:ex?ex.cards:[],author:ex?.author||'Vous',source:ex?.source||'user',version:(ex?.version||0)+1,created:ex?.created||Date.now(),updated:Date.now()});
  if(!edDk)achk('cr');toast(edDk?'Modifié':'Créé!');cmo('mo-dk');rLib();rHome();
}catch(e){console.error('saveDk:',e)}
}

async function delDk(id){
  try{if(!confirm('Supprimer ce deck et ses cartes ?'))return;await del('decks',id);toast('Supprimé');rLib();rHome();rPlay()}catch(e){console.error('delDk:',e)}
}

/* ─── Card CRUD ─── */
let edCdDk=null,edCdIdx=-1;

async function openCards(id){
  try{
  edCdDk=id;const d=await get('decks',id);
  $('mcd-t').textContent=`${d.icon} ${d.name}`;
  rCards(d.cards||[]);omo('mo-cd');
}catch(e){console.error('openCards:',e)}
}

function rCards(cards){
  $('cd-empty').style.display=cards.length?'none':'block';
  $('cd-list').innerHTML=cards.map((c,i)=>`<div class="ce"><div class="ce-bd"><div class="ce-q">Q: ${esc(c.q)}</div><div class="ce-a">R: ${esc(c.a)}</div></div><div class="ce-ac"><button onclick="cardForm(${i})">✏️ Éditer</button><button onclick="delCd(${i})" style="color:var(--rd)">✕ Suppr.</button>${i>0?`<button onclick="mvCd(${i},-1)">↑ Monter</button>`:''}</div></div>`).join('');
}

function cardForm(idx){
  edCdIdx=typeof idx==='number'?idx:-1;$('mcf-t').textContent=edCdIdx>=0?'Modifier':'Nouvelle Carte';
  if(edCdIdx>=0){get('decks',edCdDk).then(d=>{$('cf-q').value=d.cards[edCdIdx].q;$('cf-a').value=d.cards[edCdIdx].a})}
  else{$('cf-q').value='';$('cf-a').value=''}
  omo('mo-cf');
}

async function saveCd(){
  try{
  const q=$('cf-q').value.trim(),a=$('cf-a').value.trim();if(!q||!a){toast('Q+R requis','err');return}
  const d=await get('decks',edCdDk);if(!d.cards)d.cards=[];
  if(edCdIdx>=0)d.cards[edCdIdx]={q,a};else d.cards.push({q,a});
  d.updated=Date.now();await put('decks',d);rCards(d.cards);cmo('mo-cf');toast(edCdIdx>=0?'Modifiée':'Ajoutée');rHome();
}catch(e){console.error('saveCd:',e)}
}

async function delCd(i){
  try{
  const d=await get('decks',edCdDk);d.cards.splice(i,1);d.updated=Date.now();await put('decks',d);rCards(d.cards);toast('Supprimée');
}catch(e){console.error('delCd:',e)}
}

async function mvCd(i,dir){
  const d=await get('decks',edCdDk);const n=i+dir;[d.cards[i],d.cards[n]]=[d.cards[n],d.cards[i]];d.updated=Date.now();await put('decks',d);rCards(d.cards);
}

/* ─── Import / Export ─── */
function doImport(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=async function(){
    try{
      const data=JSON.parse(rd.result);
      // Support single deck or array of decks
      const decks=Array.isArray(data)?data:data.cards?[data]:[];
      if(!decks.length){toast('Format invalide','err');return}
      let count=0;
      for(const dk of decks){
        if(!dk.name||!dk.cards){continue}
        const id=dk.id||'imp-'+Date.now()+'-'+(count++);
        const existing=await get('decks',id);
        const fid=existing?id+'-'+Date.now().toString(36).slice(-4):id;
        await put('decks',{id:fid,name:dk.name,icon:dk.icon||'📥',difficulty:dk.difficulty||1,description:dk.description||'',tags:dk.tags||[],cards:dk.cards,author:dk.author||'Import',source:'import',version:dk.version||1,created:Date.now(),updated:Date.now()});
      }
      toast(`${decks.length} deck(s) importé(s)!`,'ach');rLib();rHome();
    }catch(err){toast('Erreur JSON: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

async function expOne(id){
  const d=await get('decks',id);if(!d)return;
  const out={id:d.id,name:d.name,icon:d.icon,difficulty:d.difficulty,description:d.description,tags:d.tags,author:d.author,version:d.version||1,cards:d.cards};
  dlJSON(out,d.name.replace(/[^a-zA-Z0-9_-]/g,'_')+'.json');
}
function expDk(){expOne(edCdDk)}
function dlJSON(o,fn){const b=new Blob([JSON.stringify(o,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn;a.click();URL.revokeObjectURL(a.href)}
function dlBlob(text,fn,mime){const b=new Blob([text],{type:mime||'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn;a.click();URL.revokeObjectURL(a.href)}

/* ═══ WORKSPACE ENGINE ═══ */
let wsPreviewData=null,wsPreviewFn='export.txt',wsPreviewMime='text/plain';

async function rWorkspace(){
  const dks=await getAll('decks');
  const sel=$('ws-exp-dk');
  sel.innerHTML='<option value="__all">— Tous les decks —</option>'+dks.map(d=>`<option value="${d.id}">${esc(d.name)} (${d.cards?.length||0})</option>`).join('');
}

function wsShowPreview(text,fn,mime,info){
  wsPreviewData=text;wsPreviewFn=fn;wsPreviewMime=mime||'text/plain';
  $('ws-preview').textContent=text.length>8000?text.slice(0,8000)+'\n\n[…tronqué pour aperçu — fichier complet au téléchargement]':text;
  $('ws-prev-info').textContent=info||fn+' · '+Math.round(text.length/1024)+' Ko';
  $('ws-preview-panel').style.display='block';
  $('ws-preview-panel').scrollIntoView({behavior:'smooth'});
}
function wsDownloadPreview(){if(wsPreviewData)dlBlob(wsPreviewData,wsPreviewFn,wsPreviewMime)}
function wsClipPreview(){if(wsPreviewData){navigator.clipboard?.writeText(wsPreviewData);toast('Copié!','ach')}}

/* ─── IMPORT CSV ─── */
function wsImportCSV(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();rd.onload=async ev=>{
    try{
      const text=ev.target.result.trim();
      const lines=text.split(/\r?\n/);
      // Auto-detect separator
      const seps=[';',',','\t','|'];
      let sep=';';let maxCols=0;
      for(const s of seps){const cols=lines[0].split(s).length;if(cols>maxCols){maxCols=cols;sep=s}}
      // Parse
      const rows=lines.map(l=>parseCSVLine(l,sep));
      // Detect header
      let startIdx=0;
      const hdr=rows[0].map(h=>h.toLowerCase().trim());
      if(hdr.includes('question')||hdr.includes('q')||hdr.includes('front')||hdr.includes('recto'))startIdx=1;
      const cards=[];
      for(let i=startIdx;i<rows.length;i++){
        const r=rows[i];if(r.length<2||(!r[0].trim()&&!r[1].trim()))continue;
        cards.push({q:r[0].trim(),a:r[1].trim()});
      }
      if(!cards.length){toast('Aucune carte trouvée','err');return}
      const name=f.name.replace(/\.[^.]+$/,'').replace(/[_-]/g,' ');
      const id='imp-'+Date.now()+'-csv';
      await put('decks',{id,name,icon:'📊',difficulty:1,description:'Import CSV: '+f.name,tags:['import','csv'],cards,author:'Import CSV',source:'csv',version:1,created:Date.now(),updated:Date.now()});
      toast(`${cards.length} cartes importées depuis CSV!`,'ach');rWorkspace();rLib();rHome();
    }catch(err){toast('Erreur CSV: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

function parseCSVLine(line,sep){
  const result=[];let current='';let inQuotes=false;
  for(let i=0;i<line.length;i++){
    if(inQuotes){
      if(line[i]==='"'&&line[i+1]==='"'){current+='"';i++}
      else if(line[i]==='"')inQuotes=false;
      else current+=line[i];
    }else{
      if(line[i]==='"')inQuotes=true;
      else if(line[i]===sep){result.push(current);current=''}
      else current+=line[i];
    }
  }
  result.push(current);return result;
}

/* ─── IMPORT MARKDOWN ─── */
function wsImportMD(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();rd.onload=async ev=>{
    try{
      const text=ev.target.result;const cards=[];
      // Strategy 1: ## Q \n A pattern
      const h2blocks=text.split(/^#{1,3}\s+/m).filter(Boolean);
      if(h2blocks.length>2){
        for(const block of h2blocks){
          const lines=block.trim().split('\n');
          const q=lines[0].replace(/\*\*/g,'').trim();
          const a=lines.slice(1).join('\n').trim();
          if(q&&a)cards.push({q,a});
        }
      }
      // Strategy 2: **Q** : A pattern or - **Q** — A
      if(!cards.length){
        const lines=text.split(/\r?\n/);
        for(const line of lines){
          const m=line.match(/^\s*[-*]?\s*\*\*(.+?)\*\*\s*[:—–-]\s*(.+)/);
          if(m)cards.push({q:m[1].trim(),a:m[2].trim()});
        }
      }
      // Strategy 3: Q? \n A (question mark detection)
      if(!cards.length){
        const lines=text.split(/\r?\n/).filter(l=>l.trim());
        for(let i=0;i<lines.length-1;i++){
          if(lines[i].trim().endsWith('?')){
            cards.push({q:lines[i].trim(),a:lines[i+1].trim()});i++;
          }
        }
      }
      if(!cards.length){toast('Aucun pattern Q/R détecté dans le Markdown','err');return}
      const name=f.name.replace(/\.[^.]+$/,'').replace(/[_-]/g,' ');
      const id='imp-'+Date.now()+'-md';
      await put('decks',{id,name,icon:'📝',difficulty:1,description:'Import Markdown: '+f.name,tags:['import','markdown'],cards,author:'Import MD',source:'markdown',version:1,created:Date.now(),updated:Date.now()});
      toast(`${cards.length} cartes importées depuis Markdown!`,'ach');rWorkspace();rLib();rHome();
    }catch(err){toast('Erreur MD: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

/* ─── IMPORT HTML ─── */
function wsImportHTML(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();rd.onload=async ev=>{
    try{
      const parser=new DOMParser();const doc=parser.parseFromString(ev.target.result,'text/html');
      const cards=[];
      // Strategy 1: <table> rows
      doc.querySelectorAll('table tr').forEach(tr=>{
        const cells=tr.querySelectorAll('td');
        if(cells.length>=2)cards.push({q:cells[0].textContent.trim(),a:cells[1].textContent.trim()});
      });
      // Strategy 2: <dl> definition lists
      if(!cards.length){
        doc.querySelectorAll('dt').forEach(dt=>{
          const dd=dt.nextElementSibling;
          if(dd&&dd.tagName==='DD')cards.push({q:dt.textContent.trim(),a:dd.textContent.trim()});
        });
      }
      // Strategy 3: Schema.org FAQPage
      if(!cards.length){
        doc.querySelectorAll('[itemtype*="Question"]').forEach(el=>{
          const q=el.querySelector('[itemprop="name"]')?.textContent?.trim();
          const a=el.querySelector('[itemprop="text"]')?.textContent?.trim();
          if(q&&a)cards.push({q,a});
        });
      }
      // Strategy 4: JSON-LD in page
      if(!cards.length){
        doc.querySelectorAll('script[type="application/ld+json"]').forEach(s=>{
          try{const d=JSON.parse(s.textContent);
            if(d.mainEntity)d.mainEntity.forEach(e=>{if(e.name&&e.acceptedAnswer)cards.push({q:e.name,a:e.acceptedAnswer.text||''})});
          }catch(e){}
        });
      }
      if(!cards.length){toast('Aucune carte trouvée (table/dl/FAQ)','err');return}
      const name=f.name.replace(/\.[^.]+$/,'').replace(/[_-]/g,' ');
      const id='imp-'+Date.now()+'-html';
      await put('decks',{id,name,icon:'🌐',difficulty:1,description:'Import HTML: '+f.name,tags:['import','html'],cards,author:'Import HTML',source:'html',version:1,created:Date.now(),updated:Date.now()});
      toast(`${cards.length} cartes importées depuis HTML!`,'ach');rWorkspace();rLib();rHome();
    }catch(err){toast('Erreur HTML: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

/* ─── IMPORT JSON (workspace variant) ─── */
function wsImportJSON(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();rd.onload=async ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      const decks=Array.isArray(data)?data:data.cards?[data]:[];
      if(!decks.length){toast('Format JSON invalide','err');return}
      for(const dk of decks){
        if(!dk.name||!dk.cards)continue;
        const id=dk.id||'imp-'+Date.now()+'-'+Math.random().toString(36).slice(2,5);
        await put('decks',{id,name:dk.name,icon:dk.icon||'📥',difficulty:dk.difficulty||1,description:dk.description||'',tags:dk.tags||[],cards:dk.cards,author:dk.author||'Import',source:'json',version:dk.version||1,created:Date.now(),updated:Date.now()});
      }
      toast(`${decks.length} deck(s) importé(s)!`,'ach');rWorkspace();rLib();rHome();
    }catch(err){toast('Erreur JSON: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

/* ─── IMPORT JSON-LD ─── */
function wsImportJSONLD(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();rd.onload=async ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      const cards=[];
      function extract(d){
        if(d['@type']==='FAQPage'&&d.mainEntity){
          d.mainEntity.forEach(q=>{
            const question=q.name||q['@value']||'';
            const answer=q.acceptedAnswer?.text||q.acceptedAnswer?.['@value']||'';
            if(question&&answer)cards.push({q:question,a:answer});
          });
        }
        if(d['@type']==='Quiz'&&d.hasPart){
          d.hasPart.forEach(p=>{
            if(p.text&&p.acceptedAnswer)cards.push({q:p.text,a:typeof p.acceptedAnswer==='string'?p.acceptedAnswer:p.acceptedAnswer.text||''});
          });
        }
        if(d['@graph'])d['@graph'].forEach(extract);
      }
      extract(data);
      if(!cards.length){toast('Aucun FAQPage/Quiz trouvé dans le JSON-LD','err');return}
      const name=f.name.replace(/\.[^.]+$/,'').replace(/[_-]/g,' ');
      const id='imp-'+Date.now()+'-ld';
      await put('decks',{id,name,icon:'🔗',difficulty:1,description:'Import JSON-LD',tags:['import','schema.org','json-ld'],cards,author:'Import JSON-LD',source:'jsonld',version:1,created:Date.now(),updated:Date.now()});
      toast(`${cards.length} cartes importées depuis JSON-LD!`,'ach');rWorkspace();rLib();rHome();
    }catch(err){toast('Erreur JSON-LD: '+err.message,'err')}
  };rd.readAsText(f);e.target.value='';
}

/* ═══ EXPORT ENGINE ═══ */
async function wsGetDeck(){
  const sel=$('ws-exp-dk').value;
  if(sel==='__all'){
    const all=await getAll('decks');
    return{name:'COGWAR-All',cards:all.flatMap(d=>(d.cards||[]).map(c=>({...c,_deck:d.name}))),decks:all};
  }
  const d=await get('decks',sel);
  if(!d){toast('Deck introuvable','err');return null}
  return d;
}

async function wsExport(fmt){
  const dk=await wsGetDeck();if(!dk)return;
  const slug=dk.name.replace(/[^a-zA-Z0-9]/g,'_').slice(0,40);
  switch(fmt){
    case 'csv': return wsExpCSV(dk,slug);
    case 'md': return wsExpMD(dk,slug);
    case 'html': return wsExpHTML(dk,slug);
    case 'json': return wsExpJSON(dk,slug);
    case 'anki': return wsExpAnki(dk,slug);
    case 'jsonld': return wsExpJSONLD(dk,slug);
    case 'geo-html': return wsExpGEO(dk,slug);
    case 'rdf': return wsExpRDF(dk,slug);
    case 'sitemap': return wsExpSitemap(dk,slug);
    case 'opengraph': return wsExpOG(dk,slug);
  }
}

async function wsExpAll(){
  const all=await getAll('decks');if(!all.length){toast('Aucun deck','err');return}
  const bundle={exported:new Date().toISOString(),version:'COGWAR-ULTIMATE',count:all.length,totalCards:all.reduce((s,d)=>s+(d.cards?.length||0),0),decks:all.map(d=>({id:d.id,name:d.name,icon:d.icon,difficulty:d.difficulty,description:d.description,tags:d.tags,author:d.author,cards:d.cards}))};
  wsShowPreview(JSON.stringify(bundle,null,2),'cogwar-bundle-'+Date.now()+'.json','application/json',`Bundle complet: ${all.length} decks · ${bundle.totalCards} cartes`);
}

/* ─── CSV Export ─── */
function wsExpCSV(dk,slug){
  const csvEsc=s=>'"'+String(s||'').replace(/"/g,'""')+'"';
  let out='Question;Réponse\n';
  (dk.cards||[]).forEach(c=>{out+=csvEsc(c.q)+';'+csvEsc(c.a)+'\n'});
  wsShowPreview(out,slug+'.csv','text/csv',`CSV: ${dk.cards?.length||0} cartes · séparateur: point-virgule`);
}

/* ─── Markdown Export ─── */
function wsExpMD(dk,slug){
  let md=`# ${dk.name}\n\n`;
  if(dk.description)md+=`> ${dk.description}\n\n`;
  md+=`**${dk.cards?.length||0} flashcards** · Difficulté: ${'★'.repeat(dk.difficulty||1)}${'☆'.repeat(3-(dk.difficulty||1))} · Source: COGWAR\n\n---\n\n`;
  (dk.cards||[]).forEach((c,i)=>{
    md+=`## ${i+1}. ${c.q}\n\n${c.a}\n\n---\n\n`;
  });
  md+=`\n*Exporté depuis COGWAR ULTIMATE — ${new Date().toLocaleDateString('fr-FR')}*\n`;
  wsShowPreview(md,slug+'.md','text/markdown',`Markdown: ${dk.cards?.length||0} cartes · Obsidian/Notion/GitHub compatible`);
}

/* ─── Anki Export (tab-separated) ─── */
function wsExpAnki(dk,slug){
  let out='#separator:tab\n#html:true\n#deck column:1\n';
  (dk.cards||[]).forEach(c=>{out+=`${c.q}\t${c.a}\t${dk.name}\n`});
  wsShowPreview(out,slug+'-anki.txt','text/plain',`Anki: ${dk.cards?.length||0} cartes · Import via File > Import`);
}

/* ─── JSON Export (native) ─── */
function wsExpJSON(dk,slug){
  const out={id:dk.id,name:dk.name,icon:dk.icon,difficulty:dk.difficulty,description:dk.description,tags:dk.tags,author:dk.author,version:dk.version||1,cards:dk.cards};
  wsShowPreview(JSON.stringify(out,null,2),slug+'.json','application/json',`JSON COGWAR natif: ${dk.cards?.length||0} cartes`);
}

/* ─── HTML Standalone Export ─── */
function wsExpHTML(dk,slug){
  const cards=dk.cards||[];
  const html=`<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${esc(dk.name)} — COGWAR Flashcards</title>
<meta name="description" content="${esc(dk.description||dk.name+' - '+cards.length+' flashcards')}">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:#0a0a14;color:#a3d9a5;padding:20px;max-width:800px;margin:0 auto}
h1{text-align:center;margin-bottom:8px;font-size:22px}
.sub{text-align:center;color:#888;font-size:12px;margin-bottom:24px}
.card{background:#12122a;border:1px solid #1e1e3e;border-radius:8px;margin-bottom:12px;overflow:hidden}
.q{padding:14px 16px;font-weight:bold;cursor:pointer;position:relative}
.q::after{content:'▼';position:absolute;right:16px;top:14px;font-size:10px;color:#666;transition:transform .2s}
.q.open::after{transform:rotate(180deg)}
.a{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .3s,padding .3s;color:#c4a8e6;border-top:1px solid transparent}
.a.show{max-height:500px;padding:12px 16px;border-top:1px solid #1e1e3e}
.n{text-align:center;color:#444;font-size:10px;margin-top:20px}
dl{margin-top:24px}dt{color:#a3d9a5;font-weight:bold;padding:8px 0 4px}dd{color:#c4a8e6;padding:0 0 12px 16px;border-bottom:1px solid #1e1e3e}
</style>
</head>
<body>
<h1>${esc(dk.name)}</h1>
<p class="sub">${cards.length} flashcards · COGWAR ULTIMATE</p>
${cards.map((c,i)=>`<div class="card"><div class="q" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('show')">${i+1}. ${esc(c.q)}</div><div class="a">${esc(c.a)}</div></div>`).join('\n')}
<h2 style="margin-top:32px;font-size:16px;color:#c4a8e6">Format définition (accessible)</h2>
<dl>
${cards.map(c=>`<dt>${esc(c.q)}</dt><dd>${esc(c.a)}</dd>`).join('\n')}
</dl>
<p class="n">Exporté depuis COGWAR ULTIMATE — ${new Date().toLocaleDateString('fr-FR')}</p>
</body></html>`;
  wsShowPreview(html,slug+'.html','text/html',`HTML autonome: ${cards.length} cartes · ouvrable dans tout navigateur`);
}

/* ─── JSON-LD Schema.org FAQPage ─── */
function wsExpJSONLD(dk,slug){
  const cards=dk.cards||[];
  const ld={"@context":"https://schema.org","@type":"FAQPage","name":dk.name,"description":dk.description||'','inLanguage':'fr','dateModified':new Date().toISOString(),"publisher":{"@type":"Organization","name":"COGWAR","url":"https://github.com/cogwar"},"mainEntity":cards.map(c=>({"@type":"Question","name":c.q,"acceptedAnswer":{"@type":"Answer","text":c.a}}))};
  wsShowPreview(JSON.stringify(ld,null,2),slug+'-faqpage.jsonld','application/ld+json',`JSON-LD FAQPage: ${cards.length} questions · Schema.org valide`);
}

/* ─── GEO-Optimized HTML ─── */
function wsExpGEO(dk,slug){
  const cards=dk.cards||[];
  const desc=dk.description||dk.name+' — '+cards.length+' questions essentielles';
  const jsonld=JSON.stringify({"@context":"https://schema.org","@type":"FAQPage","name":dk.name,"description":desc,"inLanguage":"fr","datePublished":new Date().toISOString(),"publisher":{"@type":"Organization","name":"COGWAR"},"mainEntity":cards.map(c=>({"@type":"Question","name":c.q,"acceptedAnswer":{"@type":"Answer","text":c.a}}))},null,2);
  const courseLD=JSON.stringify({"@context":"https://schema.org","@type":"Course","name":dk.name,"description":desc,"provider":{"@type":"Organization","name":"COGWAR"},"educationalLevel":"Intermediate","inLanguage":"fr","hasPart":cards.map((c,i)=>({"@type":"LearningResource","name":`Q${i+1}: ${c.q.slice(0,80)}`,"description":c.a.slice(0,200)}))},null,2);
  const html=`<!DOCTYPE html>
<html lang="fr" prefix="og: https://ogp.me/ns#">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${esc(dk.name)} — Guide complet | COGWAR</title>
<meta name="description" content="${esc(desc)}">
<meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large">
<link rel="canonical" href="https://cogwar.github.io/${slug.toLowerCase()}">
<!-- OpenGraph -->
<meta property="og:type" content="article">
<meta property="og:title" content="${esc(dk.name)}">
<meta property="og:description" content="${esc(desc)}">
<meta property="og:site_name" content="COGWAR">
<meta property="og:locale" content="fr_FR">
<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="${esc(dk.name)}">
<meta name="twitter:description" content="${esc(desc)}">
<!-- Structured Data: FAQPage -->
<script type="application/ld+json">${jsonld}<\/script>
<!-- Structured Data: Course -->
<script type="application/ld+json">${courseLD}<\/script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#fafafa;color:#1a1a2e;line-height:1.7;max-width:760px;margin:0 auto;padding:24px 16px}
h1{font-size:28px;margin-bottom:8px;color:#0a0a14}
.lead{color:#555;font-size:15px;margin-bottom:24px;line-height:1.6}
.toc{background:#f0f0f0;border-radius:8px;padding:16px 20px;margin-bottom:28px}
.toc h2{font-size:14px;margin-bottom:8px;color:#333}
.toc ol{padding-left:20px}.toc li{font-size:13px;margin-bottom:4px}
.toc a{color:#2563eb;text-decoration:none}.toc a:hover{text-decoration:underline}
.faq-item{border-bottom:1px solid #e5e7eb;padding:20px 0}
.faq-q{font-size:17px;font-weight:600;color:#1a1a2e;margin-bottom:8px;cursor:pointer}
.faq-q::before{content:'❓ '}
.faq-a{color:#374151;font-size:15px;line-height:1.7}
.breadcrumb{font-size:12px;color:#888;margin-bottom:16px}
.breadcrumb a{color:#2563eb;text-decoration:none}
footer{margin-top:40px;padding:20px 0;border-top:1px solid #e5e7eb;color:#888;font-size:12px;text-align:center}
@media(prefers-color-scheme:dark){body{background:#0a0a14;color:#e5e7eb}h1{color:#a3d9a5}.faq-q{color:#a3d9a5}.faq-a{color:#c4a8e6}.toc{background:#12122a}.toc h2{color:#a3d9a5}.toc a{color:#60a5fa}footer{border-color:#1e1e3e;color:#666}.breadcrumb{color:#666}.breadcrumb a{color:#60a5fa}.faq-item{border-color:#1e1e3e}}
</style>
</head>
<body>
<nav class="breadcrumb" aria-label="breadcrumb"><a href="/">COGWAR</a> › <a href="/decks">Flashcards</a> › ${esc(dk.name)}</nav>
<article>
<h1>${esc(dk.name)}</h1>
<p class="lead">${esc(desc)} Ce guide couvre ${cards.length} questions fondamentales avec leurs réponses détaillées.</p>
<nav class="toc" aria-label="table of contents"><h2>📋 Sommaire (${cards.length} questions)</h2><ol>
${cards.map((c,i)=>`<li><a href="#q${i+1}">${esc(c.q)}</a></li>`).join('\n')}
</ol></nav>
${cards.map((c,i)=>`<section class="faq-item" id="q${i+1}" itemscope itemtype="https://schema.org/Question"><h2 class="faq-q" itemprop="name">${esc(c.q)}</h2><div class="faq-a" itemscope itemtype="https://schema.org/Answer" itemprop="acceptedAnswer"><p itemprop="text">${esc(c.a)}</p></div></section>`).join('\n')}
</article>
<footer>COGWAR ULTIMATE · ${cards.length} flashcards · Exporté le ${new Date().toLocaleDateString('fr-FR')} · <a href="https://github.com/cogwar" style="color:#2563eb">Source</a></footer>
</body></html>`;
  wsShowPreview(html,slug+'-geo.html','text/html',`GEO Page: ${cards.length} Q/R · FAQPage + Course JSON-LD · OpenGraph · Microdata · TOC · Dark mode`);
}

/* ─── RDF/Turtle Export ─── */
function wsExpRDF(dk,slug){
  const cards=dk.cards||[];
  const baseURI='https://cogwar.github.io/resource/';
  let ttl=`@prefix schema: <https://schema.org/> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cogwar: <${baseURI}> .

cogwar:${slug} a schema:FAQPage, schema:Course ;
  schema:name "${dk.name.replace(/"/g,'\\"')}" ;
  schema:description "${(dk.description||'').replace(/"/g,'\\"')}" ;
  schema:inLanguage "fr" ;
  dcterms:created "${new Date().toISOString()}"^^xsd:dateTime ;
  schema:publisher [ a schema:Organization ; schema:name "COGWAR" ] .\n\n`;
  cards.forEach((c,i)=>{
    const qid=`cogwar:${slug}_q${i+1}`;
    ttl+=`${qid} a schema:Question ;
  schema:name "${c.q.replace(/"/g,'\\"')}" ;
  schema:acceptedAnswer [ a schema:Answer ; schema:text "${c.a.replace(/"/g,'\\"')}" ] ;
  schema:isPartOf cogwar:${slug} ;
  skos:notation "${i+1}" .\n\n`;
  });
  wsShowPreview(ttl,slug+'.ttl','text/turtle',`RDF/Turtle: ${cards.length} triplets · SPARQL-queryable · Compatible Wikidata/DBpedia`);
}

/* ─── Sitemap XML ─── */
async function wsExpSitemap(dk,slug){
  const dks=await getAll('decks');
  const base='https://cogwar.github.io';
  let xml=`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url><loc>${base}/</loc><lastmod>${new Date().toISOString().slice(0,10)}</lastmod><changefreq>weekly</changefreq><priority>1.0</priority></url>\n`;
  dks.forEach(d=>{
    const s=d.name.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();
    xml+=`  <url><loc>${base}/decks/${s}</loc><lastmod>${new Date(d.updated||Date.now()).toISOString().slice(0,10)}</lastmod><changefreq>monthly</changefreq><priority>0.8</priority></url>\n`;
  });
  EN.forEach(e=>{
    xml+=`  <url><loc>${base}/ency/${e.id}</loc><changefreq>monthly</changefreq><priority>0.7</priority></url>\n`;
  });
  xml+=`</urlset>`;
  wsShowPreview(xml,'sitemap.xml','application/xml',`Sitemap XML: ${dks.length} decks + ${EN.length} entrées encyclopédie`);
}

/* ─── OpenGraph Meta snippet ─── */
function wsExpOG(dk,slug){
  const cards=dk.cards||[];
  const desc=dk.description||dk.name+' — '+cards.length+' flashcards';
  const snippet=`<!-- OpenGraph Meta Tags — à copier dans votre <head> -->
<meta property="og:type" content="article">
<meta property="og:title" content="${esc(dk.name)} — COGWAR">
<meta property="og:description" content="${esc(desc)}">
<meta property="og:url" content="https://cogwar.github.io/decks/${slug.toLowerCase()}">
<meta property="og:site_name" content="COGWAR — Cognitive Warfare Education">
<meta property="og:locale" content="fr_FR">
<meta property="article:section" content="Education">
<meta property="article:tag" content="guerre cognitive">
<meta property="article:tag" content="flashcards">
${(dk.tags||[]).map(t=>`<meta property="article:tag" content="${esc(t)}">`).join('\n')}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="${esc(dk.name)}">
<meta name="twitter:description" content="${esc(desc)}">

<!-- Dublin Core -->
<meta name="DC.title" content="${esc(dk.name)}">
<meta name="DC.creator" content="${esc(dk.author||'COGWAR')}">
<meta name="DC.subject" content="Guerre cognitive, éducation">
<meta name="DC.description" content="${esc(desc)}">
<meta name="DC.language" content="fr">
<meta name="DC.format" content="text/html">

<!-- Citation / Scholar -->
<meta name="citation_title" content="${esc(dk.name)}">
<meta name="citation_author" content="${esc(dk.author||'COGWAR')}">
<meta name="citation_date" content="${new Date().toISOString().slice(0,10)}">
<meta name="citation_language" content="fr">`;
  wsShowPreview(snippet,slug+'-meta.html','text/html',`Meta tags: OG + Twitter + Dublin Core + Scholar · à coller dans <head>`);
}

/* ═══ END WORKSPACE ENGINE ═══ */

/* ═══ STORE (DECKS + ENCY) ═══ */
let storeCache=null,encyStoreCache=null,storeMode='dk';

function storeTab(mode){
  storeMode=mode;
  $('st-tab-dk').classList.toggle('on',mode==='dk');
  $('st-tab-en').classList.toggle('on',mode==='en');
  rStore();
}

async function rStore(){
  try{
  $('store-load').style.display='block';$('store-list').innerHTML='';
  
  if(storeMode==='dk'){
    // --- DECK STORE ---
    if(!storeCache){
      try{const r=await fetch('decks/index.json');if(r.ok)storeCache=await r.json()}catch(e){}
    }
    if(!storeCache){
      storeCache={decks:BUILTIN_DECKS.map(d=>({file:null,id:d.id,name:d.name,author:d.author,difficulty:d.difficulty,count:d.cards.length,description:d.description,tags:d.tags,icon:d.icon,version:d.version||1,_embedded:true}))};
    }
    const installed=new Map((await getAll('decks')).map(d=>[d.id,d.version||0]));
    $('store-load').style.display='none';
    if(!storeCache.decks.length){$('store-list').innerHTML='<div class="sr-empty"><div class="sr-e-ico">📦</div>Aucun deck disponible</div>';return}
    $('store-list').innerHTML=storeCache.decks.map(d=>{
      const hasIt=installed.has(d.id);
      const canUpdate=hasIt&&d.version>(installed.get(d.id)||0);
      return `<div class="sti"><div class="sti-ico">${d.icon||'📦'}</div><div style="flex:1;min-width:0"><div class="sti-t">${esc(d.name)}</div><div class="sti-d">${esc(d.description||'')}</div><div class="sti-meta"><span class="dd d${d.difficulty}"></span>${d.count||'?'} cartes · ${esc(d.author||'')}</div><button class="sti-btn ${hasIt&&!canUpdate?'done':''}" onclick="${hasIt&&!canUpdate?'':`storeInstallDk('${d.id}','${d.file||''}')`}">${canUpdate?'⬆ Maj':hasIt?'✓ Installé':'Installer'}</button></div></div>`;
    }).join('');
  } else {
    // --- ENCYCLOPEDIA STORE ---
    if(!encyStoreCache){
      try{const r=await fetch('ency/index.json');if(r.ok)encyStoreCache=await r.json()}catch(e){}
    }
    if(!encyStoreCache){
      // Fallback: generate from embedded EN
      encyStoreCache={entries:EN.map(e=>({id:e.id,title:e.t,cat:e.cat,xp:e.xp,short:e.sh,tags:e.tags,file:null,_embedded:true}))};
    }
    $('store-load').style.display='none';
    if(!encyStoreCache.entries.length){$('store-list').innerHTML='<div class="sr-empty"><div class="sr-e-ico">◈</div>Aucune entrée disponible</div>';return}
    const installedIds=EN.map(e=>e.id);
    $('store-list').innerHTML=encyStoreCache.entries.map(e=>{
      const hasIt=installedIds.includes(e.id);
      return `<div class="sti"><div class="sti-ico">◈</div><div style="flex:1;min-width:0"><div class="sti-t">${esc(e.title)}</div><div class="sti-d">${esc(e.short||'')}</div><div class="sti-meta">${esc(e.cat)} · ${e.tags?.join(', ')||''} · +${e.xp} XP</div><button class="sti-btn ${hasIt?'done':''}" onclick="${hasIt?'':`storeInstallEn('${e.id}','${e.file||''}')`}">${hasIt?'✓ Intégré':'Installer'}</button></div></div>`;
    }).join('');
  }
}catch(e){console.error('rStore:',e)}
}

async function storeInstallDk(id,file){
  toast('Installation du deck...');
  try{
    let data;
    if(file){const r=await fetch('decks/'+file);if(!r.ok)throw new Error('Fichier introuvable');data=await r.json()}
    else{data=BUILTIN_DECKS.find(d=>d.id===id);if(!data)throw new Error('Deck introuvable')}
    await put('decks',{...data,id:data.id||id,source:'store',installed:Date.now()});
    toast(`"${data.name}" installé! (${data.cards.length} cartes)`,'ach');rStore();rHome();
  }catch(e){toast('Erreur: '+e.message,'err')}
}

async function storeInstallEn(id,file){
  toast('Installation entrée...');
  try{
    let data;
    if(file){const r=await fetch('ency/'+file);if(!r.ok)throw new Error('Fichier introuvable');data=await r.json()}
    else{data=EN.find(e=>e.id===id);if(data){toast('Déjà intégrée','err');return}throw new Error('Entrée introuvable')}
    // Add to runtime EN array
    const entry={id:data.id,t:data.title,cat:data.cat,tags:data.tags,xp:data.xp,sh:data.short,b:data.body};
    if(!EN.find(e=>e.id===entry.id)){EN.push(entry)}
    // Persist custom entries
    await put('meta',{k:'custom_ency',v:EN.filter(e=>!BUILTIN_EN_IDS.includes(e.id))});
    rTags();rEN(EN);rStore();
    toast(`"${data.title}" installée!`,'ach');
  }catch(e){toast('Erreur: '+e.message,'err')}
}

// Track which entries are builtin vs user-installed
let BUILTIN_EN_IDS=[];

async function loadCustomEncy(){
  try{
  const custom=await get('meta','custom_ency');
  if(custom&&custom.v){
    for(const e of custom.v){
      if(!EN.find(x=>x.id===e.id))EN.push(e);
    }
  }
}catch(e){console.error('loadCustomEncy:',e)}
}

/* ═══ ENCYCLOPEDIA ═══ */
const EN=[
  {id:'gc',t:'Guerre Cognitive',cat:'Fondamental',tags:['doctrine','fondamentaux'],xp:25,sh:'Stratégie ciblant le cerveau pour altérer le traitement de l\'information.',b:'<h3>Définition</h3><p>Utilise les technologies pour influencer ou perturber la cognition. Cible les processus subconscients.</p><h3>Distinction</h3><p>Info = contrôle des données. Cognitive = altération du <em>processing</em>.</p><h3>Trois piliers</h3><ul><li><strong>Effets cognitifs</strong> (biais)</li><li><strong>Hostilité asymétrique</strong> (zone grise)</li><li><strong>Amplification techno</strong> (IA/Big Data)</li></ul>'},
  {id:'6d',t:'Le Sixième Domaine',cat:'Fondamental',tags:['doctrine','otan'],xp:25,sh:'Le cerveau comme 6ᵉ domaine de la guerre (OTAN NWCC 2021).',b:'<h3>Concept</h3><p>L\'OTAN identifie l\'esprit humain comme <strong>sixième domaine</strong>. La souveraineté dépend de l\'intégrité cognitive.</p>'},
  {id:'ooda',t:'Boucle OODA',cat:'Mécanisme',tags:['décision','stratégie'],xp:30,sh:'Observation, Orientation, Décision, Action — cycle saboté.',b:'<ul><li><strong>Observation</strong> saturée</li><li><strong>Orientation</strong> biaisée</li><li><strong>Décision</strong> paralysée</li><li><strong>Action</strong> désordonnée</li></ul>'},
  {id:'se',t:'Signal d\'Erreur',cat:'Neurobiologie',tags:['neurosciences','cerveau'],xp:30,sh:'Alerte neuronale exploitée pour stress ou soumission.',b:'<h3>Deux modes</h3><ul><li><strong>Sous le seuil :</strong> Doute diffus</li><li><strong>Saturation :</strong> Stress → décision dégradée</li></ul><table><tr><th>Zone</th><th>Agression</th><th>Effet</th></tr><tr><td>Cortex Préfrontal</td><td>Inhibition</td><td>Paralysie</td></tr><tr><td>Amygdale</td><td>Hyper-activation</td><td>Impulsivité</td></tr></table>'},
  {id:'sr',t:'Stimulation Répétée',cat:'Neurobiologie',tags:['neurosciences'],xp:20,sh:'Le faux devient familier par exposition itérative.',b:'<p>Exposition itérative → réduction du coût métabolique → acceptation par <strong>économie d\'énergie cognitive</strong>.</p>'},
  {id:'sir',t:'Modèle SIR',cat:'Modélisation',tags:['mathématiques','propagation'],xp:35,sh:'Ignorants → Propagateurs → Étouffeurs. R₀ > 1 = contagion.',b:'<div class="formula">R₀ = (β × N) / (α + γ + μ)</div><p>R₀ > 1 → contagion exponentielle.</p>'},
  {id:'ch',t:'Théorie du Chaos',cat:'Asymétrie',tags:['chaos','mathématiques'],xp:35,sh:'Effet papillon informationnel.',b:'<div class="formula">dx/dt = σ(y − x) · dy/dt = x(ρ − z) − y</div><p>Variation infime de ρ (méfiance) → basculement vers le chaos.</p>'},
  {id:'sc',t:'Stratège du Chaos',cat:'Asymétrie',tags:['chaos','asymétrie'],xp:25,sh:'Rendre le système adverse ingouvernable.',b:'<p>Ne pas vaincre mais <strong>paralyser</strong>. Convaincre qu\'aucune solution stable n\'existe.</p>'},
  {id:'otan',t:'Doctrine OTAN',cat:'Géopolitique',tags:['doctrine','otan'],xp:25,sh:'Out-think et out-pace l\'adversaire.',b:'<p><strong>Cognitive Superiority</strong> : protéger les processus décisionnels démocratiques (NWCC 2021).</p>'},
  {id:'ru',t:'Contrôle Réflexif',cat:'Géopolitique',tags:['doctrine','russie'],xp:25,sh:'Décision « libre » pré-déterminée par Moscou.',b:'<p>Transmettre des infos pour que l\'adversaire décide <strong>de plein gré</strong> selon la volonté russe.</p>'},
  {id:'cn',t:'Domination Algorithmique',cat:'Géopolitique',tags:['doctrine','chine','ia'],xp:30,sh:'6 étapes chinoises du Big Data au verrouillage.',b:'<ul><li>Portrait → Attraction → Suggestion → Induction → Intervention → Supervision</li></ul>'},
  {id:'mc',t:'Micro-ciblage',cat:'Technologies',tags:['ia','manipulation'],xp:25,sh:'Big Data + IA = exploitation des failles individuelles.',b:'<ul><li>Instabilité émotionnelle (prédicteur n°1)</li><li>Biais de confirmation</li><li>Besoin d\'appartenance</li></ul>'},
  {id:'rd',t:'Résilience Dynamique',cat:'Défense',tags:['défense','résilience'],xp:25,sh:'Combattre à travers la perturbation.',b:'<ul><li><strong>Extensibilité gracieuse</strong></li><li><strong>Adaptabilité soutenue</strong></li></ul>'},
  {id:'im',t:'Immunisation Cognitive',cat:'Défense',tags:['défense','éducation'],xp:25,sh:'Vaccination contre la capture motivationnelle.',b:'<p>Éducation aux biais, esprit critique, jeux de guerre. <strong>Projet Gecko</strong> (Inalco/ENSC/IRSEM).</p>'},
  {id:'rq',t:'Équation du Risque',cat:'Modélisation',tags:['mathématiques','défense'],xp:30,sh:'Risque = (Menace × Vulnérabilité) / Capacité.',b:'<div class="formula">Risque = (Menace × Vulnérabilité) / Capacité</div>'},
  {id:'ce',t:'Chambre d\'Écho',cat:'Propagation',tags:['propagation','réseaux'],xp:20,sh:'Bulle algorithmique → polarisation.',b:'<p>Algorithmes ne montrant que du contenu aligné → cocons sémantiques → fermeture épistémique.</p>'},
  {id:'fe',t:'Fermeture Épistémique',cat:'Propagation',tags:['propagation'],xp:20,sh:'Rejet systématique de toute info contradictoire.',b:'<p>Même le fact-checking peut engendrer méfiance → rejet de toute autorité.</p>'},
  {id:'zg',t:'Zone Grise',cat:'Asymétrie',tags:['stratégie','asymétrie'],xp:20,sh:'Conflit sous le seuil militaire.',b:'<p>Libertés démocratiques deviennent vulnérabilités. Riposte conventionnelle inadaptée.</p>'},
  {id:'hv',t:'Syndrome de La Havane',cat:'Neurobiologie',tags:['neurosciences'],xp:20,sh:'Cerveau physiquement vulnérable.',b:'<p>2016 : altérations neurobiologiques via énergie dirigée.</p>'},
  {id:'df',t:'Defend Forward',cat:'Défense',tags:['défense','cyber'],xp:20,sh:'Engager l\'adversaire dans ses réseaux.',b:'<p>Engagement proactif sur les réseaux adverses <strong>avant</strong> les attaques.</p>'},
  {id:'cs',t:'Cocon Sémantique',cat:'Propagation',tags:['propagation','ia','réseaux'],xp:25,sh:'Enfermement algorithmique dans un flux confirmant uniquement les préjugés de la cible.',b:'<h3>Mécanisme</h3><p>Les algorithmes de recommandation créent des <strong>cocons sémantiques</strong> : flux d\'informations qui confirment uniquement les croyances existantes.</p><h3>Exploitation</h3><ul><li>L\'individu ne voit que du contenu aligné avec ses biais.</li><li>Le sentiment de consensus artificiel renforce la conviction.</li><li>Toute information contradictoire est filtrée ou rejetée.</li></ul><p>Ce mécanisme est l\'étape 4 du protocole chinois de domination algorithmique.</p>'},
  {id:'po',t:'PSYOPS vs Guerre Cognitive',cat:'Fondamental',tags:['fondamentaux','stratégie'],xp:30,sh:'De « convaincre » à « altérer » : la rupture entre opérations psychologiques et manipulation cognitive.',b:'<h3>La rupture</h3><table><tr><th>Dimension</th><th>PSYOPS</th><th>Guerre Cognitive</th></tr><tr><td>Vecteurs</td><td>Médias, tracts</td><td>Algorithmes, IA, neurotech</td></tr><tr><td>Cibles</td><td>Opinion (conscient)</td><td>Processus subconscients</td></tr><tr><td>Objectif</td><td>Ce que les gens pensent</td><td>Comment ils pensent</td></tr><tr><td>Temporalité</td><td>Ponctuelle</td><td>Permanente, bas bruit</td></tr></table>'},
  {id:'ic',t:'Inflexibilité Cognitive',cat:'Neurobiologie',tags:['neurosciences','mécanismes'],xp:20,sh:'Incapacité à réviser ses schémas face aux faits — vulnérabilité micro-individuelle n°1.',b:'<h3>Déclencheurs de vulnérabilité</h3><ul><li><strong>Inflexibilité cognitive :</strong> Refus de mettre à jour ses croyances malgré des données contraires.</li><li><strong>Besoin d\'appartenance sociale :</strong> Validation de narratifs de groupe au prix de la vérité.</li><li><strong>Excitation émotionnelle :</strong> Court-circuitage des filtres rationnels par la colère ou l\'indignation.</li></ul><p>L\'instabilité émotionnelle est le prédicteur n°1 de la réceptivité algorithmique.</p>'},
  {id:'ce2',t:'Court-circuitage Émotionnel',cat:'Neurobiologie',tags:['neurosciences','mécanismes','cerveau'],xp:25,sh:'Amygdale vs Cortex Préfrontal : quand l\'émotion prend le contrôle de la décision.',b:'<h3>Cortex vs Amygdale</h3><table><tr><th>Zone</th><th>Fonction</th><th>Effet de l\'agression</th></tr><tr><td>Cortex Préfrontal</td><td>Analyse, rationalité</td><td>Inhibition par stress</td></tr><tr><td>Amygdale</td><td>Émotions, survie</td><td>Hyper-activation</td></tr></table><p>L\'utilisation de narratifs chargés de <strong>peur ou de colère</strong> vise à privilégier l\'amygdale, favorisant des réactions impulsives et prévisibles.</p>'},
  {id:'cy',t:'Cadre Cynefin',cat:'Modélisation',tags:['modélisation','stratégie'],xp:30,sh:'Framework de Snowden : Simple → Compliqué → Complexe → Chaotique → Désordonné.',b:'<h3>4 domaines</h3><table><tr><th>Domaine</th><th>Action</th><th>Effet d\'attaque</th></tr><tr><td>Simple</td><td>Percevoir-Catégoriser-Répondre</td><td>Subversion des normes</td></tr><tr><td>Compliqué</td><td>Percevoir-Analyser-Répondre</td><td>Saturation par le bruit</td></tr><tr><td>Complexe</td><td>Sonder-Percevoir-Répondre</td><td>Fausses pistes systémiques</td></tr><tr><td>Chaotique</td><td>Agir-Percevoir-Répondre</td><td>Paralysie totale</td></tr></table><p>L\'objectif de l\'agresseur : pousser du Compliqué vers le <strong>Chaotique</strong> où les liens de causalité disparaissent.</p>'},
  {id:'dk',t:'Deepfakes & IA Générative',cat:'Technologies',tags:['ia','technologies','manipulation'],xp:25,sh:'Subversion de la réalité par production massive de médias synthétiques indétectables.',b:'<h3>Rupture</h3><p>L\'IA générative permet la <strong>subversion de la réalité partagée</strong> par la production massive de médias synthétiques indétectables.</p><h3>Utilisations offensives</h3><ul><li>Désarçonner le cadre cognitif existant de la cible (étape 2 du protocole chinois).</li><li>Simuler un faux consensus via manipulation de la viralité.</li><li>Créer des « preuves » audiovisuelles de faits inexistants.</li></ul>'},
  {id:'na',t:'Neuro-armes',cat:'Technologies',tags:['neurosciences','technologies','neuroarmes'],xp:35,sh:'Vecteurs émergents ciblant directement le support biologique de la pensée.',b:'<h3>Classification</h3><ul><li><strong>Rayonnements EM :</strong> Énergie dirigée (cf. Syndrome de La Havane).</li><li><strong>Manipulation pharmacologique :</strong> Substances altérant les capacités cognitives.</li><li><strong>Interface cerveau-machine :</strong> Exploitation des neurotechnologies connectées.</li></ul><h3>Vecteurs de pénétration</h3><table><tr><th>Catégorie</th><th>Exemples</th></tr><tr><td>Traditionnels</td><td>Presse, diplomatie publique</td></tr><tr><td>Existants</td><td>Algorithmes, objets connectés, réseaux sociaux</td></tr><tr><td>Émergents</td><td>Neuro-armes, métavers, IA massive</td></tr></table>'},
  {id:'cm',t:'Capture Motivationnelle',cat:'Propagation',tags:['propagation','mécanismes'],xp:25,sh:'Quand l\'individu agit par motivation implantée tout en croyant à sa propre autonomie.',b:'<h3>Définition</h3><p>L\'érosion de la <strong>souveraineté cognitive</strong> du décideur : il finit par adopter des comportements dictés par l\'agresseur tout en étant convaincu de sa propre autonomie de pensée.</p><h3>La vaccination</h3><p>L\'immunisation cognitive consiste à s\'exposer à des formes « atténuées » de manipulation pour construire des <strong>anticorps cognitifs</strong> — exactement ce que COGWAR vous fait vivre.</p>'},
  {id:'lo',t:'Attracteur de Lorenz',cat:'Modélisation',tags:['mathématiques','modélisation','asymétrie'],xp:35,sh:'dx/dt = σ(y−x) — Quand une variation infinitésimale de ρ fait basculer une société dans le chaos.',b:'<h3>Équations</h3><div class="formula">dx/dt = σ(y − x)<br>dy/dt = ρx − y − xz<br>dz/dt = xy − βz</div><h3>Paramètres géostratégiques</h3><table><tr><th>Paramètre</th><th>Signification</th></tr><tr><td>σ (sigma)</td><td>Vélocité de l\'information</td></tr><tr><td>ρ (rho)</td><td>Niveau de méfiance publique</td></tr><tr><td>β (beta)</td><td>Capacité d\'absorption du système</td></tr></table><p>Une variation infinitésimale de ρ peut faire basculer une société stable vers un <strong>désordre permanent</strong>.</p>'},
  {id:'bb',t:'Opérations à Bas Bruit',cat:'Asymétrie',tags:['stratégie','asymétrie','manipulation'],xp:25,sh:'Modification quasi-irréversible des habitudes de pensée sur le temps long, sans alerte.',b:'<h3>Principe</h3><p>Opération sur le temps long modifiant les habitudes de pensée de manière <strong>quasi-irréversible</strong>. L\'agression est permanente, diffuse, et opère sous le seuil de perception consciente.</p><h3>Caractéristiques</h3><ul><li>Pas de signature d\'attaque détectable.</li><li>Effets cumulatifs irréversibles.</li><li>La victime ne sait jamais qu\'elle est ciblée.</li><li>Exploite la fatigue informationnelle comme vecteur d\'acceptation.</li></ul>'},
];
let meI=-1;
BUILTIN_EN_IDS=EN.map(e=>e.id);
const ETAGS=[...new Set(EN.flatMap(e=>e.tags))].sort();let aTag=null;
function rTags(){$('etg').innerHTML='<div class="et on" onclick="fTg(null,this)">Tout</div>'+ETAGS.map(t=>`<div class="et" onclick="fTg(\'${t}\',this)">${t}</div>`).join('')}
function rEN(l){$('eg').innerHTML=l.map(e=>`<div class="ec" onclick="oEN(${EN.indexOf(e)})"><div class="ecc">${e.cat}</div><div class="ect">${e.t}</div><div class="ecd">${e.sh}</div><div class="ecx ${ST.rd.includes(e.id)?'done':''}">${ST.rd.includes(e.id)?'✓':'+'+e.xp}</div></div>`).join('')}
function fTg(t,el){aTag=t;document.querySelectorAll('.et').forEach(x=>x.classList.remove('on'));el?.classList.add('on');fltE()}
function fltE(){const q=$('esr').value.toLowerCase();rEN(EN.filter(e=>(!aTag||e.tags.includes(aTag))&&(!q||e.t.toLowerCase().includes(q)||e.sh.toLowerCase().includes(q))))}
function oEN(i){meI=i;const e=EN[i];$('me-t').textContent=e.t;$('me-bd').innerHTML=e.b;const b=$('me-cl');if(ST.rd.includes(e.id)){b.textContent='✓ LU';b.disabled=true}else{b.textContent=`+${e.xp} XP`;b.disabled=false}omo('mo-en')}
function meP(){oEN((meI-1+EN.length)%EN.length)}
function meN(){oEN((meI+1)%EN.length)}
function meC(){const e=EN[meI];if(ST.rd.includes(e.id))return;ST.rd.push(e.id);addXP(e.xp,e.t);$('me-cl').textContent='✓ LU';$('me-cl').disabled=true;if(ST.rd.length>=1)achk('1st');if(ST.rd.length>=5)achk('5rd');if(ST.rd.length>=EN.length)achk('all');rEN(EN);svST()}

/* ═══ PROFILE & CHARACTER SHEET ENGINE ═══ */
let PROF={name:'OPÉRATEUR',bio:'',avatar:'🤖',photo:null,filter:'none',settings:{fs:13,flip:4,compact:false,scan:true,disc:true,notif:true,sp:true,combo:true,loot:true}};
async function ldProf(){
  try{const p=await get('meta','profile');if(p)PROF=p.v}catch(e){console.error('ldProf:',e)}
}
async function svProf(){await put('meta',{k:'profile',v:PROF})}

/* ─── Classes & Ranks ─── */
const CLASSES=[
  {min:0,name:'RECRUE',icon:'◇',color:'var(--t3)'},
  {min:3,name:'SENTINELLE',icon:'◆',color:'var(--g1)'},
  {min:7,name:'ANALYSTE',icon:'◈',color:'var(--l1)'},
  {min:12,name:'STRATÈGE',icon:'⬡',color:'var(--am)'},
  {min:18,name:'ARCHITECTE',icon:'⬢',color:'#ff6b6b'},
  {min:25,name:'ORACLE',icon:'◉',color:'#c4a8e6'},
  {min:35,name:'GHOST IN THE SHELL',icon:'⊛',color:'#ffd700'},
];
function getClass(lv){let c=CLASSES[0];for(const cl of CLASSES)if(lv>=cl.min)c=cl;return c}

/* ─── Augmentations ─── */
const AUGS=[
  {id:'neural',name:'Lien Neural',icon:'🧠',req:'LV3',check:()=>ST.lv>=3},
  {id:'firewall',name:'Pare-feu',icon:'🛡',req:'10 bonnes réponses',check:()=>ST.fO>=10},
  {id:'optic',name:'Optique Augmentée',icon:'👁',req:'Lire 5 entrées',check:()=>ST.rd.length>=5},
  {id:'reflex',name:'Réflexe Cognitif',icon:'⚡',req:'Streak 5',check:()=>ST.bS>=5},
  {id:'crypto',name:'Module Crypto',icon:'🔐',req:'LV7',check:()=>ST.lv>=7},
  {id:'stealth',name:'Protocole Furtif',icon:'🥷',req:'50 cartes',check:()=>(ST.fO+ST.fK)>=50},
  {id:'hive',name:'Réseau Hivemind',icon:'🌐',req:'3 decks installés',check:()=>true},
  {id:'chrono',name:'Distorsion Chrono',icon:'⏱',req:'Streak 7 jours',check:()=>(ST.dayStreak||0)>=7},
  {id:'quantum',name:'Processeur Quantique',icon:'💎',req:'LV12',check:()=>ST.lv>=12},
  {id:'omega',name:'Protocole Oméga',icon:'☠️',req:'LV18+100% précision',check:()=>ST.lv>=18&&ST.fO>0&&ST.fK===0,legendary:true},
  {id:'wopr',name:'WOPR Override',icon:'🤖',req:'LV25',check:()=>ST.lv>=25,legendary:true},
  {id:'ghost',name:'Ghost in the Shell',icon:'👻',req:'LV35',check:()=>ST.lv>=35,legendary:true},
];

/* ─── Photo System ─── */
const FILTERS=[
  {id:'none',name:'Original',css:'none'},
  {id:'cyber',name:'Cyber',css:'saturate(1.4) hue-rotate(120deg) contrast(1.2)'},
  {id:'neon',name:'Neon',css:'saturate(2) brightness(1.1) hue-rotate(270deg)'},
  {id:'ghost',name:'Ghost',css:'grayscale(.7) brightness(1.3) contrast(.9)'},
  {id:'matrix',name:'Matrix',css:'sepia(1) saturate(3) hue-rotate(70deg) brightness(.8)'},
  {id:'redpill',name:'Red Pill',css:'sepia(.6) saturate(2) hue-rotate(320deg) contrast(1.1)'},
  {id:'thermal',name:'Thermal',css:'saturate(3) hue-rotate(180deg) contrast(1.5) brightness(.9)'},
  {id:'glitch',name:'Glitch',css:'contrast(1.8) brightness(.9) saturate(1.5)'},
];

function handlePhoto(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('Max 5 Mo','err');return}
  const reader=new FileReader();
  reader.onload=function(){
    const img=new Image();
    img.onload=function(){
      const c=document.createElement('canvas');c.width=256;c.height=256;
      const ctx=c.getContext('2d');
      const s=Math.min(img.width,img.height);
      const sx=(img.width-s)/2,sy=(img.height-s)/2;
      ctx.drawImage(img,sx,sy,s,s,0,0,256,256);
      PROF.photo=c.toDataURL('image/jpeg',0.85);
      svProf();renderCharCard();
    };
    img.src=reader.result;
  };
  reader.readAsDataURL(file);e.target.value='';
}
function clearPhoto(){PROF.photo=null;PROF.filter='none';svProf();renderCharCard()}
function setFilter(id){PROF.filter=id;svProf();renderCharCard()}
function renderFilterBtns(){
  const el=$('pf-btns');if(!el)return;
  el.innerHTML=FILTERS.map(f=>`<div class="pf-btn ${PROF.filter===f.id?'on':''}" onclick="setFilter('${f.id}')">${f.name}</div>`).join('');
}

/* ─── Derived Stats ─── */
function calcStats(){
  const total=ST.fO+ST.fK;const acc=total?Math.round(ST.fO/total*100):0;
  const cog=Math.min(99,Math.floor(Math.log2(ST.xp+1)*6));
  const res=Math.min(99,Math.floor((ST.bS*3)+(ST.dayStreak||0)*5));
  const cri=Math.min(99,Math.floor(ST.rd.length*4+acc*0.3));
  return{cog,res,cri,acc,streak:ST.bS,sessions:ST.sessions};
}

/* ─── Render Character Card ─── */
function renderCharCard(){
  const cl=getClass(ST.lv);const stats=calcStats();
  $('ch-class').textContent=`${cl.icon} ${cl.name}`;$('ch-class').style.borderColor=cl.color;$('ch-class').style.color=cl.color;
  $('ch-name').textContent=PROF.name;$('ch-glitch').textContent=PROF.name;
  $('ch-title').textContent=PROF.bio||classTitle(cl.name);
  $('ch-serial').textContent=`WOPR-${String(Math.abs(hashStr(PROF.name))).slice(0,4).padStart(4,'0')} · COGWAR DIVISION`;
  const phEl=$('ph-img'),plEl=$('ph-ph');
  if(PROF.photo){
    phEl.src=PROF.photo;phEl.style.display='block';
    phEl.style.filter=FILTERS.find(f=>f.id===PROF.filter)?.css||'none';
    plEl.style.display='none';$('photo-settings').style.display='';renderFilterBtns();
  }else{phEl.style.display='none';plEl.style.display='';plEl.textContent=PROF.avatar;$('photo-settings').style.display='none'}
  const avBtn=$('av-btn');
  if(PROF.photo){avBtn.innerHTML=`<img src="${PROF.photo}" style="filter:${FILTERS.find(f=>f.id===PROF.filter)?.css||'none'}"><div class="notif" id="notif-dot" style="display:${hasNotif&&PROF.settings.notif?'':'none'}"></div>`}
  else{avBtn.innerHTML=`<span id="av-ico">${PROF.avatar}</span><div class="notif" id="notif-dot" style="display:${hasNotif&&PROF.settings.notif?'':'none'}"></div>`}
  const xpInLv=ST.xp%100;$('ch-lv').textContent=ST.lv;$('ch-lv').style.borderColor=cl.color;$('ch-lv').style.color=cl.color;
  $('ch-nxlv').textContent=ST.lv+1;$('ch-xpf').style.width=(xpInLv)+'%';$('ch-xp').textContent=xpInLv;$('ch-xpmax').textContent=100;
  $('cs-cog').textContent=stats.cog;$('csb-cog').style.width=stats.cog+'%';
  $('cs-res').textContent=stats.res;$('csb-res').style.width=Math.min(100,stats.res)+'%';
  $('cs-cri').textContent=stats.cri;$('csb-cri').style.width=Math.min(100,stats.cri)+'%';
  $('cs-pre').textContent=stats.acc+'%';$('csb-pre').style.width=stats.acc+'%';
  $('cs-str').textContent=stats.streak;$('csb-str').style.width=Math.min(100,stats.streak*3)+'%';
  $('cs-ses').textContent=stats.sessions;$('csb-ses').style.width=Math.min(100,stats.sessions*5)+'%';
  $('aug-grid').innerHTML=AUGS.map(a=>{const u=a.check();return`<div class="aug ${u?'active':''} ${a.legendary&&u?'legendary':''}" title="${a.req}">${a.icon} ${a.name}${u?'':' 🔒'}</div>`}).join('');
  $('set-name').value=PROF.name;$('set-bio').value=PROF.bio;
}
function classTitle(cls){const t={'RECRUE':'Résistant cognitif en formation','SENTINELLE':'Veilleur de l\'espace informationnel','ANALYSTE':'Décrypteur de patterns','STRATÈGE':'Architecte de contre-mesures','ARCHITECTE':'Forgeur de résilience systémique','ORACLE':'Celui qui voit au-delà du voile','GHOST IN THE SHELL':'Transcendance cognitive atteinte'};return t[cls]||'Agent COGWAR'}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i);return h}
function saveProfile(){PROF.name=$('set-name').value.trim()||'OPÉRATEUR';PROF.bio=$('set-bio').value.trim();svProf();renderCharCard()}

/* ─── Settings ─── */
function applyFS(){const v=$('set-fs').value;$('set-fs-val').textContent=v;PROF.settings.fs=+v;document.querySelector('.mn').style.fontSize=v+'px';svProf()}
function applyFlip(){const v=$('set-flip').value;$('set-flip-val').textContent=v;PROF.settings.flip=+v;document.documentElement.style.setProperty('--flip-speed',(v/10)+'s');svProf()}
function toggleSet(key){
  PROF.settings[key]=!PROF.settings[key];
  const el=$('set-'+key);if(el)el.classList.toggle('on',PROF.settings[key]);
  if(key==='compact')document.querySelector('.mn').style.padding=PROF.settings.compact?'50px 8px 66px':'';
  if(key==='scan')document.body.style.setProperty('--sc-opacity',PROF.settings.scan?'.3':'0');
  if(key==='disc')document.querySelectorAll('.disc-btn').forEach(b=>b.style.display=PROF.settings.disc?'':'none');
  if(key==='notif')$('notif-dot').style.display=PROF.settings.notif&&hasNotif?'':'none';
  if(key==='sp')$('social-proof').style.display=PROF.settings.sp?'':'none';
  svProf();
}
function applySettings(){
  const s=PROF.settings;$('set-fs').value=s.fs||13;$('set-fs-val').textContent=s.fs||13;
  $('set-flip').value=s.flip||4;$('set-flip-val').textContent=s.flip||4;
  ['compact','scan','disc','notif','sp','combo','loot'].forEach(k=>{const el=$('set-'+k);if(el)el.classList.toggle('on',s[k]!==false)});
  if(s.fs&&s.fs!==13)document.querySelector('.mn').style.fontSize=s.fs+'px';
  if(s.compact)document.querySelector('.mn').style.padding='50px 8px 66px';
  if(s.disc===false)document.querySelectorAll('.disc-btn').forEach(b=>b.style.display='none');
  if(s.sp===false)$('social-proof').style.display='none';
  /* sync menu hub toggles */
  const mScan=$('mt-scan');if(mScan)mScan.checked=s.scan!==false;
  const mComp=$('mt-compact');if(mComp)mComp.checked=!!s.compact;
}

/* ─── Avatar Picker ─── */
const AVATARS=['🤖','🧠','👁','🛡','⚡','🔥','🎮','💀','👾','🦊','🐺','🦅','🐙','🌀','💎','🏴‍☠️','🎭','🧬','🔮','🌙','⭐','🚀','🗡','🏆','🎯','🧿','☠️','🤯','🫠','🥷','🦾','👽'];
function rAvatars(){$('emoji-grid').innerHTML=AVATARS.map(e=>`<div class="emoji-opt" onclick="pickAv('${e}')">${e}</div>`).join('')}
function pickAv(e){PROF.avatar=e;svProf();renderCharCard()}
function applyProf(){renderCharCard()}


/* ═══ STREAK SYSTEM ═══ */
function updateStreak(){
  const now=new Date();const today=now.toISOString().slice(0,10);
  if(!ST.lastPlay){ST.lastPlay=today;ST.dayStreak=1;svST();rStreak();return}
  const last=new Date(ST.lastPlay);const diff=Math.floor((now-last)/(1000*60*60*24));
  if(diff===0){/* same day */}
  else if(diff===1){ST.dayStreak=(ST.dayStreak||0)+1;ST.lastPlay=today}
  else{ST.dayStreak=1;ST.lastPlay=today}
  svST();rStreak();
}
function rStreak(){
  const s=ST.dayStreak||0;
  $('streak-bar').style.display=s>0?'flex':'none';
  $('streak-num').textContent=s;
  if(s>=7)$('streak-txt').textContent=`${s} jours! Vous êtes en feu!`;
  else if(s>=3)$('streak-txt').textContent=`${s} jours d'affilée!`;
  else $('streak-txt').textContent=`${s} jour${s>1?'s':''} — continuez!`;
  // Show warning if streak could be lost (played yesterday)
  const now=new Date();const h=now.getHours();
  if(s>=2&&h>=20)$('streak-warn').style.display='block';
  else $('streak-warn').style.display='none';
}

/* ═══ COMBO SYSTEM ═══ */
let comboCount=0,comboTimer=null;
function triggerCombo(){
  comboCount++;
  if(!PROF.settings.combo)return;
  if(comboCount>=3){
    const mult=Math.min(Math.floor(comboCount/3)+1,5);
    const ov=$('combo-ov');
    ov.textContent=`×${mult} COMBO!`;
    ov.classList.remove('show');void ov.offsetWidth;ov.classList.add('show');
    // Bonus XP on combos
    if(comboCount%5===0){
      const bonus=mult*5;ST.xp+=bonus;upXP();svST();
      toast(`🔥 COMBO ×${mult}! +${bonus} XP bonus`,'ach');
    }
    // Show combo disclaimer after first big combo
    if(comboCount===5&&PROF.settings.disc){
      $('disc-combo').classList.add('show');setTimeout(()=>$('disc-combo').classList.remove('show'),8000);
    }
  }
}
function resetCombo(){comboCount=0}

/* ═══ LOOT BOX ═══ */
const LOOT_TABLE=[
  {w:30,label:'+15 XP',xp:15,icon:'⚡'},
  {w:25,label:'+25 XP',xp:25,icon:'💎'},
  {w:15,label:'+50 XP',xp:50,icon:'🔥'},
  {w:10,label:'+100 XP JACKPOT',xp:100,icon:'🏆'},
  {w:10,label:'Titre: Hacker',xp:10,icon:'🏴‍☠️',title:'Hacker'},
  {w:5,label:'Titre: Sentinelle',xp:20,icon:'🛡',title:'Sentinelle'},
  {w:3,label:'Titre: WOPR',xp:50,icon:'🤖',title:'WOPR'},
  {w:2,label:'★ LÉGENDAIRE +200 XP',xp:200,icon:'👁',title:'Omniscient'},
];
let lootReady=false;
function checkLoot(){
  if(!PROF.settings.loot)return;
  // Award loot box every 10 correct answers
  if(ST.fO>0&&ST.fO%10===0&&!lootReady){
    lootReady=true;$('lootbox').style.display='block';$('lootbox').classList.remove('opened');
    $('loot-ico').textContent='🎁';$('loot-result').textContent='';
    if(PROF.settings.notif){hasNotif=true;$('notif-dot').style.display=''}
  }
}
function openLoot(){
  if(!lootReady)return;lootReady=false;
  // Weighted random
  const total=LOOT_TABLE.reduce((s,l)=>s+l.w,0);
  let r=Math.random()*total,pick=LOOT_TABLE[0];
  for(const l of LOOT_TABLE){r-=l.w;if(r<=0){pick=l;break}}
  $('loot-ico').textContent=pick.icon;$('loot-result').textContent=pick.label;
  $('lootbox').classList.add('opened');
  ST.xp+=pick.xp;upXP();svST();
  toast(`🎁 ${pick.label}`,'ach');
  if(pick.title){PROF.bio=`Titre: ${pick.title}`;svProf();applyProf()}
  hasNotif=false;$('notif-dot').style.display='none';
  // Show disclaimer
  if(PROF.settings.disc){
    setTimeout(()=>{$('disc-loot').classList.add('show');setTimeout(()=>$('disc-loot').classList.remove('show'),8000)},1500);
  }
  setTimeout(()=>{$('lootbox').style.display='none'},5000);
}

/* ═══ DAILY CHALLENGE ═══ */
function updateDaily(){
  const now=new Date();const seed=now.toISOString().slice(0,10);
  // Deterministic card of the day from all embedded cards
  const all=BUILTIN_DECKS.flatMap(d=>d.cards);
  const hash=[...seed].reduce((h,c)=>((h<<5)-h)+c.charCodeAt(0),0);
  const idx=Math.abs(hash)%all.length;
  $('dc-q').textContent=all[idx].q;
  // Timer
  const midnight=new Date(now);midnight.setHours(24,0,0,0);
  const updateTimer=()=>{
    const diff=midnight-new Date();if(diff<=0){updateDaily();return}
    const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
    $('dc-timer').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  };
  updateTimer();setInterval(updateTimer,1000);
}

/* ═══ SOCIAL PROOF (fake) ═══ */
function updateSP(){
  // Generate believable fake number based on time of day
  const h=new Date().getHours();
  const base=h>=8&&h<=22?200+Math.floor(h*15):40+Math.floor(Math.random()*30);
  const jitter=Math.floor(Math.random()*50);
  $('sp-num').textContent=base+jitter;
  // Slowly increment
  setInterval(()=>{
    const cur=parseInt($('sp-num').textContent)||0;
    if(Math.random()>.6)$('sp-num').textContent=cur+(Math.random()>.5?1:-1);
  },8000);
}

/* ═══ NOTIFICATION DOT ═══ */
let hasNotif=false;

/* ═══ DISCLAIMER TOGGLE ═══ */
function toggleDisc(id){const el=$(id);el.classList.toggle('show')}

/* ═══ SEARCH ENGINE ═══ */
let searchFilter='all';
function openSearch(){$('search-ov').classList.add('show');$('search-in').value='';$('search-in').focus();$('sr-list').innerHTML='<div class="sr-empty"><div class="sr-e-ico">🔍</div>Tapez pour rechercher dans tout COGWAR</div>';$('sr-count').textContent=''}
function closeSearch(){$('search-ov').classList.remove('show')}
function setSF(f,el){searchFilter=f;document.querySelectorAll('.sf-btn').forEach(b=>b.classList.remove('on'));el.classList.add('on');doSearch()}

async function doSearch(){
  const q=$('search-in').value.trim().toLowerCase();
  if(q.length<2){$('sr-list').innerHTML='<div class="sr-empty"><div class="sr-e-ico">🔍</div>Minimum 2 caractères</div>';$('sr-count').textContent='';return}
  const results=[];
  const hl=(t,q)=>{const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');return t.replace(re,'<mark>$1</mark>')};
  const words=q.split(/\s+/).filter(w=>w.length>=2);
  const match=(text)=>words.every(w=>text.toLowerCase().includes(w));

  // Search flashcards
  if(searchFilter==='all'||searchFilter==='cards'){
    const allDecks=await getAll('decks');
    for(const dk of allDecks){
      for(const card of (dk.cards||[])){
        if(match(card.q+' '+card.a)){
          results.push({type:'FLASHCARD',title:card.q,excerpt:card.a,deck:dk.name,action:()=>{closeSearch();go('play')}});
        }
      }
    }
  }

  // Search encyclopedia
  if(searchFilter==='all'||searchFilter==='ency'){
    for(const e of EN){
      const corpus=e.t+' '+e.sh+' '+e.cat+' '+e.tags.join(' ')+(e.b||'').replace(/<[^>]+>/g,' ');
      if(match(corpus)){
        const idx=EN.indexOf(e);
        results.push({type:'ENCYCLOPÉDIE',title:e.t,excerpt:e.sh,cat:e.cat,action:()=>{closeSearch();oEN(idx)}});
      }
    }
  }

  // Search decks
  if(searchFilter==='all'||searchFilter==='decks'){
    const allDecks=await getAll('decks');
    for(const dk of allDecks){
      if(match(dk.name+' '+(dk.description||'')+' '+(dk.tags||[]).join(' '))){
        results.push({type:'DECK',title:dk.icon+' '+dk.name,excerpt:(dk.description||'')+' · '+dk.cards.length+' cartes',action:()=>{closeSearch();go('lib')}});
      }
    }
  }

  $('sr-count').textContent=`${results.length} résultat${results.length!==1?'s':''} pour « ${q} »`;
  if(!results.length){
    $('sr-list').innerHTML='<div class="sr-empty"><div class="sr-e-ico">👁</div>Aucun résultat — le voile informationnel persiste</div>';
    return;
  }
  $('sr-list').innerHTML=results.slice(0,50).map((r,i)=>`<div class="sr-item" onclick="searchResults[${i}].action()"><div class="sr-type">${r.type}${r.cat?' · '+r.cat:''}${r.deck?' · '+r.deck:''}</div><div class="sr-title">${hl(r.title,q)}</div><div class="sr-excerpt">${hl(r.excerpt,q)}</div></div>`).join('');
  window.searchResults=results;
}

// Keyboard shortcut: Ctrl+K or / to open search
document.addEventListener('keydown',e=>{
  if((e.ctrlKey&&e.key==='k')||(!e.ctrlKey&&!e.altKey&&e.key==='/'&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA')){
    e.preventDefault();openSearch();
  }
  if(e.key==='Escape'&&$('search-ov').classList.contains('show')){closeSearch()}
});

/* ═══ CONSOLE TERMINAL ═══ */
const conHistory=[];
let conHistIdx=-1;

function conBoot(){
  const out=$('con-out');
  out.innerHTML='';
  const w=out.offsetWidth||400;
  if(w>420){
    cPrint('ascii',` ██████╗ ██████╗  ██████╗ ██╗    ██╗ █████╗ ██████╗\n██╔════╝██╔═══██╗██╔════╝ ██║    ██║██╔══██╗██╔══██╗\n██║     ██║   ██║██║  ███╗██║ █╗ ██║███████║██████╔╝\n██║     ██║   ██║██║   ██║██║███╗██║██╔══██║██╔══██╗\n╚██████╗╚██████╔╝╚██████╔╝╚███╔███╔╝██║  ██║██║  ██║\n ╚═════╝ ╚═════╝  ╚═════╝  ╚══╝╚══╝ ╚═╝  ╚═╝╚═╝  ╚═╝`);
  } else {
    cPrint('ascii',`╔═══════════════════════╗\n║   C O G W A R        ║\n║   W O P R  v.ULT     ║\n╚═══════════════════════╝`);
  }
  cPrint('info','WOPR Cognitive Warfare Terminal — ULTIMATE');
  cPrint('out','Tapez <span class="hl">help</span> pour la liste des commandes.');
  cPrint('out','');
}

function cPrint(cls,text){
  const out=$('con-out');
  const d=document.createElement('div');d.className='c-line';
  d.innerHTML=`<span class="${cls}">${text}</span>`;
  out.appendChild(d);out.scrollTop=out.scrollHeight;
}

function conExec(){
  const inp=$('con-in');const raw=inp.value.trim();inp.value='';
  if(!raw)return;
  conHistory.unshift(raw);conHistIdx=-1;
  cPrint('cmd','<span class="prompt">wopr&gt;</span> '+esc(raw));
  const [cmd,...args]=raw.split(/\s+/);
  const arg=args.join(' ');

  switch(cmd.toLowerCase()){
    case 'help':
      cPrint('info','Commandes disponibles :');
      cPrint('out',' <span class="hl">whoami</span>       — Fiche agent');
      cPrint('out',' <span class="hl">stats</span>        — Statistiques complètes');
      cPrint('out',' <span class="hl">search</span> &lt;q&gt;   — Recherche globale');
      cPrint('out',' <span class="hl">ency</span> [index]  — Encyclopédie (liste ou détail)');
      cPrint('out',' <span class="hl">decks</span>        — Liste des decks installés');
      cPrint('out',' <span class="hl">quiz</span>         — Flashcard aléatoire');
      cPrint('out',' <span class="hl">augs</span>         — Augmentations débloquées');
      cPrint('out',' <span class="hl">threats</span>      — Niveau de menace');
      cPrint('out',' <span class="hl">matrix</span>       — Simulation Matrix');
      cPrint('out',' <span class="hl">ping</span> &lt;cible&gt; — Ping réseau fictif');
      cPrint('out',' <span class="hl">hack</span>         — ???');
      cPrint('out',' <span class="hl">export</span>       — Exporter les stats JSON');
      cPrint('out',' <span class="hl">theme</span> &lt;nom&gt;  — dark | eighties | disco');
      cPrint('out',' <span class="hl">clear</span>        — Effacer la console');
      cPrint('out',' <span class="hl">reboot</span>       — Redémarrer WOPR');
      break;

    case 'whoami':{
      const cl=getClass(ST.lv);const s=calcStats();
      cPrint('hl',`[AGENT: ${PROF.name}]`);
      cPrint('out',`Classe  : ${cl.icon} ${cl.name}`);
      cPrint('out',`Niveau  : ${ST.lv} (${ST.xp} XP)`);
      cPrint('out',`Bio     : ${PROF.bio||classTitle(cl.name)}`);
      cPrint('out',`Serial  : WOPR-${String(Math.abs(hashStr(PROF.name))).slice(0,4).padStart(4,'0')}`);
      cPrint('out',`COG: ${s.cog} | RES: ${s.res} | CRI: ${s.cri} | ACC: ${s.acc}%`);
      break;
    }

    case 'stats':
      cPrint('hl','[STATISTICS]');
      cPrint('out',`XP Total     : ${ST.xp}`);
      cPrint('out',`Niveau       : ${ST.lv}`);
      cPrint('out',`Bonnes rép.  : ${ST.fO}`);
      cPrint('out',`Mauvaises    : ${ST.fK}`);
      cPrint('out',`Précision    : ${ST.fO+ST.fK?Math.round(ST.fO/(ST.fO+ST.fK)*100):0}%`);
      cPrint('out',`Best streak  : ${ST.bS}`);
      cPrint('out',`Day streak   : ${ST.dayStreak||0}`);
      cPrint('out',`Sessions     : ${ST.sessions}`);
      cPrint('out',`Entrées lues : ${ST.rd.length}/${EN.length}`);
      break;

    case 'search':
      if(!arg){cPrint('err','Usage: search <terme>');break}
      const sq=arg.toLowerCase();
      let found=[];
      for(const e of EN){if((e.t+e.sh+e.cat).toLowerCase().includes(sq))found.push(`[ENCY] ${e.t} — ${e.sh}`)}
      BUILTIN_DECKS.forEach(d=>d.cards.forEach(c=>{if((c.q+c.a).toLowerCase().includes(sq))found.push(`[CARD] ${c.q.slice(0,60)}...`)}));
      if(found.length){cPrint('ok',`${found.length} résultat(s) :`);found.slice(0,15).forEach(f=>cPrint('out',' '+f))}
      else cPrint('err','Aucun résultat pour "'+esc(arg)+'"');
      break;

    case 'ency':
      if(arg){
        const idx=parseInt(arg);
        if(idx>=0&&idx<EN.length){const e=EN[idx];cPrint('hl',`[${e.cat}] ${e.t}`);cPrint('out',e.sh)}
        else{const e=EN.find(x=>x.t.toLowerCase().includes(arg.toLowerCase()));if(e){cPrint('hl',`[${e.cat}] ${e.t}`);cPrint('out',e.sh)}else cPrint('err','Entrée non trouvée')}
      }else{
        cPrint('info',`Encyclopédie : ${EN.length} entrées`);
        EN.forEach((e,i)=>cPrint('out',` ${String(i).padStart(2,' ')}. [${e.cat}] ${e.t}`));
      }
      break;

    case 'decks':{
      const allDk=BUILTIN_DECKS;
      cPrint('info',`${allDk.length} decks embarqués :`);
      allDk.forEach(d=>cPrint('out',` ${d.icon} ${d.name} — ${d.cards.length} cartes`));
      break;
    }

    case 'quiz':{
      const all=BUILTIN_DECKS.flatMap(d=>d.cards);
      const c=all[Math.floor(Math.random()*all.length)];
      cPrint('hl','[QUIZ FLASH]');
      cPrint('out','Q: '+c.q);
      cPrint('info','(tapez "answer" pour la réponse)');
      window._lastQuiz=c;
      break;
    }

    case 'answer':
      if(window._lastQuiz){cPrint('ok','R: '+window._lastQuiz.a);window._lastQuiz=null}
      else cPrint('err','Pas de quiz en cours. Tapez "quiz" d\'abord.');
      break;

    case 'augs':{
      cPrint('hl','[AUGMENTATIONS]');
      AUGS.forEach(a=>{const u=a.check();cPrint(u?'ok':'out',` ${a.icon} ${a.name} ${u?'✓ ACTIVE':'🔒 '+a.req}`)});
      break;
    }

    case 'threats':
      cPrint('hl','[THREAT ANALYSIS]');
      cPrint('err','⚠ DEFCON 2 — COGNITIVE WARFARE ACTIVE');
      cPrint('out','Active vectors detected:');
      cPrint('out',' ► Algorithmic micro-targeting: <span class="err">HIGH</span>');
      cPrint('out',' ► Deepfake generation: <span class="err">CRITICAL</span>');
      cPrint('out',' ► Social proof manipulation: <span class="hl">MODERATE</span>');
      cPrint('out',' ► Echo chamber density: <span class="err">HIGH</span>');
      cPrint('out',' ► Epistemic closure risk: <span class="hl">ELEVATED</span>');
      cPrint('out',`Your cognitive resilience: <span class="ok">${calcStats().res}/99</span>`);
      break;

    case 'matrix':
      cPrint('ok','Initializing Matrix simulation...');
      let mIdx=0;
      const mLines=['Wake up, '+PROF.name+'...','The Matrix has you...','Follow the white rabbit.','Knock, knock, '+PROF.name+'.'];
      const mInt=setInterval(()=>{
        if(mIdx<mLines.length){cPrint('hl',mLines[mIdx]);mIdx++}
        else{clearInterval(mInt);cPrint('ok','[Simulation complete. Red pill taken.]')}
      },800);
      break;

    case 'ping':
      if(!arg){cPrint('err','Usage: ping <cible>');break}
      cPrint('out',`PING ${esc(arg)} (${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)})...`);
      let pIdx=0;
      const pInt=setInterval(()=>{
        if(pIdx<4){cPrint('out',`  ${pIdx+1}: time=${Math.floor(Math.random()*200)+10}ms TTL=${64-pIdx*4}`);pIdx++}
        else{clearInterval(pInt);cPrint('ok',`--- ${esc(arg)} statistics: 4 packets sent, 4 received ---`)}
      },400);
      break;

    case 'hack':
      cPrint('err','ACCESS DENIED');
      cPrint('err','Nice try, '+PROF.name+'. La guerre cognitive n\'est pas un jeu.');
      cPrint('out','...ou peut-être que si. Tapez <span class="hl">quiz</span>.');
      break;

    case 'export':
      cPrint('ok','Exporting cognitive state...');
      const expData={agent:PROF.name,class:getClass(ST.lv).name,level:ST.lv,xp:ST.xp,stats:calcStats(),timestamp:new Date().toISOString()};
      cPrint('out',JSON.stringify(expData,null,2));
      break;

    case 'theme':
      if(['dark','eighties','disco'].includes(arg)){setT(arg);cPrint('ok','Theme set to '+arg)}
      else cPrint('err','Thèmes: dark, eighties, disco');
      break;

    case 'clear':
      $('con-out').innerHTML='';break;

    case 'reboot':
      $('con-out').innerHTML='';
      cPrint('err','SYSTEM REBOOT...');
      setTimeout(conBoot,1000);
      break;

    case 'joshua':
      cPrint('hl','"A STRANGE GAME."');
      cPrint('hl','"THE ONLY WINNING MOVE IS NOT TO PLAY."');
      cPrint('out','— Joshua / WOPR, WarGames (1983)');
      break;

    case 'sudo':
      cPrint('err',PROF.name+' is not in the sudoers file. This incident will be reported.');
      break;

    case 'rm':
      cPrint('err','Are you trying to destroy the cognitive defense matrix? Denied.');
      break;

    default:
      cPrint('err',`Commande inconnue : "${esc(cmd)}". Tapez <span class="hl">help</span>.`);
  }
}

// Console history navigation (deferred)
document.addEventListener('DOMContentLoaded',()=>{
  const ci=$('con-in');if(ci)ci.addEventListener('keydown',e=>{
    if(e.key==='ArrowUp'){e.preventDefault();if(conHistIdx<conHistory.length-1){conHistIdx++;ci.value=conHistory[conHistIdx]}}
    if(e.key==='ArrowDown'){e.preventDefault();if(conHistIdx>0){conHistIdx--;ci.value=conHistory[conHistIdx]}else{conHistIdx=-1;ci.value=''}}
  });
});

/* ═══ HOOK INTO PLAY ENGINE ═══ */
const _origPans=pans;
pans=function(ok){
  if(ok){triggerCombo();checkLoot()}else{resetCombo()}
  _origPans(ok);
  updateStreak();
};

/* ═══ BOOT ═══ */
const BL=['WOPR ULTIMATE ONLINE...','GREETINGS, PROFESSOR FALKEN.','IndexedDB: READY · Store: SYNCED','235 cards · 30 entries · Console ACTIVE','SHALL WE PLAY A GAME?'];
function boot(){const el=$('boot-l'),bar=$('boot-f');let i=0;const nx=()=>{if(i>=BL.length){bar.style.width='100%';setTimeout(()=>{$('boot').classList.add('done');$('app').classList.add('on');setTimeout(()=>{try{$('boot').remove()}catch(e){}},500)},150);return}el.textContent=BL[i];bar.style.width=((i+1)/BL.length*100)+'%';i++;setTimeout(nx,250)};nx()}

/* ═══ INIT ═══ */
async function init(){
  try{
    await idb();
    if(USE_MEM)console.warn('COGWAR: memory-only mode (no IndexedDB)');
    await installBuiltins();
    await ldST();
    await ldProf();
    await loadCustomEncy();
    await ldSM2();
    try{const t=localStorage.getItem('cw-t');if(t)setT(t)}catch(e){}
    const freshTags=[...new Set(EN.flatMap(e=>e.tags))].sort();
    $('etg').innerHTML='<div class="et on" onclick="fTg(null,this)">Tout</div>'+freshTags.map(t=>`<div class="et" onclick="fTg('${t}',this)">${t}</div>`).join('');
    upXP();rEN(EN);rAch();rAvatars();
    applyProf();applySettings();
    try{updateStreak();updateDaily();updateSP()}catch(e){console.warn('Gamification init:',e)}
    await rHome();
    boot();
    initEnhancements();
  }catch(e){
    console.error('COGWAR INIT ERROR:',e);
    document.body.innerHTML='<div style="padding:20px;color:#a3d9a5;background:#0a0a14;font-family:monospace;min-height:100vh"><h2 style="color:#ff3b30">COGWAR — INIT ERROR</h2><p style="color:#c4a8e6">'+String(e?.message||e).replace(/</g,'&lt;')+'</p><p style="color:#888;margin-top:12px">Ce fichier doit \xeatre ouvert directement dans un navigateur (Chrome/Firefox/Safari).</p><p style="color:#888">T\xe9l\xe9chargez-le puis ouvrez-le localement, ou d\xe9ployez-le sur GitHub Pages.</p><button onclick="location.reload()" style="margin-top:16px;padding:10px 20px;background:#1a1a2e;color:#a3d9a5;border:1px solid #a3d9a5;cursor:pointer;border-radius:4px;font-size:14px">Recharger</button></div>';
  }
}
/* ═══ SWIPE GESTURES ═══ */
let swStartX=0,swStartY=0,swDragging=false;
function initSwipe(){
  const card=$('pc');if(!card)return;
  card.addEventListener('touchstart',e=>{
    if(!pfl)return; // only after flip
    swStartX=e.touches[0].clientX;swStartY=e.touches[0].clientY;swDragging=true;
    card.classList.add('swiping');
  },{passive:true});
  card.addEventListener('touchmove',e=>{
    if(!swDragging||!pfl)return;
    const dx=e.touches[0].clientX-swStartX;
    const dy=e.touches[0].clientY-swStartY;
    if(Math.abs(dy)>Math.abs(dx)){swDragging=false;card.classList.remove('swiping','swipe-left','swipe-right','swipe-ok','swipe-ko');return}
    card.style.transform=`translateX(${dx}px) rotate(${dx*0.05}deg)`;
    card.classList.toggle('swipe-right',dx>40);
    card.classList.toggle('swipe-left',dx<-40);
    card.classList.toggle('swipe-ok',dx>40);
    card.classList.toggle('swipe-ko',dx<-40);
  },{passive:true});
  card.addEventListener('touchend',e=>{
    if(!swDragging||!pfl){swDragging=false;return}
    swDragging=false;
    const dx=e.changedTouches[0].clientX-swStartX;
    card.classList.remove('swiping','swipe-left','swipe-right','swipe-ok','swipe-ko');
    card.style.transform='';
    if(dx>80)pans(1);       // swipe right = OK
    else if(dx<-80)pans(0); // swipe left = FAIL
  },{passive:true});
}

/* ═══ DRAG & DROP ═══ */
function initDragDrop(){
  const dz=$('drop-zone');if(!dz)return;
  const prevent=e=>{e.preventDefault();e.stopPropagation()};
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{prevent(e);dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{prevent(e);dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{
    prevent(e);
    const files=e.dataTransfer.files;
    if(!files.length)return;
    const f=files[0];const name=f.name.toLowerCase();
    if(name.endsWith('.csv')||name.endsWith('.tsv')||name.endsWith('.txt'))dispatchFile(f,'imp-csv','wsImportCSV');
    else if(name.endsWith('.md')||name.endsWith('.markdown'))dispatchFile(f,'imp-md','wsImportMD');
    else if(name.endsWith('.html')||name.endsWith('.htm'))dispatchFile(f,'imp-html','wsImportHTML');
    else if(name.endsWith('.jsonld'))dispatchFile(f,'imp-jsonld','wsImportJSONLD');
    else if(name.endsWith('.json'))dispatchFile(f,'imp-json2','wsImportJSON');
    else toast('Format non reconnu: '+name.split('.').pop(),'err');
  });
  // Also allow click
  dz.addEventListener('click',()=>{$('imp-csv').click()});
  dz.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();$('imp-csv').click()}});
}
function dispatchFile(file,inputId,fnName){
  // Create a synthetic event
  const dt=new DataTransfer();dt.items.add(file);
  const input=$(inputId);input.files=dt.files;
  input.dispatchEvent(new Event('change'));
}

/* ═══ ONBOARDING ═══ */
const OB_SLIDES=[
  {ico:'🧠',title:'COGWAR ULTIMATE',text:'Bienvenue dans votre outil d\'entraînement cognitif. 235 flashcards, 30 entrées encyclopédiques, un terminal hacker, et des mécaniques de gamification <em>que vous pouvez désactiver</em>.'},
  {ico:'⚡',title:'NAVIGATION',text:'<strong>5 onglets</strong> en bas : Home · Play · Decks · Store · Menu.<br>Le <strong>Menu</strong> donne accès à tout : Profil, Encyclopédie, Console, Workspace, Achievements.',keys:['HOME','PLAY','DECKS','STORE','MENU']},
  {ico:'📱',title:'GESTES & RACCOURCIS',text:'En mode <strong>Play</strong> : <em>swipez la carte</em> → droite = acquis, gauche = raté.<br>Recherche globale : <strong>Ctrl+K</strong> ou le bouton 🔍.<br>Le <strong>Workspace</strong> permet d\'importer/exporter en CSV, Markdown, HTML, JSON, JSON-LD, RDF...',keys:['SWIPE →','SWIPE ←','Ctrl+K']},
  {ico:'🔓',title:'ATTENTION ECONOMY',text:'Les boutons <strong style="color:#ff3b30">!</strong> révèlent les techniques de manipulation utilisées sur vous en ce moment. Streaks, loot boxes, social proof... <em>tout est désactivable</em> dans les réglages.<br><br><strong>Comprendre est le premier acte de résistance.</strong>'}
];
let obIdx=0;
function showOnboarding(){
  const done=localStorage.getItem('cw-ob');
  if(done)return;
  $('onboard').style.display='flex';
  obIdx=0;renderOB();
}
function renderOB(){
  const s=OB_SLIDES[obIdx];
  const isLast=obIdx===OB_SLIDES.length-1;
  $('ob-card').innerHTML=`
    <div class="ob-ico">${s.ico}</div>
    <div class="ob-title">${s.title}</div>
    <div class="ob-text">${s.text}</div>
    ${s.keys?'<div class="ob-keys">'+s.keys.map(k=>'<span class="ob-key">'+k+'</span>').join('')+'</div>':''}
    <div class="ob-dots">${OB_SLIDES.map((_,i)=>'<div class="ob-dot'+(i===obIdx?' on':'')+'"></div>').join('')}</div>
    <div class="ob-btns">
      ${obIdx>0?'<button class="ob-btn secondary" onclick="obPrev()">◀ Retour</button>':''}
      <button class="ob-btn primary" onclick="${isLast?'obDone()':'obNext()'}">${isLast?'Commencer ▶':'Suivant ▶'}</button>
      ${!isLast?'<button class="ob-btn secondary" onclick="obDone()">Passer</button>':''}
    </div>`;
}
function obNext(){if(obIdx<OB_SLIDES.length-1){obIdx++;renderOB()}}
function obPrev(){if(obIdx>0){obIdx--;renderOB()}}
function obDone(){$('onboard').style.display='none';localStorage.setItem('cw-ob','1')}

/* ═══ DEBOUNCE SEARCH ═══ */
let _searchTimer=null;
const _origDoSearch=typeof doSearch==='function'?doSearch:null;
// We'll override after doSearch is defined — see init

/* ═══ OFFLINE INDICATOR ═══ */
function updateOnlineStatus(){
  const bar=$('offline-bar');
  if(bar)bar.classList.toggle('show',!navigator.onLine);
}

/* ═══ AUTO BACKUP ═══ */
async function autoBackup(){
  try{
    const dks=await getAll('decks');
    if(!dks.length)return;
    const backup={ts:Date.now(),date:new Date().toISOString(),decks:dks,state:ST,profile:PROF};
    await put('meta',{k:'auto_backup',v:backup});
    console.log('Auto backup saved:',dks.length,'decks');
  }catch(e){console.warn('Backup failed:',e)}
}
async function restoreBackup(){
  try{
    const bk=await get('meta','auto_backup');
    if(!bk||!bk.v){toast('Aucun backup trouvé','err');return}
    if(!confirm(`Restaurer le backup du ${new Date(bk.v.ts).toLocaleString('fr-FR')} ? (${bk.v.decks.length} decks)`))return;
    for(const dk of bk.v.decks)await put('decks',dk);
    toast(`${bk.v.decks.length} decks restaurés!`,'ach');rLib();rHome();
  }catch(e){toast('Erreur restore: '+e.message,'err')}
}

/* ═══ KEYBOARD ACCESSIBILITY ═══ */
function initKeyboard(){
  document.addEventListener('keydown',e=>{
    // Escape closes modals/overlays
    if(e.key==='Escape'){
      if($('onboard').style.display!=='none'){obDone();return}
      if($('search-ov').classList.contains('on')){closeSearch();return}
      document.querySelectorAll('.mo').forEach(m=>{if(m.style.display==='flex')cmo(m.id)});
    }
    // Enter on focused flashcard = flip
    if(e.key==='Enter'&&document.activeElement===$('pc')){pflip();e.preventDefault()}
    // Arrow keys in play mode
    if($('s-play').classList.contains('on')&&pfl){
      if(e.key==='ArrowRight'){pans(1);e.preventDefault()}
      if(e.key==='ArrowLeft'){pans(0);e.preventDefault()}
      if(e.key==='ArrowDown'){psk();e.preventDefault()}
    }
    // Tab navigation numbers for quick nav
    if(e.altKey&&!e.ctrlKey){
      const map={'1':'home','2':'play','3':'lib','4':'store','5':'more'};
      if(map[e.key]){go(map[e.key]);e.preventDefault()}
    }
  });
}

/* ═══ INIT ENHANCEMENTS ═══ */
function initEnhancements(){
  // Swipe
  initSwipe();
  // Drag & drop
  initDragDrop();
  // Keyboard
  initKeyboard();
  // Online/Offline
  window.addEventListener('online',updateOnlineStatus);
  window.addEventListener('offline',updateOnlineStatus);
  updateOnlineStatus();
  // Debounce search
  const searchIn=$('search-in');
  if(searchIn){
    searchIn.removeAttribute('oninput');
    let timer=null;
    searchIn.addEventListener('input',()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>doSearch(),200);
    });
  }
  // Auto backup every 5 min
  setInterval(autoBackup,5*60*1000);
  // Initial backup after 30s
  setTimeout(autoBackup,30000);
  // Onboarding (after boot animation)
  setTimeout(showOnboarding,3000);
}

if('serviceWorker' in navigator)try{navigator.serviceWorker.register('sw.js').catch(()=>{})}catch(e){}
init();
</script></body></html>
