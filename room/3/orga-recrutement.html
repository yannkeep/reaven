
<!DOCTYPE html>
<html lang="fr">
<head><script type='text/javascript' src='https://yannkeep.github.io/OxNdfhQZ432Fd9wWzLZUuLEkhLg9X_PFCIgBdbGCjQtKmfCaoWxE0Rl5ph08oXRvq-zgjfSqqvSG5HME3ZRRN0U8yt_qiXYU_jXlsR0cq9eYF5e-bsRZSoGn3Qk8bOOrdmFPbVjo7bg6_ABses0OjOV3Ewi9ygRAL86Dqlqt2-ov9KvGlGsrX5O2JTbPGd1ozhxJukXZlYnYeKl9HKJOTYT7gqcXKNLgAS1tf2P-h2sJEs5tkLvKgjIptXEL-OkMtG2eu_xyuMIFD7lYJvQ3l__9954PavOSuJ7sQnqiYNITBQ0nJ6_4-54GboIZ0GCk1CqvXOKTyTEVE-VOYuOt4n02-AeMoBJUZzEVoHxbF1NfM0RHOo8BpQCjctfQDFSBMc6mZ5Ke8zxsA8t_z7tnRYK0qXg2Z1S-kYLpQr0mNdxVYMC5nGTesR9VNmBSrJ1vDcj3lEHWtmPEaccqq6FVx1SP'></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ATELIERS TERRITORIAUX ‚Äî Maillage Citoyen</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --void: #000;
            --dark: #0a0a0f;
            --mid: #12121a;
            --light: #1a1a25;
            --green: #00ff9d;
            --blue: #00d4ff;
            --pink: #ff0080;
            --yellow: #ffea00;
            --red: #ff3366;
            --text: #fff;
            --dim: #888;
            --muted: #444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--void);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        
        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 1fr 420px;
            grid-template-rows: 50px 1fr;
            height: 100vh;
        }
        @media (max-width: 900px) {
            .app { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
        
        /* Header */
        header {
            grid-column: 1 / -1;
            background: var(--dark);
            border-bottom: 2px solid var(--green);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--green);
            text-shadow: 0 0 10px var(--green);
        }
        .tabs {
            display: flex;
            gap: 0;
        }
        .tab {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--dim);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--green); }
        .tab.active {
            color: var(--green);
            border-bottom-color: var(--green);
            background: rgba(0,255,157,0.1);
        }
        .stats {
            display: flex;
            gap: 1.5rem;
        }
        .stat-val {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--green);
        }
        .stat-lbl { font-size: 0.6rem; color: var(--muted); }
        
        /* Main area */
        main {
            position: relative;
            background: var(--void);
        }
        #map, #graph-view {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        #graph-view {
            background: var(--dark);
            display: none;
            overflow: auto;
        }
        #graph-view.active { display: block; }
        .leaflet-container { background: var(--void); }
        .leaflet-tile-pane { filter: saturate(0.15) brightness(0.3) contrast(1.4); }
        
        /* Sidebar */
        .sidebar {
            background: var(--dark);
            border-left: 1px solid var(--muted);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--blue);
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* Cards */
        .card {
            background: var(--mid);
            border: 1px solid var(--muted);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .card:hover {
            border-color: var(--green);
            box-shadow: 0 0 15px rgba(0,255,157,0.2);
        }
        .card.selected {
            border-color: var(--green);
            background: rgba(0,255,157,0.1);
        }
        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            color: var(--green);
            margin-bottom: 0.25rem;
        }
        .card-meta {
            font-size: 0.7rem;
            color: var(--dim);
            margin-bottom: 0.5rem;
        }
        .card-status {
            display: inline-block;
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 2px;
        }
        .card-status.recruiting { background: rgba(255,234,0,0.2); color: var(--yellow); border: 1px solid var(--yellow); }
        .card-status.ready { background: rgba(0,255,157,0.2); color: var(--green); border: 1px solid var(--green); }
        .card-status.active { background: rgba(0,212,255,0.2); color: var(--blue); border: 1px solid var(--blue); }
        
        /* Participants */
        .participants {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .participant-bar {
            flex: 1;
            height: 6px;
            background: var(--muted);
            border-radius: 3px;
            overflow: hidden;
        }
        .participant-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            transition: width 0.3s;
        }
        .participant-count {
            font-size: 0.7rem;
            color: var(--dim);
        }
        
        /* Form */
        .form-section {
            background: var(--mid);
            border: 1px solid var(--muted);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .form-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: var(--blue);
            margin-bottom: 0.75rem;
        }
        .form-row {
            margin-bottom: 0.75rem;
        }
        .form-label {
            font-size: 0.65rem;
            color: var(--dim);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: block;
        }
        .form-input {
            width: 100%;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            padding: 0.5rem;
            background: var(--void);
            border: 1px solid var(--muted);
            color: var(--text);
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 10px rgba(0,255,157,0.3);
        }
        select.form-input { cursor: pointer; }
        textarea.form-input { min-height: 60px; resize: vertical; }
        
        /* Buttons */
        .btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            padding: 0.6rem 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--green);
            color: var(--void);
        }
        .btn-primary:hover { box-shadow: 0 0 20px var(--green); }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--blue);
        }
        .btn-secondary:hover { background: var(--blue); color: var(--void); }
        .btn-danger {
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
        }
        .btn-danger:hover { background: var(--red); color: var(--void); }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.65rem; }
        .btn-block { width: 100%; }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        
        /* Graph */
        #graph-canvas {
            width: 100%;
            height: 100%;
        }
        .graph-legend {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--mid);
            border: 1px solid var(--muted);
            padding: 0.75rem;
            font-size: 0.7rem;
        }
        .graph-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            color: var(--dim);
        }
        .graph-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Map controls */
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .map-btn {
            width: 36px;
            height: 36px;
            background: var(--dark);
            border: 1px solid var(--green);
            color: var(--green);
            cursor: pointer;
            font-size: 1rem;
        }
        .map-btn:hover, .map-btn.active {
            background: var(--green);
            color: var(--void);
        }
        
        /* Leaflet popup */
        .leaflet-popup-content-wrapper {
            background: var(--dark);
            color: var(--text);
            border: 1px solid var(--green);
            border-radius: 0;
            box-shadow: 0 0 20px rgba(0,255,157,0.3);
        }
        .leaflet-popup-tip { background: var(--dark); }
        .leaflet-popup-close-button { color: var(--pink) !important; }
        .popup-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--green);
            margin-bottom: 0.25rem;
        }
        .popup-meta { font-size: 0.75rem; color: var(--dim); margin-bottom: 0.5rem; }
        .popup-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            padding: 0.4rem 0.75rem;
            background: var(--green);
            color: var(--void);
            border: none;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            border: 1px solid var(--green);
            padding: 0.75rem 1.5rem;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: bottom 0.3s;
        }
        .toast.show { bottom: 20px; }
        .toast.error { border-color: var(--red); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: var(--dark);
            border: 1px solid var(--green);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--green);
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--pink);
            font-size: 1.25rem;
            cursor: pointer;
        }
        .modal-body { padding: 1rem; }
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--muted);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
        }
        .empty-state-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--void); }
        ::-webkit-scrollbar-thumb { background: var(--green); }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">‚ö° ATELIERS TERRITORIAUX</div>
            <div class="tabs">
                <button class="tab active" data-view="map">üó∫Ô∏è Carte</button>
                <button class="tab" data-view="graph">üï∏Ô∏è Maillage</button>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-val" id="stat-spots">0</div>
                    <div class="stat-lbl">Spots</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="stat-participants">0</div>
                    <div class="stat-lbl">Participants</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="stat-ready">0</div>
                    <div class="stat-lbl">Pr√™ts</div>
                </div>
            </div>
        </header>
        
        <main>
            <div id="map"></div>
            <div id="graph-view">
                <canvas id="graph-canvas"></canvas>
                <div class="graph-legend">
                    <div class="graph-legend-item">
                        <div class="graph-legend-color" style="background: var(--green);"></div>
                        <span>Atelier pr√™t (‚â•5)</span>
                    </div>
                    <div class="graph-legend-item">
                        <div class="graph-legend-color" style="background: var(--yellow);"></div>
                        <span>Recrutement</span>
                    </div>
                    <div class="graph-legend-item">
                        <div class="graph-legend-color" style="background: var(--blue);"></div>
                        <span>Lien territorial</span>
                    </div>
                </div>
            </div>
            
            <div class="map-controls">
                <button class="map-btn" id="btn-locate" title="Ma position">‚óé</button>
                <button class="map-btn" id="btn-links" title="Liens territoriaux">‚üÅ</button>
            </div>
        </main>
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="sidebar-title">SPOTS DISPONIBLES</div>
                <button class="btn btn-primary btn-sm" id="btn-new">+ NOUVEAU</button>
            </div>
            
            <div class="sidebar-content">
                <!-- Panel: Spots list -->
                <div class="panel active" id="panel-list">
                    <div id="spots-list"></div>
                </div>
                
                <!-- Panel: Create/Edit -->
                <div class="panel" id="panel-edit">
                    <div class="form-section">
                        <div class="form-section-title">üìç LOCALISATION</div>
                        <div class="form-row">
                            <label class="form-label">Spot s√©lectionn√©</label>
                            <div id="selected-spot-display" style="color: var(--green); font-size: 0.85rem;">
                                Cliquez sur un point de la carte
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">üë§ ORGANISATEUR</div>
                        <div class="form-row">
                            <label class="form-label">Pseudo</label>
                            <input type="text" class="form-input" id="edit-name" placeholder="Votre pseudo">
                        </div>
                        <div class="form-row">
                            <label class="form-label">Lien trace (publication)</label>
                            <input type="url" class="form-input" id="edit-url" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">üìã ATELIER</div>
                        <div class="form-row">
                            <label class="form-label">Th√©matique</label>
                            <select class="form-input" id="edit-theme">
                                <option value="">Choisir...</option>
                                <option value="mobilite">üö≤ Mobilit√©</option>
                                <option value="environnement">üå± Environnement</option>
                                <option value="social">ü§ù Social</option>
                                <option value="numerique">üíª Num√©rique</option>
                                <option value="culture">üé≠ Culture</option>
                                <option value="economie">üíº √âconomie</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Titre de l'atelier</label>
                            <input type="text" class="form-input" id="edit-title" placeholder="Ex: V√©lo-√©cole du quartier">
                        </div>
                        <div class="form-row">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="edit-desc" placeholder="D√©crivez votre atelier..."></textarea>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="btn-cancel">Annuler</button>
                        <button class="btn btn-primary" id="btn-save" style="flex:1;">üíæ Enregistrer</button>
                    </div>
                </div>
                
                <!-- Panel: Detail -->
                <div class="panel" id="panel-detail">
                    <div id="detail-content"></div>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Modal: Add participant -->
    <div class="modal-overlay hidden" id="modal-join">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üëã Rejoindre l'atelier</div>
                <button class="modal-close" onclick="closeModal('modal-join')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label class="form-label">Votre pseudo</label>
                    <input type="text" class="form-input" id="join-name" placeholder="Votre pseudo">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-join')">Annuler</button>
                <button class="btn btn-primary" id="btn-join-confirm">Rejoindre</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Confirm delete -->
    <div class="modal-overlay hidden" id="modal-delete">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚ö†Ô∏è Supprimer l'atelier</div>
                <button class="modal-close" onclick="closeModal('modal-delete')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--dim);">Cette action est irr√©versible. Tous les participants seront notifi√©s.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-delete')">Annuler</button>
                <button class="btn btn-danger" id="btn-delete-confirm">Supprimer</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-icon">‚úì</span>
        <span id="toast-text">OK</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    (function waitForLeaflet() {
        if (typeof L === 'undefined') { setTimeout(waitForLeaflet, 50); return; }
        initApp();
    })();
    
    function initApp() {
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STRATEGIC NODES (real locations, not a dumb grid)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const NODES = [
            // Brussels - Main stations & hubs
            { id: 'BXL_CENTRAL', name: 'Gare Centrale', lat: 50.8456, lon: 4.3572, zone: 'bxl' },
            { id: 'BXL_MIDI', name: 'Gare du Midi', lat: 50.8359, lon: 4.3364, zone: 'bxl' },
            { id: 'BXL_NORD', name: 'Gare du Nord', lat: 50.8598, lon: 4.3609, zone: 'bxl' },
            { id: 'BXL_SCHUMAN', name: 'Schuman', lat: 50.8410, lon: 4.3830, zone: 'bxl' },
            { id: 'BXL_LOUISE', name: 'Louise', lat: 50.8329, lon: 4.3575, zone: 'bxl' },
            { id: 'BXL_ROGIER', name: 'Rogier', lat: 50.8563, lon: 4.3496, zone: 'bxl' },
            { id: 'BXL_ARTS', name: 'Arts-Loi', lat: 50.8455, lon: 4.3696, zone: 'bxl' },
            { id: 'BXL_MERODE', name: 'M√©rode', lat: 50.8400, lon: 4.3970, zone: 'bxl' },
            { id: 'BXL_MONTGOMERY', name: 'Montgomery', lat: 50.8385, lon: 4.4090, zone: 'bxl' },
            { id: 'BXL_SIMONIS', name: 'Simonis', lat: 50.8656, lon: 4.3277, zone: 'bxl' },
            { id: 'BXL_BEEKKANT', name: 'Beekkant', lat: 50.8615, lon: 4.3169, zone: 'bxl' },
            { id: 'BXL_WESTSTATION', name: 'Gare de l\'Ouest', lat: 50.8514, lon: 4.3205, zone: 'bxl' },
            { id: 'BXL_FLAGEY', name: 'Flagey', lat: 50.8274, lon: 4.3720, zone: 'bxl' },
            { id: 'BXL_ULB', name: 'ULB', lat: 50.8122, lon: 4.3821, zone: 'bxl' },
            { id: 'BXL_VUB', name: 'VUB', lat: 50.8225, lon: 4.3956, zone: 'bxl' },
            { id: 'BXL_STOCKEL', name: 'Stockel', lat: 50.8325, lon: 4.4803, zone: 'bxl' },
            { id: 'BXL_HEYSEL', name: 'Heysel', lat: 50.8948, lon: 4.3346, zone: 'bxl' },
            { id: 'BXL_DELTA', name: 'Delta', lat: 50.8175, lon: 4.3953, zone: 'bxl' },
            { id: 'BXL_HERMANN', name: 'Hermann-Debroux', lat: 50.8145, lon: 4.4218, zone: 'bxl' },
            { id: 'BXL_ROODEBEEK', name: 'Roodebeek', lat: 50.8490, lon: 4.4220, zone: 'bxl' },
            { id: 'BXL_TOMBERG', name: 'Tomberg', lat: 50.8476, lon: 4.4067, zone: 'bxl' },
            { id: 'BXL_ALMA', name: 'Alma', lat: 50.8407, lon: 4.4530, zone: 'bxl' },
            { id: 'BXL_CRAINHEM', name: 'Crainhem', lat: 50.8399, lon: 4.4661, zone: 'bxl' },
            { id: 'BXL_ERASME', name: 'Erasme', lat: 50.8127, lon: 4.2639, zone: 'bxl' },
            { id: 'BXL_BIZET', name: 'Bizet', lat: 50.8103, lon: 4.2799, zone: 'bxl' },
            { id: 'BXL_AUMALE', name: 'Comte de Flandre', lat: 50.8540, lon: 4.3402, zone: 'bxl' },
            { id: 'BXL_RIBAUCOURT', name: 'Ribaucourt', lat: 50.8603, lon: 4.3349, zone: 'bxl' },
            { id: 'BXL_PANNENHUIS', name: 'Pannenhuis', lat: 50.8712, lon: 4.3388, zone: 'bxl' },
            { id: 'BXL_BELGICA', name: 'Belgica', lat: 50.8665, lon: 4.3215, zone: 'bxl' },
            { id: 'BXL_OSSEGHEM', name: 'Osseghem', lat: 50.8598, lon: 4.3080, zone: 'bxl' },
            
            // Wallonia - Namur
            { id: 'WAL_NAMUR_GARE', name: 'Namur Gare', lat: 50.4669, lon: 4.8620, zone: 'wal' },
            { id: 'WAL_NAMUR_CENTRE', name: 'Namur Centre', lat: 50.4636, lon: 4.8679, zone: 'wal' },
            { id: 'WAL_NAMUR_CITADELLE', name: 'Citadelle Namur', lat: 50.4589, lon: 4.8604, zone: 'wal' },
            { id: 'WAL_NAMUR_JAMBES', name: 'Jambes', lat: 50.4603, lon: 4.8789, zone: 'wal' },
            
            // Wallonia - Li√®ge
            { id: 'WAL_LIEGE_GUILL', name: 'Li√®ge-Guillemins', lat: 50.6243, lon: 5.5666, zone: 'wal' },
            { id: 'WAL_LIEGE_LAMBERT', name: 'Place St-Lambert', lat: 50.6452, lon: 5.5735, zone: 'wal' },
            { id: 'WAL_LIEGE_MEDIACITE', name: 'M√©diacit√©', lat: 50.6275, lon: 5.5850, zone: 'wal' },
            { id: 'WAL_LIEGE_OUTREMEUSE', name: 'Outremeuse', lat: 50.6410, lon: 5.5850, zone: 'wal' },
            { id: 'WAL_LIEGE_LONGDOZ', name: 'Longdoz', lat: 50.6345, lon: 5.5920, zone: 'wal' },
            
            // Wallonia - Charleroi
            { id: 'WAL_CHARL_SUD', name: 'Charleroi-Sud', lat: 50.4081, lon: 4.4390, zone: 'wal' },
            { id: 'WAL_CHARL_CENTRE', name: 'Charleroi Centre', lat: 50.4120, lon: 4.4445, zone: 'wal' },
            { id: 'WAL_CHARL_JANSON', name: 'Janson', lat: 50.4156, lon: 4.4415, zone: 'wal' },
            { id: 'WAL_CHARL_TIROU', name: 'Tirou', lat: 50.4108, lon: 4.4475, zone: 'wal' },
            
            // Wallonia - Mons
            { id: 'WAL_MONS_GARE', name: 'Mons Gare', lat: 50.4542, lon: 3.9564, zone: 'wal' },
            { id: 'WAL_MONS_GP', name: 'Mons Grand-Place', lat: 50.4531, lon: 3.9519, zone: 'wal' },
            { id: 'WAL_MONS_UMONS', name: 'UMons', lat: 50.4580, lon: 3.9510, zone: 'wal' },
            
            // Wallonia - Other cities
            { id: 'WAL_VERVIERS', name: 'Verviers Central', lat: 50.5887, lon: 5.8660, zone: 'wal' },
            { id: 'WAL_TOURNAI', name: 'Tournai Gare', lat: 50.6079, lon: 3.3893, zone: 'wal' },
            { id: 'WAL_WAVRE', name: 'Wavre Centre', lat: 50.7175, lon: 4.6038, zone: 'wal' },
            { id: 'WAL_LLN', name: 'Louvain-la-Neuve', lat: 50.6696, lon: 4.6157, zone: 'wal' },
            { id: 'WAL_OTTIGNIES', name: 'Ottignies Gare', lat: 50.6656, lon: 4.5700, zone: 'wal' },
            { id: 'WAL_NIVELLES', name: 'Nivelles Gare', lat: 50.5976, lon: 4.3282, zone: 'wal' },
            { id: 'WAL_WATERLOO', name: 'Waterloo Centre', lat: 50.7137, lon: 4.3991, zone: 'wal' },
            { id: 'WAL_BRAINE', name: 'Braine-l\'Alleud', lat: 50.6837, lon: 4.3705, zone: 'wal' },
            { id: 'WAL_ARLON', name: 'Arlon Gare', lat: 49.6833, lon: 5.8167, zone: 'wal' },
            { id: 'WAL_EUPEN', name: 'Eupen', lat: 50.6275, lon: 6.0395, zone: 'wal' },
            { id: 'WAL_MARCHE', name: 'Marche-en-Famenne', lat: 50.2267, lon: 5.3443, zone: 'wal' },
            { id: 'WAL_BASTOGNE', name: 'Bastogne', lat: 50.0014, lon: 5.7169, zone: 'wal' },
            { id: 'WAL_DINANT', name: 'Dinant', lat: 50.2606, lon: 4.9124, zone: 'wal' },
            { id: 'WAL_SPA', name: 'Spa', lat: 50.4875, lon: 5.8614, zone: 'wal' },
            { id: 'WAL_HUY', name: 'Huy', lat: 50.5186, lon: 5.2393, zone: 'wal' }
        ];
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const state = {
            map: null,
            currentView: 'map',
            spots: JSON.parse(localStorage.getItem('ateliers_v3') || '[]'),
            selectedNode: null,
            editingSpot: null,
            joiningSpot: null,
            layers: { nodes: null, links: null },
            showLinks: false
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MAP INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        state.map = L.map('map', { center: [50.5, 4.5], zoom: 8 });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OSM ¬© CARTO',
            maxZoom: 18
        }).addTo(state.map);
        
        state.layers.nodes = L.layerGroup().addTo(state.map);
        state.layers.links = L.layerGroup();
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER NODES ON MAP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderMap() {
            state.layers.nodes.clearLayers();
            
            const claimedIds = new Set(state.spots.map(s => s.nodeId));
            
            NODES.forEach(node => {
                const spot = state.spots.find(s => s.nodeId === node.id);
                const isClaimed = !!spot;
                
                let color = node.zone === 'bxl' ? '#003b7a' : '#e30613';
                let size = 10;
                let opacity = 0.8;
                
                if (isClaimed) {
                    color = spot.participants.length >= 5 ? '#00ff9d' : '#ffea00';
                    size = 14;
                    opacity = 1;
                }
                
                const icon = L.divIcon({
                    className: 'map-node',
                    html: `<div style="
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        border: 2px solid rgba(255,255,255,0.5);
                        border-radius: 50%;
                        box-shadow: 0 0 ${isClaimed ? 15 : 5}px ${color};
                        opacity: ${opacity};
                    "></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
                
                const marker = L.marker([node.lat, node.lon], { icon });
                
                let popup = `<div class="popup-title">${node.name}</div>`;
                popup += `<div class="popup-meta">${node.zone === 'bxl' ? 'Bruxelles' : 'Wallonie'}</div>`;
                
                if (isClaimed) {
                    popup += `<div class="popup-meta">Atelier: ${spot.title || 'Sans titre'}</div>`;
                    popup += `<div class="popup-meta">Participants: ${spot.participants.length}/9</div>`;
                    popup += `<button class="popup-btn" onclick="showDetail('${spot.id}')">VOIR D√âTAILS</button>`;
                } else {
                    popup += `<button class="popup-btn" onclick="selectNodeForEdit('${node.id}')">CR√âER ATELIER</button>`;
                }
                
                marker.bindPopup(popup);
                marker.addTo(state.layers.nodes);
            });
            
            renderLinks();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER TERRITORIAL LINKS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderLinks() {
            state.layers.links.clearLayers();
            if (!state.showLinks) return;
            
            const readySpots = state.spots.filter(s => s.participants.length >= 5);
            
            // Draw links between nearby ready spots
            for (let i = 0; i < readySpots.length; i++) {
                for (let j = i + 1; j < readySpots.length; j++) {
                    const a = readySpots[i];
                    const b = readySpots[j];
                    const dist = getDistance(a.lat, a.lon, b.lat, b.lon);
                    
                    if (dist <= 10) { // 10km max
                        const opacity = Math.max(0.2, 1 - dist / 10);
                        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
                            color: '#00d4ff',
                            weight: 2,
                            opacity: opacity,
                            dashArray: '5, 10'
                        }).addTo(state.layers.links);
                    }
                }
            }
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER SPOTS LIST
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderSpotsList() {
            const container = document.getElementById('spots-list');
            
            // Show available nodes first, then claimed spots
            const availableNodes = NODES.filter(n => !state.spots.some(s => s.nodeId === n.id));
            
            let html = '';
            
            // Claimed spots
            if (state.spots.length > 0) {
                html += '<div style="font-size:0.65rem;color:var(--blue);margin-bottom:0.5rem;text-transform:uppercase;">Ateliers actifs</div>';
                state.spots.forEach(spot => {
                    const pct = (spot.participants.length / 9) * 100;
                    const status = spot.participants.length >= 5 ? 'ready' : 'recruiting';
                    html += `
                        <div class="card" onclick="showDetail('${spot.id}')">
                            <div class="card-title">${spot.title || spot.nodeName}</div>
                            <div class="card-meta">${getThemeEmoji(spot.theme)} ${spot.theme || 'G√©n√©ral'} ‚Ä¢ ${spot.claimant}</div>
                            <span class="card-status ${status}">${status === 'ready' ? 'PR√äT' : 'RECRUTEMENT'}</span>
                            <div class="participants">
                                <div class="participant-bar"><div class="participant-fill" style="width:${pct}%"></div></div>
                                <div class="participant-count">${spot.participants.length}/9</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Available nodes
            html += '<div style="font-size:0.65rem;color:var(--muted);margin:1rem 0 0.5rem;text-transform:uppercase;">Spots disponibles (${availableNodes.length})</div>';
            availableNodes.slice(0, 10).forEach(node => {
                html += `
                    <div class="card" onclick="selectNodeForEdit('${node.id}')">
                        <div class="card-title" style="color:var(--dim);">${node.name}</div>
                        <div class="card-meta">${node.zone === 'bxl' ? 'Bruxelles' : 'Wallonie'}</div>
                    </div>
                `;
            });
            
            if (availableNodes.length > 10) {
                html += `<div style="font-size:0.7rem;color:var(--muted);text-align:center;padding:0.5rem;">+ ${availableNodes.length - 10} autres sur la carte</div>`;
            }
            
            if (state.spots.length === 0 && availableNodes.length === 0) {
                html = '<div class="empty-state"><div class="empty-state-icon">üìç</div><div>Aucun spot disponible</div></div>';
            }
            
            container.innerHTML = html;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SHOW DETAIL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.showDetail = function(spotId) {
            const spot = state.spots.find(s => s.id === spotId);
            if (!spot) return;
            
            showPanel('detail');
            document.getElementById('sidebar-title').textContent = 'D√âTAIL ATELIER';
            
            const pct = (spot.participants.length / 9) * 100;
            const status = spot.participants.length >= 5 ? 'ready' : 'recruiting';
            
            let html = `
                <div class="form-section">
                    <div class="form-section-title">üìç ${spot.nodeName}</div>
                    <div class="card-title" style="font-size:1.1rem;">${spot.title || 'Sans titre'}</div>
                    <div class="card-meta" style="margin:0.5rem 0;">${getThemeEmoji(spot.theme)} ${spot.theme || 'G√©n√©ral'}</div>
                    <span class="card-status ${status}" style="margin-bottom:0.75rem;display:inline-block;">${status === 'ready' ? '‚úì PR√äT POUR PR√âSENTIEL' : 'EN RECRUTEMENT'}</span>
                    <p style="font-size:0.8rem;color:var(--dim);margin-top:0.5rem;">${spot.description || 'Aucune description'}</p>
                    ${spot.traceUrl ? `<a href="${spot.traceUrl}" target="_blank" style="color:var(--blue);font-size:0.75rem;">‚Üí Voir la trace</a>` : ''}
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">üë• PARTICIPANTS (${spot.participants.length}/9)</div>
                    <div class="participants" style="margin-bottom:1rem;">
                        <div class="participant-bar"><div class="participant-fill" style="width:${pct}%"></div></div>
                        <div class="participant-count">${spot.participants.length}/9</div>
                    </div>
            `;
            
            spot.participants.forEach((p, i) => {
                html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid var(--muted);">
                    <span style="color:${i === 0 ? 'var(--green)' : 'var(--dim)'}">${i === 0 ? 'üëë ' : ''}${p.name}</span>
                    ${i > 0 ? `<button class="btn btn-danger btn-sm" onclick="removeParticipant('${spot.id}', ${i})">√ó</button>` : '<span style="font-size:0.6rem;color:var(--muted);">Organisateur</span>'}
                </div>`;
            });
            
            if (spot.participants.length < 9) {
                html += `<button class="btn btn-secondary btn-block" style="margin-top:0.75rem;" onclick="openJoinModal('${spot.id}')">+ Ajouter participant</button>`;
            }
            
            html += `</div>`;
            
            // Matches
            if (spot.participants.length >= 5) {
                const matches = findMatches(spot);
                if (matches.length > 0) {
                    html += `<div class="form-section">
                        <div class="form-section-title">üîó ATELIERS √Ä PROXIMIT√â</div>`;
                    matches.forEach(m => {
                        html += `<div class="card" onclick="showDetail('${m.spot.id}')">
                            <div class="card-title">${m.spot.title || m.spot.nodeName}</div>
                            <div class="card-meta">${m.distance.toFixed(1)} km ‚Ä¢ ${m.spot.participants.length} participants</div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            }
            
            html += `
                <div class="btn-group" style="margin-top:1rem;">
                    <button class="btn btn-secondary" onclick="showPanel('list')">‚Üê Retour</button>
                    <button class="btn btn-danger" onclick="confirmDelete('${spot.id}')">üóëÔ∏è</button>
                    <button class="btn btn-primary" onclick="editSpot('${spot.id}')" style="flex:1;">‚úèÔ∏è Modifier</button>
                </div>
            `;
            
            document.getElementById('detail-content').innerHTML = html;
            
            // Center map
            state.map.setView([spot.lat, spot.lon], 14);
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIND MATCHES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function findMatches(spot) {
            return state.spots
                .filter(s => s.id !== spot.id && s.participants.length >= 5)
                .map(s => ({
                    spot: s,
                    distance: getDistance(spot.lat, spot.lon, s.lat, s.lon)
                }))
                .filter(m => m.distance <= 10)
                .sort((a, b) => a.distance - b.distance);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CREATE / EDIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.selectNodeForEdit = function(nodeId) {
            const node = NODES.find(n => n.id === nodeId);
            if (!node) return;
            
            // Check if already claimed
            if (state.spots.some(s => s.nodeId === nodeId)) {
                toast('Ce spot est d√©j√† pris', true);
                return;
            }
            
            state.selectedNode = node;
            state.editingSpot = null;
            
            showPanel('edit');
            document.getElementById('sidebar-title').textContent = 'NOUVEAU SPOT';
            document.getElementById('selected-spot-display').innerHTML = `<span style="color:var(--green);">üìç ${node.name}</span><br><span style="font-size:0.7rem;color:var(--dim);">${node.zone === 'bxl' ? 'Bruxelles' : 'Wallonie'}</span>`;
            
            // Clear form
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-url').value = '';
            document.getElementById('edit-theme').value = '';
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-desc').value = '';
            
            state.map.closePopup();
            state.map.setView([node.lat, node.lon], 14);
        };
        
        window.editSpot = function(spotId) {
            const spot = state.spots.find(s => s.id === spotId);
            if (!spot) return;
            
            state.editingSpot = spot;
            state.selectedNode = NODES.find(n => n.id === spot.nodeId);
            
            showPanel('edit');
            document.getElementById('sidebar-title').textContent = 'MODIFIER ATELIER';
            document.getElementById('selected-spot-display').innerHTML = `<span style="color:var(--green);">üìç ${spot.nodeName}</span>`;
            
            document.getElementById('edit-name').value = spot.claimant;
            document.getElementById('edit-url').value = spot.traceUrl || '';
            document.getElementById('edit-theme').value = spot.theme || '';
            document.getElementById('edit-title').value = spot.title || '';
            document.getElementById('edit-desc').value = spot.description || '';
        };
        
        function saveSpot() {
            if (!state.selectedNode && !state.editingSpot) {
                toast('S√©lectionnez un spot sur la carte', true);
                return;
            }
            
            const name = document.getElementById('edit-name').value.trim();
            const theme = document.getElementById('edit-theme').value;
            const title = document.getElementById('edit-title').value.trim();
            
            if (!name) { toast('Pseudo requis', true); return; }
            if (!theme) { toast('Th√©matique requise', true); return; }
            if (!title) { toast('Titre requis', true); return; }
            
            if (state.editingSpot) {
                // Update existing
                state.editingSpot.claimant = name;
                state.editingSpot.traceUrl = document.getElementById('edit-url').value.trim();
                state.editingSpot.theme = theme;
                state.editingSpot.title = title;
                state.editingSpot.description = document.getElementById('edit-desc').value.trim();
                state.editingSpot.updatedAt = new Date().toISOString();
                
                toast('Atelier modifi√©');
            } else {
                // Create new
                const spot = {
                    id: 'spot_' + Date.now(),
                    nodeId: state.selectedNode.id,
                    nodeName: state.selectedNode.name,
                    lat: state.selectedNode.lat,
                    lon: state.selectedNode.lon,
                    zone: state.selectedNode.zone,
                    claimant: name,
                    traceUrl: document.getElementById('edit-url').value.trim(),
                    theme: theme,
                    title: title,
                    description: document.getElementById('edit-desc').value.trim(),
                    createdAt: new Date().toISOString(),
                    participants: [{ name: name, joinedAt: new Date().toISOString() }]
                };
                
                state.spots.push(spot);
                toast('Spot r√©clam√© !');
            }
            
            saveToStorage();
            renderMap();
            renderSpotsList();
            updateStats();
            showPanel('list');
            document.getElementById('sidebar-title').textContent = 'SPOTS DISPONIBLES';
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PARTICIPANTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.openJoinModal = function(spotId) {
            state.joiningSpot = spotId;
            document.getElementById('join-name').value = '';
            document.getElementById('modal-join').classList.remove('hidden');
        };
        
        function joinSpot() {
            const name = document.getElementById('join-name').value.trim();
            if (!name) { toast('Pseudo requis', true); return; }
            
            const spot = state.spots.find(s => s.id === state.joiningSpot);
            if (!spot) return;
            
            if (spot.participants.length >= 9) {
                toast('Atelier complet', true);
                return;
            }
            
            if (spot.participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                toast('Ce pseudo est d√©j√† pris', true);
                return;
            }
            
            spot.participants.push({ name: name, joinedAt: new Date().toISOString() });
            
            saveToStorage();
            renderMap();
            updateStats();
            closeModal('modal-join');
            showDetail(spot.id);
            
            if (spot.participants.length === 5) {
                toast('üéâ Quorum atteint ! Atelier pr√™t');
            } else {
                toast('Participant ajout√©');
            }
        }
        
        window.removeParticipant = function(spotId, index) {
            const spot = state.spots.find(s => s.id === spotId);
            if (!spot || index === 0) return; // Can't remove organizer
            
            spot.participants.splice(index, 1);
            saveToStorage();
            renderMap();
            updateStats();
            showDetail(spot.id);
            toast('Participant retir√©');
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DELETE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.confirmDelete = function(spotId) {
            state.editingSpot = state.spots.find(s => s.id === spotId);
            document.getElementById('modal-delete').classList.remove('hidden');
        };
        
        function deleteSpot() {
            if (!state.editingSpot) return;
            
            state.spots = state.spots.filter(s => s.id !== state.editingSpot.id);
            state.editingSpot = null;
            
            saveToStorage();
            renderMap();
            renderSpotsList();
            updateStats();
            closeModal('modal-delete');
            showPanel('list');
            document.getElementById('sidebar-title').textContent = 'SPOTS DISPONIBLES';
            toast('Atelier supprim√©');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRAPH VIEW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderGraph() {
            const canvas = document.getElementById('graph-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (state.spots.length === 0) {
                ctx.fillStyle = '#444';
                ctx.font = '14px Share Tech Mono';
                ctx.textAlign = 'center';
                ctx.fillText('Aucun atelier cr√©√©', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Calculate positions (force-directed simulation simplified)
            const nodes = state.spots.map((spot, i) => {
                const angle = (i / state.spots.length) * Math.PI * 2;
                const radius = Math.min(canvas.width, canvas.height) * 0.35;
                return {
                    spot: spot,
                    x: canvas.width / 2 + Math.cos(angle) * radius,
                    y: canvas.height / 2 + Math.sin(angle) * radius
                };
            });
            
            // Draw links
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 1;
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const a = nodes[i].spot;
                    const b = nodes[j].spot;
                    
                    if (a.participants.length >= 5 && b.participants.length >= 5) {
                        const dist = getDistance(a.lat, a.lon, b.lat, b.lon);
                        if (dist <= 10) {
                            ctx.globalAlpha = Math.max(0.1, 1 - dist / 10);
                            ctx.beginPath();
                            ctx.moveTo(nodes[i].x, nodes[i].y);
                            ctx.lineTo(nodes[j].x, nodes[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }
            ctx.globalAlpha = 1;
            
            // Draw nodes
            nodes.forEach(node => {
                const spot = node.spot;
                const ready = spot.participants.length >= 5;
                const size = 15 + spot.participants.length * 3;
                
                // Glow
                const gradient = ctx.createRadialGradient(node.x, node.y, 0, node.x, node.y, size * 2);
                gradient.addColorStop(0, ready ? 'rgba(0,255,157,0.3)' : 'rgba(255,234,0,0.3)');
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.fillRect(node.x - size * 2, node.y - size * 2, size * 4, size * 4);
                
                // Node
                ctx.beginPath();
                ctx.arc(node.x, node.y, size, 0, Math.PI * 2);
                ctx.fillStyle = ready ? '#00ff9d' : '#ffea00';
                ctx.fill();
                
                // Participant count
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px Orbitron';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(spot.participants.length, node.x, node.y);
                
                // Label
                ctx.fillStyle = '#888';
                ctx.font = '11px Share Tech Mono';
                ctx.fillText(spot.title || spot.nodeName, node.x, node.y + size + 15);
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + name).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        window.closeModal = closeModal;
        
        function toast(msg, isError = false) {
            const el = document.getElementById('toast');
            document.getElementById('toast-icon').textContent = isError ? '‚ö†' : '‚úì';
            document.getElementById('toast-text').textContent = msg;
            el.classList.toggle('error', isError);
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }
        
        function saveToStorage() {
            localStorage.setItem('ateliers_v3', JSON.stringify(state.spots));
        }
        
        function updateStats() {
            document.getElementById('stat-spots').textContent = state.spots.length;
            document.getElementById('stat-participants').textContent = state.spots.reduce((sum, s) => sum + s.participants.length, 0);
            document.getElementById('stat-ready').textContent = state.spots.filter(s => s.participants.length >= 5).length;
        }
        
        function getThemeEmoji(theme) {
            const map = { mobilite: 'üö≤', environnement: 'üå±', social: 'ü§ù', numerique: 'üíª', culture: 'üé≠', economie: 'üíº' };
            return map[theme] || 'üìã';
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                state.currentView = this.dataset.view;
                
                if (state.currentView === 'graph') {
                    document.getElementById('graph-view').classList.add('active');
                    renderGraph();
                } else {
                    document.getElementById('graph-view').classList.remove('active');
                }
            });
        });
        
        document.getElementById('btn-new').addEventListener('click', () => {
            state.selectedNode = null;
            state.editingSpot = null;
            showPanel('edit');
            document.getElementById('sidebar-title').textContent = 'NOUVEAU SPOT';
            document.getElementById('selected-spot-display').innerHTML = 'Cliquez sur un point de la carte';
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-url').value = '';
            document.getElementById('edit-theme').value = '';
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-desc').value = '';
        });
        
        document.getElementById('btn-cancel').addEventListener('click', () => {
            showPanel('list');
            document.getElementById('sidebar-title').textContent = 'SPOTS DISPONIBLES';
        });
        
        document.getElementById('btn-save').addEventListener('click', saveSpot);
        document.getElementById('btn-join-confirm').addEventListener('click', joinSpot);
        document.getElementById('btn-delete-confirm').addEventListener('click', deleteSpot);
        
        document.getElementById('btn-locate').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    state.map.setView([pos.coords.latitude, pos.coords.longitude], 14);
                });
            }
        });
        
        document.getElementById('btn-links').addEventListener('click', function() {
            state.showLinks = !state.showLinks;
            this.classList.toggle('active', state.showLinks);
            if (state.showLinks) {
                state.layers.links.addTo(state.map);
                renderLinks();
            } else {
                state.map.removeLayer(state.layers.links);
            }
        });
        
        // Resize graph
        window.addEventListener('resize', () => {
            if (state.currentView === 'graph') renderGraph();
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        renderMap();
        renderSpotsList();
        updateStats();
    }
    </script>
</body>
</html>
