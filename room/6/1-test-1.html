<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ouaisfieu :: ATELIER-D√âBAT INDUSTRIEL v2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --mint: #48bb78;
  --mint-dim: #48bb7833;
  --mint-glow: #48bb78aa;
  --lilac: #9f7aea;
  --lilac-dim: #9f7aea33;
  --lilac-glow: #9f7aeaaa;
  --bg: #0a0e14;
  --bg-panel: #0d1117;
  --bg-modal: #111820;
  --text: #c9d1d9;
  --text-dim: #6e7681;
  --border: #21262d;
  --danger: #f85149;
  --warning: #d29922;
  --success: #3fb950;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  width: 100%; height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  overflow: hidden;
  cursor: crosshair;
}

/* === SCANLINES === */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.08) 2px,
    rgba(0, 0, 0, 0.08) 4px
  );
  pointer-events: none;
  z-index: 9999;
}

/* === CRT FLICKER === */
body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.4) 100%);
  pointer-events: none;
  z-index: 9998;
}

/* === MATRIX RAIN CANVAS === */
#matrix-rain {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  opacity: 0.06;
  z-index: 0;
  pointer-events: none;
}

/* === TOP BAR === */
#topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 42px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 100;
  gap: 12px;
}

.topbar-dots {
  display: flex;
  gap: 6px;
}
.topbar-dots span {
  width: 12px; height: 12px;
  border-radius: 50%;
  display: block;
}
.dot-r { background: var(--danger); }
.dot-y { background: var(--warning); }
.dot-g { background: var(--success); }

.topbar-title {
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  flex: 1;
  text-align: center;
}

.topbar-title .blink {
  animation: blink 1.2s infinite;
  color: var(--mint);
}

.topbar-stats {
  font-size: 10px;
  color: var(--text-dim);
  display: flex;
  gap: 14px;
}
.topbar-stats .val { color: var(--mint); font-weight: 600; }
.topbar-stats .val-lilac { color: var(--lilac); font-weight: 600; }

@keyframes blink { 0%,50% { opacity: 1; } 51%,100% { opacity: 0; } }

/* === SIDE PANEL === */
#sidepanel {
  position: fixed;
  top: 42px;
  left: 0;
  width: 320px;
  bottom: 36px;
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  z-index: 90;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--mint-dim) transparent;
  transition: transform 0.3s ease;
}

#sidepanel.collapsed { transform: translateX(-280px); }

#sidepanel::-webkit-scrollbar { width: 4px; }
#sidepanel::-webkit-scrollbar-thumb { background: var(--mint-dim); border-radius: 2px; }

.panel-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--lilac);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.toggle-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-family: inherit;
  font-size: 10px;
  padding: 2px 8px;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.2s;
}
.toggle-btn:hover { border-color: var(--mint); color: var(--mint); }

.ascii-box {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 8px;
  line-height: 1.2;
  color: var(--mint);
  white-space: pre;
  letter-spacing: 0;
  opacity: 0.7;
}

.node-list {
  padding: 8px 0;
}

.node-item {
  padding: 8px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
  transition: all 0.15s;
  border-left: 2px solid transparent;
}

.node-item:hover {
  background: var(--mint-dim);
  border-left-color: var(--mint);
}

.node-item.active {
  background: var(--lilac-dim);
  border-left-color: var(--lilac);
}

.node-item .node-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.node-item .node-label { flex: 1; }
.node-item .node-count {
  font-size: 9px;
  color: var(--text-dim);
  background: var(--border);
  padding: 1px 6px;
  border-radius: 8px;
}

/* legend */
.legend {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  margin-top: 8px;
}
.legend-title {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  margin-bottom: 8px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 10px;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* === GRAPH AREA === */
#graph-container {
  position: fixed;
  top: 42px;
  left: 320px;
  right: 0;
  bottom: 36px;
  z-index: 10;
  overflow: hidden;
  transition: left 0.3s ease;
}

#graph-container.expanded { left: 40px; }

#graph-container svg {
  width: 100%;
  height: 100%;
}

.graph-link {
  stroke: var(--border);
  stroke-width: 1;
  opacity: 0.4;
  transition: all 0.3s;
}
.graph-link.highlighted {
  stroke: var(--mint);
  stroke-width: 2;
  opacity: 0.8;
}
.graph-link.highlighted-lilac {
  stroke: var(--lilac);
  stroke-width: 2;
  opacity: 0.8;
}

.graph-node {
  cursor: pointer;
  transition: all 0.2s;
}
.graph-node:hover .node-circle {
  filter: drop-shadow(0 0 12px currentColor);
}

.node-circle {
  transition: all 0.3s;
}

.node-label-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  fill: var(--text);
  text-anchor: middle;
  pointer-events: none;
  opacity: 0.8;
}

.node-pulse {
  animation: pulse-ring 2.5s ease-out infinite;
}
@keyframes pulse-ring {
  0% { r: 0; opacity: 0.6; }
  100% { r: 30; opacity: 0; }
}

/* === BOTTOM BAR === */
#bottombar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 36px;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 100;
  font-size: 10px;
  color: var(--text-dim);
  gap: 20px;
}

.status-indicator {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--success);
  animation: status-pulse 2s infinite;
  display: inline-block;
  margin-right: 6px;
}
@keyframes status-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.cmd-input {
  flex: 1;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--mint);
  font-family: inherit;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 3px;
  outline: none;
  max-width: 400px;
}
.cmd-input:focus { border-color: var(--mint); }
.cmd-input::placeholder { color: var(--text-dim); }

/* === MODAL === */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}
.modal-overlay.active { display: flex; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal-container {
  width: min(800px, 90vw);
  max-height: 80vh;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow:
    0 0 0 1px var(--border),
    0 0 40px rgba(72, 187, 120, 0.08),
    0 0 80px rgba(159, 122, 234, 0.05);
}

@keyframes modalSlide {
  from { transform: translateY(20px) scale(0.97); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.modal-title-area { flex: 1; }
.modal-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}
.modal-subtitle {
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 2px;
}

.modal-close {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-family: inherit;
  font-size: 12px;
  padding: 4px 10px;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.15s;
}
.modal-close:hover { border-color: var(--danger); color: var(--danger); }

.modal-body {
  padding: 20px;
  overflow-y: auto;
  max-height: calc(80vh - 120px);
  font-size: 12px;
  line-height: 1.7;
  scrollbar-width: thin;
  scrollbar-color: var(--mint-dim) transparent;
}

.modal-body h3 {
  color: var(--mint);
  font-size: 12px;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin: 20px 0 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.modal-body h3:first-child { margin-top: 0; }

.modal-body p { margin-bottom: 10px; color: var(--text); }

.modal-body .highlight {
  color: var(--mint);
  font-weight: 600;
}
.modal-body .highlight-lilac {
  color: var(--lilac);
  font-weight: 600;
}

.modal-body code {
  background: #161b22;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  color: var(--lilac);
}

.modal-body .data-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin: 12px 0;
}

.data-cell {
  background: #161b22;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 10px 12px;
}
.data-cell .data-label {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.data-cell .data-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--mint);
}
.data-cell .data-value.lilac { color: var(--lilac); }

.modal-body .tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin: 8px 0;
}
.tag {
  font-size: 9px;
  padding: 3px 8px;
  border-radius: 3px;
  letter-spacing: 0.5px;
}
.tag-mint { background: var(--mint-dim); color: var(--mint); border: 1px solid var(--mint-dim); }
.tag-lilac { background: var(--lilac-dim); color: var(--lilac); border: 1px solid var(--lilac-dim); }
.tag-danger { background: rgba(248,81,73,0.15); color: var(--danger); border: 1px solid rgba(248,81,73,0.15); }

.modal-body .terminal-block {
  background: #0a0e14;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 12px;
  margin: 10px 0;
  font-size: 11px;
  line-height: 1.6;
  white-space: pre-wrap;
  color: var(--mint);
  position: relative;
}
.terminal-block::before {
  content: '$ ';
  color: var(--lilac);
}

.modal-body .progress-bar {
  width: 100%;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  margin: 6px 0;
  overflow: hidden;
}
.progress-bar .progress-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 1s ease;
}

.modal-links {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.modal-link {
  font-size: 10px;
  padding: 4px 10px;
  border: 1px solid var(--border);
  border-radius: 3px;
  color: var(--text-dim);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s;
}
.modal-link:hover { border-color: var(--lilac); color: var(--lilac); }

/* === NOTIFICATION TOAST === */
.toast {
  position: fixed;
  top: 56px;
  right: 16px;
  background: var(--bg-modal);
  border: 1px solid var(--mint);
  border-radius: 4px;
  padding: 10px 16px;
  font-size: 11px;
  color: var(--mint);
  z-index: 200;
  animation: toastIn 0.3s ease, toastOut 0.3s ease 3s forwards;
  box-shadow: 0 0 20px var(--mint-dim);
}
@keyframes toastIn { from { transform: translateX(100px); opacity: 0; } }
@keyframes toastOut { to { transform: translateX(100px); opacity: 0; } }

/* === GLITCH EFFECT === */
.glitch {
  position: relative;
}
.glitch::before, .glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
}
.glitch::before {
  animation: glitch-1 3s infinite linear alternate-reverse;
  clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
  color: var(--mint);
  left: 2px;
}
.glitch::after {
  animation: glitch-2 3s infinite linear alternate-reverse;
  clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%);
  color: var(--lilac);
  left: -2px;
}
@keyframes glitch-1 {
  0%, 92% { transform: none; } 93% { transform: translate(3px, 0); }
  94% { transform: translate(-3px, 0); } 95% { transform: none; }
}
@keyframes glitch-2 {
  0%, 95% { transform: none; } 96% { transform: translate(-3px, 0); }
  97% { transform: translate(3px, 0); } 98% { transform: none; }
}

/* === TYPING EFFECT === */
.typing {
  overflow: hidden;
  white-space: nowrap;
  border-right: 2px solid var(--mint);
  animation: typing 2s steps(40) 1s both, blinkCaret 0.75s step-end infinite;
  width: 0;
}
@keyframes typing { from { width: 0; } to { width: 100%; } }
@keyframes blinkCaret { from, to { border-color: transparent; } 50% { border-color: var(--mint); } }

/* === TOOLTIP === */
.graph-tooltip {
  position: fixed;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 6px 10px;
  font-size: 10px;
  color: var(--text);
  pointer-events: none;
  z-index: 300;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.graph-tooltip.visible { display: block; }
.graph-tooltip .tt-label { color: var(--mint); font-weight: 600; }
.graph-tooltip .tt-sub { color: var(--text-dim); margin-top: 2px; }

/* responsive */
@media (max-width: 768px) {
  #sidepanel { width: 260px; }
  #graph-container { left: 0; }
  #sidepanel { transform: translateX(-260px); }
  #sidepanel.visible { transform: translateX(0); }
}
</style>
</head>
<body>

<canvas id="matrix-rain"></canvas>

<!-- TOP BAR -->
<div id="topbar">
  <div class="topbar-dots">
    <span class="dot-r"></span>
    <span class="dot-y"></span>
    <span class="dot-g"></span>
  </div>
  <div class="topbar-title">
    ouaisfieu@citizen-intel:~$ <span class="blink">‚ñà</span> ATELIER-D√âBAT INDUSTRIEL ‚Äî GRAPH VIEW ‚Äî <span id="clock"></span>
  </div>
  <div class="topbar-stats">
    <span>NODES <span class="val" id="stat-nodes">0</span></span>
    <span>LINKS <span class="val-lilac" id="stat-links">0</span></span>
    <span>BUDGET <span class="val">29‚Ç¨</span>/mois</span>
  </div>
</div>

<!-- SIDE PANEL -->
<div id="sidepanel">
  <div class="panel-header">
    <span>‚ö° EXPLORATEUR DE N≈íUDS</span>
    <button class="toggle-btn" id="collapse-btn" onclick="togglePanel()">‚óÄ</button>
  </div>
  <div class="ascii-box">
 ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 ‚ïë  ___  _   _  ___  ___ ___    ‚ïë
 ‚ïë / _ \| | | |/ _ \|_ _/ __|   ‚ïë
 ‚ïë| (_) | |_| | (_) || |\__ \   ‚ïë
 ‚ïë \___/ \___/ \___/|___|___/   ‚ïë
 ‚ïë  ___ ___ ___ _   _           ‚ïë
 ‚ïë | __/ _ \ __| | | |          ‚ïë
 ‚ïë | _| (_) | _|| |_| |         ‚ïë
 ‚ïë |_| \___/___|\___/           ‚ïë
 ‚ïë                               ‚ïë
 ‚ïë INTELLIGENCE CITOYENNE v2.0   ‚ïë
 ‚ïë ¬´ fork ¬∑ hack ¬∑ spread ¬ª     ‚ïë
 ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
  <div class="node-list" id="node-list"></div>
  <div class="legend">
    <div class="legend-title">Cat√©gories</div>
    <div class="legend-item"><span class="legend-dot" style="background:#48bb78"></span> Diffusion</div>
    <div class="legend-item"><span class="legend-dot" style="background:#9f7aea"></span> D√©lib√©ration</div>
    <div class="legend-item"><span class="legend-dot" style="background:#f6ad55"></span> Production</div>
    <div class="legend-item"><span class="legend-dot" style="background:#fc8181"></span> Infrastructure</div>
    <div class="legend-item"><span class="legend-dot" style="background:#63b3ed"></span> M√©thodologie</div>
    <div class="legend-item"><span class="legend-dot" style="background:#fbd38d"></span> Juridique</div>
  </div>
</div>

<!-- GRAPH -->
<div id="graph-container">
  <svg id="graph-svg"></svg>
</div>

<!-- BOTTOM BAR -->
<div id="bottombar">
  <span><span class="status-indicator"></span>SYST√àME OP√âRATIONNEL</span>
  <span>üáßüá™ FWB ¬∑ EP ¬∑ D√âCRET 2003</span>
  <input type="text" class="cmd-input" id="cmd-input" placeholder="Tapez un n≈ìud ou 'help' pour les commandes..." onkeydown="handleCmd(event)">
  <span>CC-BY-SA 4.0</span>
  <span>~100 ateliers/an</span>
</div>

<!-- TOOLTIP -->
<div class="graph-tooltip" id="tooltip">
  <div class="tt-label" id="tt-label"></div>
  <div class="tt-sub" id="tt-sub"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal-container" id="modal-container">
    <div class="modal-header" id="modal-header"></div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-links" id="modal-links"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// ====================================================
// DATA MODEL
// ====================================================
const CATEGORIES = {
  diffusion: { color: '#48bb78', icon: 'üì°' },
  deliberation: { color: '#9f7aea', icon: 'üó≥Ô∏è' },
  production: { color: '#f6ad55', icon: 'üè≠' },
  infrastructure: { color: '#fc8181', icon: 'üèõÔ∏è' },
  methodology: { color: '#63b3ed', icon: 'üß≠' },
  legal: { color: '#fbd38d', icon: '‚öñÔ∏è' }
};

const nodes = [
  {
    id: 'youtube', label: 'YouTube\n+ Commentaires', category: 'diffusion', size: 28,
    subtitle: 'CANAL DE DIFFUSION PRINCIPAL',
    content: `<h3>Format Vid√©o "3-Act Debate" (6-9 min)</h3>
<p>Les vid√©os de <span class="highlight">moins de 6 minutes</span> maintiennent ~100% d'engagement. Le format optimal :</p>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Accroche + Th√®se</div><div class="data-value">0:00‚Äì1:30</div></div>
  <div class="data-cell"><div class="data-label">Contexte / Preuves</div><div class="data-value">1:30‚Äì4:00</div></div>
  <div class="data-cell"><div class="data-label">Approfondissement</div><div class="data-value">4:30‚Äì7:00</div></div>
  <div class="data-cell"><div class="data-label">Synth√®se + CTA</div><div class="data-value">7:30‚Äì9:00</div></div>
</div>
<h3>Le commentaire √©pingl√© est l'arme secr√®te</h3>
<p>Un commentaire √©pingl√© bien con√ßu <span class="highlight">augmente les r√©ponses de 30%</span>. Formules :</p>
<div class="tag-list">
  <span class="tag tag-mint">Q&A Hook</span>
  <span class="tag tag-lilac">Micro-sondage emoji</span>
  <span class="tag tag-mint">Prompt timestamp</span>
  <span class="tag tag-danger">‚äò "Qu'en pensez-vous ?"</span>
</div>
<p>R√©pondre dans les <span class="highlight">premi√®res 24-72h</span> est crucial pour le boost algorithmique.</p>
<h3>Mod√®les inspirants</h3>
<p><span class="highlight-lilac">Osons Causer</span> : 5-6 min, 15,5M+ vues, √©ducation populaire. <span class="highlight-lilac">Data Gueule</span> : data-journalisme, 425K abonn√©s. Fait cl√© : les <span class="highlight">petites cha√Ænes sp√©cialis√©es</span> produisent un d√©bat de meilleure qualit√© que les grandes cha√Ænes g√©n√©ralistes (√©tude : 2,2M commentaires, 57 cha√Ænes).</p>`,
    links: ['pol-is', 'commentaire-√©pingl√©', 'consider-it', 'peertube', 'h5p', 'voir-penser-agir', 'whisper']
  },
  {
    id: 'peertube', label: 'PeerTube\nFediverse', category: 'diffusion', size: 22,
    subtitle: 'VID√âO F√âD√âR√âE ¬∑ SOUVERAINE',
    content: `<h3>Architecture ActivityPub</h3>
<p>PeerTube communique avec <span class="highlight">Mastodon, Mobilizon, Castopod</span> via le protocole ActivityPub. Un commentaire PeerTube appara√Æt sur Mastodon. Un √©v√©nement Mobilizon est visible partout.</p>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Protocole</div><div class="data-value">ActivityPub</div></div>
  <div class="data-cell"><div class="data-label">Licence</div><div class="data-value">AGPL v3</div></div>
  <div class="data-cell"><div class="data-label">Co√ªt VPS</div><div class="data-value lilac">~5-7‚Ç¨/m</div></div>
  <div class="data-cell"><div class="data-label">P2P Streaming</div><div class="data-value">WebTorrent</div></div>
</div>
<h3>Avantages sur YouTube</h3>
<p>Pas de tracking, pas d'algorithme de radicalisation, pas de pub. Les vid√©os peuvent √™tre <span class="highlight">f√©d√©r√©es entre instances</span> ‚Äî votre contenu reste accessible m√™me si votre serveur tombe. Int√®gre nativement les plugins pour le sous-titrage et les chapitres.</p>
<div class="terminal-block">apt install peertube  # sur VPS OVH √† 5‚Ç¨/mois</div>`,
    links: ['youtube', 'budget', 'mastodon-bluesky', 'mobilizon']
  },
  {
    id: 'mastodon-bluesky', label: 'Mastodon\nBluesky', category: 'diffusion', size: 18,
    subtitle: 'R√âSEAUX SOCIAUX OUVERTS',
    content: `<h3>Double strat√©gie de diffusion</h3>
<p><span class="highlight">Mastodon</span> (Fediverse, auto-h√©bergeable) + <span class="highlight-lilac">Bluesky</span> (AT Protocol, croissance rapide) pour maximiser la port√©e sans d√©pendance √† une plateforme unique.</p>
<p>Chaque atelier-d√©bat est annonc√© avec un thread structur√© : question d'accroche ‚Üí lien vid√©o ‚Üí questions de d√©bat ‚Üí lien vers la synth√®se collaborative.</p>
<div class="tag-list">
  <span class="tag tag-mint">Mastodon</span>
  <span class="tag tag-lilac">Bluesky</span>
  <span class="tag tag-mint">Telegram</span>
  <span class="tag tag-lilac">Reddit</span>
  <span class="tag tag-mint">Facebook Groups</span>
</div>`,
    links: ['peertube', 'youtube', 'mobilizon']
  },
  {
    id: 'pol-is', label: 'Pol.is', category: 'deliberation', size: 26,
    subtitle: 'D√âLIB√âRATION ANTI-TROLLING ¬∑ ML CONSENSUS',
    content: `<h3>L'arme secr√®te de la d√©mocratie ta√Øwanaise</h3>
<p>Open source (MIT), utilis√© par <span class="highlight">vTaiwan</span> pour l√©gif√©rer. R√©sultat : <span class="highlight">80% des d√©lib√©rations</span> ont men√© √† une action gouvernementale.</p>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Cas Uber Taiwan</div><div class="data-value">31 115</div><div class="data-label" style="margin-top:2px">votes</div></div>
  <div class="data-cell"><div class="data-label">Participants</div><div class="data-value lilac">925</div></div>
  <div class="data-cell"><div class="data-label">Licence</div><div class="data-value">MIT</div></div>
  <div class="data-cell"><div class="data-label">Tracking</div><div class="data-value" style="color:var(--success)">AUCUN</div></div>
</div>
<h3>Anti-trolling by design</h3>
<p>Les utilisateurs soumettent des <span class="highlight-lilac">d√©clarations courtes</span>, les autres votent "d'accord/pas d'accord/passe". <span class="highlight">Aucune r√©ponse directe n'est possible.</span> Le ML regroupe les opinions par patterns et fait √©merger les d√©clarations consensus.</p>
<div class="terminal-block">git clone https://github.com/compdemocracy/polis</div>`,
    links: ['youtube', 'consider-it', 'your-priorities', 'anti-trolling', 'voir-penser-agir']
  },
  {
    id: 'consider-it', label: 'Consider.it', category: 'deliberation', size: 18,
    subtitle: 'SLIDER D\'OPINION ¬∑ VISUALISATION',
    content: `<h3>D√©lib√©ration par positionnement visuel</h3>
<p>Chaque proposition g√©n√®re un <span class="highlight">slider</span> (d√©saccord ‚Üî accord) + une liste personnelle pour/contre. Un <span class="highlight-lilac">histogramme pictural</span> visualise la distribution des positions de la communaut√©.</p>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Licence</div><div class="data-value">AGPL v3</div></div>
  <div class="data-cell"><div class="data-label">Stack</div><div class="data-value lilac">Ruby + React</div></div>
</div>
<p>La recherche d√©montre que cet outil <span class="highlight">modifie significativement les positions</span> des utilisateurs et leur perception des connaissances.</p>`,
    links: ['pol-is', 'your-priorities', 'agorakit']
  },
  {
    id: 'your-priorities', label: 'Your\nPriorities', category: 'deliberation', size: 20,
    subtitle: 'CITIZENS FOUNDATION ¬∑ #1 MONDIAL',
    content: `<h3>Plateforme #1 mondiale de participation citoyenne</h3>
<p>Class√© <span class="highlight">#1 par PeoplePowered en 2025</span>. Utilis√© dans 45 pays par 2+ millions de personnes.</p>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Better Reykjavik</div><div class="data-value">70 000</div><div class="data-label" style="margin-top:2px">citoyens engag√©s</div></div>
  <div class="data-cell"><div class="data-label">Id√©es g√©n√©r√©es</div><div class="data-value lilac">10 000+</div></div>
</div>
<p>Design similaire √† Pol.is : <span class="highlight-lilac">interdit les r√©ponses directes</span>. Les utilisateurs doivent √©crire des contre-points ind√©pendants.</p>`,
    links: ['pol-is', 'consider-it', 'anti-trolling']
  },
  {
    id: 'agorakit', label: 'Agorakit\nüáßüá™', category: 'deliberation', size: 16,
    subtitle: 'PLATEFORME BELGE ¬∑ CITOYENNE',
    content: `<h3>Le groupware citoyen belge</h3>
<p>Cr√©√© en Belgique, <span class="highlight">AGPL, Laravel/PHP</span>. Utilis√© par "Tout Autre Chose" et "Hart boven Hard".</p>
<div class="tag-list">
  <span class="tag tag-mint">Forum</span>
  <span class="tag tag-lilac">Calendrier</span>
  <span class="tag tag-mint">Fichiers</span>
  <span class="tag tag-lilac">Cartographie</span>
</div>
<p>Instance gratuite sur <code>app.agorakit.org</code>. Philosophie horizontale, pas de hi√©rarchie.</p>
<div class="terminal-block">git clone https://codeberg.org/agorakit/agorakit</div>`,
    links: ['consider-it', 'mobilizon', 'bascule-presentiel']
  },
  {
    id: 'anti-trolling', label: 'Anti-Trolling\nby Design', category: 'methodology', size: 20,
    subtitle: 'D√âCOUVERTE CL√â DE LA RECHERCHE',
    content: `<h3>Interdire les r√©ponses directes = meilleur d√©bat</h3>
<p>La d√©couverte la plus contre-intuitive : les plateformes les plus efficaces pour le d√©bat citoyen (<span class="highlight">Pol.is, Your Priorities, Consider.it</span>) <span class="highlight-lilac">interdisent les r√©ponses directes</span> entre participants.</p>
<p>Ce choix, valid√© √† l'√©chelle nationale √† <span class="highlight">Taiwan et en Islande</span>, √©limine les attaques personnelles et force la contribution constructive.</p>
<h3>M√©canismes</h3>
<div class="tag-list">
  <span class="tag tag-mint">Pas de reply direct</span>
  <span class="tag tag-lilac">Vote silencieux</span>
  <span class="tag tag-mint">ML clustering</span>
  <span class="tag tag-lilac">Consensus √©mergent</span>
  <span class="tag tag-danger">‚äò Fils de discussion</span>
</div>`,
    links: ['pol-is', 'your-priorities', 'voir-penser-agir']
  },
  {
    id: 'batch-production', label: 'Batch\nProcessing', category: 'production', size: 24,
    subtitle: '~100 ATELIERS/AN ¬∑ 8-11H/SEMAINE',
    content: `<h3>Production industrielle en solo</h3>
<p>Le batch processing r√©duit le temps de production de <span class="highlight">20+ heures pour 10 contenus √† 9 heures</span>.</p>
<h3>Cycle hebdomadaire (2 ateliers/semaine)</h3>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Lundi</div><div class="data-value">2-3h</div><div class="data-label" style="margin-top:2px">Sources + Questions</div></div>
  <div class="data-cell"><div class="data-label">Mardi</div><div class="data-value lilac">1-2h</div><div class="data-label" style="margin-top:2px">Scripts + Enregistrement</div></div>
  <div class="data-cell"><div class="data-label">Mercredi</div><div class="data-value">2-3h</div><div class="data-label" style="margin-top:2px">Montage + Sous-titres</div></div>
  <div class="data-cell"><div class="data-label">Jeudi‚ÜíVen</div><div class="data-value lilac">2-3h</div><div class="data-label" style="margin-top:2px">Assemblage + Diffusion</div></div>
</div>
<h3>Charge estim√©e</h3>
<div class="progress-bar"><div class="progress-fill" style="width:60%;background:var(--mint)"></div></div>
<p style="font-size:10px;color:var(--text-dim)">~8-11h/semaine sur une capacit√© estim√©e de 20h ‚Üí 60% d'utilisation</p>`,
    links: ['atelier-kit', 'h5p', 'whisper', 'youtube', 'peertube']
  },
  {
    id: 'atelier-kit', label: 'Atelier\nen Kit', category: 'production', size: 22,
    subtitle: 'TEMPLATE GITHUB FORKABLE',
    content: `<h3>Un d√©p√¥t GitHub par atelier, forkable √† l'infini</h3>
<div class="terminal-block">/atelier-nom-du-sujet/
‚îú‚îÄ‚îÄ README.md          # vue d'ensemble
‚îú‚îÄ‚îÄ hook-video.mp4     # lien YouTube/PeerTube
‚îú‚îÄ‚îÄ document-ref.md    # mat√©riel source
‚îú‚îÄ‚îÄ questions-debat.md # 3 niveaux Bloom
‚îú‚îÄ‚îÄ synthese.md        # template Framapad
‚îú‚îÄ‚îÄ visuels/           # r√©seaux sociaux
‚îú‚îÄ‚îÄ LICENSE            # CC-BY-SA 4.0
‚îî‚îÄ‚îÄ GUIDE-ANIMATEUR.md # pr√©sentiel</div>
<h3>4 phases p√©dagogiques</h3>
<p><span class="highlight">1.</span> Vid√©o d'accroche (2-3 min) ‚Üí <span class="highlight">2.</span> Document de r√©f√©rence (800-1200 mots) ‚Üí <span class="highlight">3.</span> Questions √† 3 niveaux (compr√©hension, opinion, proposition) ‚Üí <span class="highlight">4.</span> Synth√®se collaborative Framapad.</p>`,
    links: ['batch-production', 'cc-by-sa', 'voir-penser-agir', 'bascule-presentiel']
  },
  {
    id: 'voir-penser-agir', label: 'Voir\nPenser\nAgir', category: 'methodology', size: 26,
    subtitle: 'M√âTHODOLOGIE CPCP ¬∑ √âDUCATION PERMANENTE',
    content: `<h3>Le cadre p√©dagogique de r√©f√©rence en FWB</h3>
<p>M√©thodologie du <span class="highlight-lilac">CPCP</span> (35-43 collaborateurs, 4 antennes) ‚Äî directement transposable en asynchrone.</p>
<h3>Transposition asynchrone</h3>
<p><span class="highlight">VOIR</span> = Consommation de contenu (vid√©o + document) avec prompts de r√©flexion personnelle.</p>
<p><span class="highlight-lilac">PENSER</span> = D√©lib√©ration structur√©e via Pol.is / Consider.it / commentaires guid√©s. World Caf√© virtuel : threads s√©quentiels √† dur√©e limit√©e (48h).</p>
<p><span class="highlight">AGIR</span> = Co-r√©daction collaborative (CryptPad/Framapad) de propositions, p√©titions, projets locaux ‚Üí <span class="highlight-lilac">bascule pr√©sentiel</span>.</p>
<h3>Validation √† grande √©chelle</h3>
<p>MOOC Colibris "(R)√©volutions Locales" : √©ducation populaire num√©rique. MOOC "Concevoir une Oasis" : <span class="highlight">30 000+ participants</span>.</p>`,
    links: ['pol-is', 'atelier-kit', 'bascule-presentiel', 'anti-trolling', 'youtube', 'infrastructure-belge']
  },
  {
    id: 'budget', label: 'Budget\n29‚Ç¨/mois', category: 'production', size: 20,
    subtitle: 'INFRASTRUCTURE COMPL√àTE',
    content: `<h3>Ventilation budg√©taire</h3>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">YouTube</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">PeerTube VPS</div><div class="data-value lilac">~6‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">Mastodon</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">CryptPad</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">Framapad</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">Mobilizon</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">GitHub Pages</div><div class="data-value" style="color:var(--success)">0‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">Domaine .be</div><div class="data-value">~1‚Ç¨</div></div>
</div>
<h3>Total</h3>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">Infrastructure</div><div class="data-value">~7‚Ç¨</div></div>
  <div class="data-cell"><div class="data-label">Marge restante</div><div class="data-value lilac">~22‚Ç¨</div></div>
</div>
<p>La marge finance un micro, une instance Loomio Community (10$/mois), ou un h√©bergement CryptPad d√©di√©.</p>`,
    links: ['peertube', 'batch-production', 'infrastructure-belge']
  },
  {
    id: 'h5p', label: 'H5P\nInteractif', category: 'production', size: 16,
    subtitle: 'VID√âO INTERACTIVE OPEN SOURCE',
    content: `<h3>Transformer toute vid√©o en atelier interactif</h3>
<p>Open source (MIT). Transforme n'importe quelle vid√©o YouTube en vid√©o interactive : <span class="highlight">QCM, textes pop-up, liens</span> int√©gr√©s √† des timestamps pr√©cis. La vid√©o se met en <span class="highlight-lilac">pause automatiquement</span>.</p>
<div class="tag-list">
  <span class="tag tag-mint">WordPress</span>
  <span class="tag tag-lilac">Drupal</span>
  <span class="tag tag-mint">Moodle</span>
  <span class="tag tag-lilac">iframe GitHub Pages</span>
</div>
<p><span class="highlight">Lumi Education</span> : app desktop pour cr√©er/√©diter des H5P hors ligne.</p>`,
    links: ['youtube', 'batch-production', 'whisper']
  },
  {
    id: 'whisper', label: 'Whisper AI\nSous-titrage', category: 'production', size: 14,
    subtitle: 'SOUS-TITRAGE AUTOMATIQUE ¬∑ BATCH',
    content: `<h3>Faster-Whisper : 4-8x plus rapide</h3>
<p>Variante optimis√©e d'OpenAI Whisper. <span class="highlight">Traite un dossier entier de vid√©os en batch</span> via le script whisper-video.</p>
<p>Triple fonction : <span class="highlight-lilac">accessibilit√©</span> + <span class="highlight">SEO</span> (+20% de vues) + <span class="highlight-lilac">transcriptions textuelles</span> pour le site web.</p>
<div class="terminal-block">pip install faster-whisper
python -m whisper_video --model large-v3 ./videos/</div>`,
    links: ['batch-production', 'youtube', 'h5p', 'cc-by-sa']
  },
  {
    id: 'bascule-presentiel', label: 'Bascule\nPr√©sentiel', category: 'infrastructure', size: 22,
    subtitle: 'SEUIL DE 5 ¬∑ CODE POSTAL VOLONTAIRE',
    content: `<h3>M√©canisme RGPD-by-design</h3>
<p>Code postal belge volontaire (4 chiffres). Regroupement par les <span class="highlight">deux premiers chiffres</span> :</p>
<div class="tag-list">
  <span class="tag tag-mint">10xx = Bruxelles</span>
  <span class="tag tag-lilac">40xx = Li√®ge</span>
  <span class="tag tag-mint">50xx = Namur</span>
  <span class="tag tag-lilac">70xx = Mons</span>
</div>
<p>Quand <span class="highlight">5+ utilisateurs</span> partagent la m√™me zone ‚Üí email automatique + lien <span class="highlight-lilac">Framadate</span>.</p>
<p><span class="highlight">Aucun GPS, aucune g√©olocalisation IP.</span></p>
<h3>Mod√®le Shifters</h3>
<p>25 000+ personnes, 75+ groupes locaux. R√©unions mensuelles, chaque groupe a un "pilote" volontaire. Quand 3+ rencontres ‚Üí formaliser en "groupe local" avec kit de d√©marrage.</p>`,
    links: ['infrastructure-belge', 'mobilizon', 'voir-penser-agir', 'agorakit']
  },
  {
    id: 'infrastructure-belge', label: 'Infra\nBelge', category: 'infrastructure', size: 28,
    subtitle: '~280 ASBL ¬∑ CENTAINES DE LIEUX GRATUITS',
    content: `<h3>Un maillage territorial sans √©quivalent en Europe</h3>
<div class="data-grid">
  <div class="data-cell"><div class="data-label">ASBL √âducation Permanente</div><div class="data-value">~280</div></div>
  <div class="data-cell"><div class="data-label">ETP employ√©s</div><div class="data-value lilac">~2 300</div></div>
  <div class="data-cell"><div class="data-label">EPN Wallonie</div><div class="data-value">200+</div></div>
  <div class="data-cell"><div class="data-label">Centres Culturels</div><div class="data-value lilac">122</div></div>
</div>
<h3>Lieux gratuits par type</h3>
<p><span class="highlight">Biblioth√®ques publiques</span> : salles d'animation, d√©j√† dans l'animation citoyenne. Ex: Nivelles accueille des "soir√©es citoyennes" avec le CIEP.</p>
<p><span class="highlight-lilac">EPN</span> : 200+ en Wallonie, 30+ √† Bruxelles (CABAN). Accompagnement num√©rique inclus.</p>
<p><span class="highlight">Espaces Wallonie</span> : salles gratuites √† Li√®ge, Mons, Nivelles, Verviers, Tournai (9h-16h30, caf√© fourni ‚òï).</p>
<p><span class="highlight-lilac">Maisons de Quartier</span> : 18-19 √† Bruxelles, mission de d√©bat citoyen.</p>
<h3>Partenaires naturels</h3>
<div class="tag-list">
  <span class="tag tag-mint">CPCP</span>
  <span class="tag tag-lilac">PAC (~200 sections)</span>
  <span class="tag tag-mint">Centre Action La√Øque</span>
  <span class="tag tag-lilac">CEPAG/FGTB</span>
  <span class="tag tag-mint">COCOF</span>
</div>`,
    links: ['bascule-presentiel', 'voir-penser-agir', 'budget']
  },
  {
    id: 'mobilizon', label: 'Mobilizon\n√âv√©nements', category: 'infrastructure', size: 16,
    subtitle: 'ALTERNATIVE F√âD√âR√âE √Ä MEETUP/FACEBOOK',
    content: `<h3>√âv√©nements sans Facebook</h3>
<p>D√©velopp√© par <span class="highlight">Framasoft</span>, f√©d√©r√© via ActivityPub. Cr√©ation d'√©v√©nements, groupes, ressources ‚Äî le tout interconnect√© avec Mastodon et PeerTube.</p>
<p>Parfait pour organiser les <span class="highlight-lilac">bascules pr√©sentiel</span> quand le seuil de 5 est atteint. Instances gratuites disponibles.</p>`,
    links: ['peertube', 'bascule-presentiel', 'agorakit', 'mastodon-bluesky']
  },
  {
    id: 'cc-by-sa', label: 'CC-BY-SA\n4.0', category: 'legal', size: 18,
    subtitle: 'LICENCE ¬∑ VIRALIT√â DE L\'OUVERTURE',
    content: `<h3>Le fork comme strat√©gie de diffusion</h3>
<p><span class="highlight">Attribution</span> = reconnaissance de ouaisfieu dans chaque fork.</p>
<p><span class="highlight-lilac">ShareAlike</span> = toutes les adaptations restent ouvertes ‚Üí viralit√© de l'ouverture.</p>
<h3>Pourquoi PAS NC ni ND</h3>
<div class="tag-list">
  <span class="tag tag-danger">‚äò NonCommercial</span>
  <span class="tag tag-danger">‚äò NoDerivatives</span>
</div>
<p>NC emp√™cherait les associations d'utiliser les ateliers dans des formations payantes. ND emp√™cherait le fork m√™me. Les deux sont <span class="highlight">incompatibles avec la logique d'essaimage</span>.</p>`,
    links: ['atelier-kit', 'whisper', 'batch-production']
  },
  {
    id: 'framasoft', label: 'Mod√®le\nFramasoft', category: 'methodology', size: 18,
    subtitle: '35 MEMBRES ¬∑ IMPACT MASSIF',
    content: `<h3>"Les clous, les planches et les marteaux"</h3>
<p><span class="highlight">35 membres, 10 salari√©s</span> produisant un impact massif gr√¢ce √† trois principes :</p>
<p>1. <span class="highlight-lilac">Tout ouvrir</span> sous licences libres (fork communautaire)</p>
<p>2. <span class="highlight">Utiliser ses propres outils</span> (Framapad, PeerTube, Framablog)</p>
<p>3. <span class="highlight-lilac">Archip√©liser</span> ‚Äî connecter des communaut√©s alli√©es qui redistribuent et adaptent le contenu.</p>
<p>Devise : <em>"Framasoft fournit les clous, les planches et les marteaux. √Ä vous d'inventer et construire les projets."</em></p>`,
    links: ['peertube', 'mobilizon', 'cc-by-sa', 'voir-penser-agir']
  },
  {
    id: 'commentaire-√©pingl√©', label: 'Commentaire\n√âpingl√©', category: 'diffusion', size: 14,
    subtitle: 'TECHNIQUE D\'ENGAGEMENT +30%',
    content: `<h3>L'outil d'animation asynchrone #1</h3>
<p>Le commentaire √©pingl√© structure le d√©bat. Trois formules test√©es :</p>
<p><span class="highlight">"Q&A Hook"</span> : "J'ai partag√© mon analyse de ___. Et vous, quelle est votre exp√©rience ?"</p>
<p><span class="highlight-lilac">"Micro-sondage"</span> : "Votez : üü¢ pour, üî¥ contre, üü° nuanc√© ‚Äî et expliquez en reply !"</p>
<p><span class="highlight">"Prompt timestamp"</span> : "√Ä 4:23 je dis que ___. √ätes-vous d'accord ? R√©pondez avec votre argument."</p>`,
    links: ['youtube', 'anti-trolling']
  }
];

// Build links from node data
const links = [];
const linkSet = new Set();
nodes.forEach(n => {
  (n.links || []).forEach(targetId => {
    const key = [n.id, targetId].sort().join('--');
    if (!linkSet.has(key) && nodes.find(x => x.id === targetId)) {
      linkSet.add(key);
      links.push({ source: n.id, target: targetId });
    }
  });
});

// ====================================================
// MATRIX RAIN
// ====================================================
const matrixCanvas = document.getElementById('matrix-rain');
const matrixCtx = matrixCanvas.getContext('2d');
matrixCanvas.width = window.innerWidth;
matrixCanvas.height = window.innerHeight;

const chars = 'ouaisfieu01„Éï„Ç©„Éº„ÇØ„Éè„ÉÉ„ÇØ„Çπ„Éó„É¨„ÉÉ„ÉâÊ∞ë‰∏ª‰∏ªÁæ©Œ±Œ≤Œ≥Œ¥‚àë‚à´‚âà‚â†‚àû'.split('');
const fontSize = 12;
const columns = Math.floor(matrixCanvas.width / fontSize);
const drops = Array(columns).fill(1);

function drawMatrix() {
  matrixCtx.fillStyle = 'rgba(10, 14, 20, 0.05)';
  matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
  matrixCtx.fillStyle = '#48bb78';
  matrixCtx.font = fontSize + 'px JetBrains Mono';
  for (let i = 0; i < drops.length; i++) {
    const text = chars[Math.floor(Math.random() * chars.length)];
    matrixCtx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 50);

// ====================================================
// CLOCK
// ====================================================
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('fr-BE', { hour12: false });
}
setInterval(updateClock, 1000);
updateClock();

// ====================================================
// SIDE PANEL
// ====================================================
function buildNodeList() {
  const list = document.getElementById('node-list');
  list.innerHTML = '';
  nodes.forEach(n => {
    const cat = CATEGORIES[n.category];
    const item = document.createElement('div');
    item.className = 'node-item';
    item.dataset.id = n.id;
    item.innerHTML = `
      <span class="node-dot" style="background:${cat.color}"></span>
      <span class="node-label">${n.label.replace(/\n/g, ' ')}</span>
      <span class="node-count">${(n.links||[]).length}</span>
    `;
    item.addEventListener('click', () => openModal(n.id));
    item.addEventListener('mouseenter', () => highlightNode(n.id));
    item.addEventListener('mouseleave', () => unhighlightAll());
    list.appendChild(item);
  });
}
buildNodeList();

document.getElementById('stat-nodes').textContent = nodes.length;
document.getElementById('stat-links').textContent = links.length;

let panelCollapsed = false;
function togglePanel() {
  panelCollapsed = !panelCollapsed;
  document.getElementById('sidepanel').classList.toggle('collapsed', panelCollapsed);
  document.getElementById('graph-container').classList.toggle('expanded', panelCollapsed);
  document.getElementById('collapse-btn').textContent = panelCollapsed ? '‚ñ∂' : '‚óÄ';
  if (simulation) simulation.alpha(0.3).restart();
}

// ====================================================
// FORCE GRAPH (D3)
// ====================================================
const svg = d3.select('#graph-svg');
const container = document.getElementById('graph-container');
let width = container.clientWidth;
let height = container.clientHeight;

const g = svg.append('g');

// Zoom
const zoom = d3.zoom()
  .scaleExtent([0.3, 4])
  .on('zoom', (event) => g.attr('transform', event.transform));
svg.call(zoom);

// Defs for glow
const defs = svg.append('defs');
['mint', 'lilac'].forEach(name => {
  const color = name === 'mint' ? '#48bb78' : '#9f7aea';
  const filter = defs.append('filter').attr('id', `glow-${name}`);
  filter.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'coloredBlur');
  const merge = filter.append('feMerge');
  merge.append('feMergeNode').attr('in', 'coloredBlur');
  merge.append('feMergeNode').attr('in', 'SourceGraphic');
});

// Links
const linkElements = g.append('g')
  .selectAll('line')
  .data(links)
  .join('line')
  .attr('class', 'graph-link')
  .attr('data-source', d => d.source)
  .attr('data-target', d => d.target);

// Nodes
const nodeElements = g.append('g')
  .selectAll('g')
  .data(nodes)
  .join('g')
  .attr('class', 'graph-node')
  .call(d3.drag()
    .on('start', dragStarted)
    .on('drag', dragged)
    .on('end', dragEnded));

// Pulse ring
nodeElements.append('circle')
  .attr('class', 'node-pulse')
  .attr('r', 0)
  .attr('fill', 'none')
  .attr('stroke', d => CATEGORIES[d.category].color)
  .attr('stroke-width', 1)
  .style('animation-delay', d => `${Math.random() * 2.5}s`);

// Main circle
nodeElements.append('circle')
  .attr('class', 'node-circle')
  .attr('r', d => d.size / 2)
  .attr('fill', d => CATEGORIES[d.category].color + '25')
  .attr('stroke', d => CATEGORIES[d.category].color)
  .attr('stroke-width', 1.5)
  .style('color', d => CATEGORIES[d.category].color);

// Inner dot
nodeElements.append('circle')
  .attr('r', 3)
  .attr('fill', d => CATEGORIES[d.category].color);

// Labels
nodeElements.each(function(d) {
  const lines = d.label.split('\n');
  const el = d3.select(this);
  lines.forEach((line, i) => {
    el.append('text')
      .attr('class', 'node-label-text')
      .attr('dy', d.size / 2 + 12 + i * 12)
      .text(line);
  });
});

// Events
nodeElements
  .on('click', (event, d) => { event.stopPropagation(); openModal(d.id); })
  .on('mouseenter', (event, d) => {
    highlightNode(d.id);
    const tt = document.getElementById('tooltip');
    document.getElementById('tt-label').textContent = d.label.replace(/\n/g, ' ');
    document.getElementById('tt-sub').textContent = d.subtitle;
    tt.classList.add('visible');
    tt.style.left = (event.clientX + 14) + 'px';
    tt.style.top = (event.clientY - 10) + 'px';
  })
  .on('mousemove', (event) => {
    const tt = document.getElementById('tooltip');
    tt.style.left = (event.clientX + 14) + 'px';
    tt.style.top = (event.clientY - 10) + 'px';
  })
  .on('mouseleave', () => {
    unhighlightAll();
    document.getElementById('tooltip').classList.remove('visible');
  });

// Simulation
const simulation = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(links).id(d => d.id).distance(120).strength(0.4))
  .force('charge', d3.forceManyBody().strength(-400))
  .force('center', d3.forceCenter(width / 2, height / 2))
  .force('collision', d3.forceCollide().radius(d => d.size + 10))
  .on('tick', ticked);

function ticked() {
  linkElements
    .attr('x1', d => d.source.x)
    .attr('y1', d => d.source.y)
    .attr('x2', d => d.target.x)
    .attr('y2', d => d.target.y);
  nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
}

function dragStarted(event) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  event.subject.fx = event.subject.x;
  event.subject.fy = event.subject.y;
}
function dragged(event) {
  event.subject.fx = event.x;
  event.subject.fy = event.y;
}
function dragEnded(event) {
  if (!event.active) simulation.alphaTarget(0);
  event.subject.fx = null;
  event.subject.fy = null;
}

// Resize
window.addEventListener('resize', () => {
  width = container.clientWidth;
  height = container.clientHeight;
  simulation.force('center', d3.forceCenter(width / 2, height / 2));
  simulation.alpha(0.3).restart();
  matrixCanvas.width = window.innerWidth;
  matrixCanvas.height = window.innerHeight;
});

// ====================================================
// HIGHLIGHT
// ====================================================
function highlightNode(nodeId) {
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  const connectedIds = new Set(node.links || []);
  connectedIds.add(nodeId);

  nodeElements.select('.node-circle')
    .attr('opacity', d => connectedIds.has(d.id) ? 1 : 0.15)
    .attr('stroke-width', d => d.id === nodeId ? 3 : connectedIds.has(d.id) ? 2 : 1);

  nodeElements.selectAll('.node-label-text')
    .attr('opacity', d => connectedIds.has(d.id) ? 1 : 0.1);

  linkElements
    .attr('class', d => {
      const sid = typeof d.source === 'object' ? d.source.id : d.source;
      const tid = typeof d.target === 'object' ? d.target.id : d.target;
      if ((sid === nodeId && connectedIds.has(tid)) || (tid === nodeId && connectedIds.has(sid))) {
        return 'graph-link highlighted';
      }
      return 'graph-link';
    })
    .attr('opacity', d => {
      const sid = typeof d.source === 'object' ? d.source.id : d.source;
      const tid = typeof d.target === 'object' ? d.target.id : d.target;
      return (sid === nodeId || tid === nodeId) ? 0.8 : 0.08;
    });

  document.querySelectorAll('.node-item').forEach(el => {
    el.classList.toggle('active', connectedIds.has(el.dataset.id));
  });
}

function unhighlightAll() {
  nodeElements.select('.node-circle').attr('opacity', 1).attr('stroke-width', 1.5);
  nodeElements.selectAll('.node-label-text').attr('opacity', 0.8);
  linkElements.attr('class', 'graph-link').attr('opacity', 0.4);
  document.querySelectorAll('.node-item').forEach(el => el.classList.remove('active'));
}

// ====================================================
// MODAL
// ====================================================
function openModal(nodeId) {
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  const cat = CATEGORIES[node.category];

  document.getElementById('modal-header').innerHTML = `
    <div class="modal-icon" style="background:${cat.color}22;color:${cat.color};border:1px solid ${cat.color}44">${cat.icon}</div>
    <div class="modal-title-area">
      <div class="modal-title">${node.label.replace(/\n/g, ' ')}</div>
      <div class="modal-subtitle">${node.subtitle}</div>
    </div>
    <button class="modal-close" onclick="closeModal()">ESC</button>
  `;
  document.getElementById('modal-body').innerHTML = node.content;

  const linksEl = document.getElementById('modal-links');
  linksEl.innerHTML = '<span style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;padding:4px 0">Connexions :</span>';
  (node.links || []).forEach(lid => {
    const linked = nodes.find(n => n.id === lid);
    if (linked) {
      const a = document.createElement('a');
      a.className = 'modal-link';
      a.textContent = linked.label.replace(/\n/g, ' ');
      a.onclick = () => openModal(lid);
      linksEl.appendChild(a);
    }
  });

  document.getElementById('modal-overlay').classList.add('active');
  highlightNode(nodeId);
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close')) return;
  document.getElementById('modal-overlay').classList.remove('active');
  unhighlightAll();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ====================================================
// COMMAND INPUT
// ====================================================
function handleCmd(e) {
  if (e.key !== 'Enter') return;
  const input = document.getElementById('cmd-input');
  const cmd = input.value.trim().toLowerCase();
  input.value = '';

  if (cmd === 'help') {
    showToast('Commandes : help | list | budget | fork | about | [nom de n≈ìud]');
    return;
  }
  if (cmd === 'list') {
    showToast(nodes.map(n => n.id).join(', '));
    return;
  }
  if (cmd === 'budget') {
    openModal('budget');
    return;
  }
  if (cmd === 'fork') {
    showToast('üç¥ Fork the system: github.com/ouaisfieu/ateliers-debat ‚Äî CC-BY-SA 4.0');
    return;
  }
  if (cmd === 'about') {
    showToast('ouaisfieu :: Intelligence citoyenne belge ¬∑ 29‚Ç¨/mois ¬∑ ~100 ateliers/an ¬∑ 0 tracking');
    return;
  }
  if (cmd === 'korben') {
    showToast('ü§ñ Salut Korben ! Oui c\'est du HTML pur avec D3.js, pas de React, pas de framework. Low-tech militant FTW.');
    return;
  }
  if (cmd === 'nsa') {
    showToast('üïµÔ∏è Nice try. Aucun cookie, aucun tracker, aucun analytics. RGPD by design. On vous voit venir.');
    return;
  }
  if (cmd === 'nasa') {
    showToast('üöÄ Houston, we have a citizen. Le dashboard de contr√¥le mission pour la d√©mocratie d√©lib√©rative.');
    return;
  }
  if (cmd === '42') {
    showToast('üåå La r√©ponse √† la d√©mocratie, l\'univers et le reste. Mais la question c\'√©tait quoi d√©j√† ?');
    return;
  }

  const found = nodes.find(n => n.id === cmd || n.label.replace(/\n/g, ' ').toLowerCase().includes(cmd));
  if (found) {
    openModal(found.id);
  } else {
    showToast(`‚ö† N≈ìud "${cmd}" non trouv√©. Tapez "list" ou "help".`);
  }
}

function showToast(msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}

// Initial toast
setTimeout(() => showToast('‚ö° Syst√®me initialis√© ‚Äî Cliquez un n≈ìud ou tapez "help"'), 1500);

// Center graph nicely after stabilization
setTimeout(() => {
  const bounds = g.node().getBBox();
  const fullWidth = container.clientWidth;
  const fullHeight = container.clientHeight;
  const midX = bounds.x + bounds.width / 2;
  const midY = bounds.y + bounds.height / 2;
  const scale = Math.min(fullWidth / (bounds.width + 100), fullHeight / (bounds.height + 100), 1.2);
  const tx = fullWidth / 2 - midX * scale;
  const ty = fullHeight / 2 - midY * scale;
  svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
}, 3000);
</script>
</body>
</html>
